var DiscountDisplayPro=(()=>{var ue=Object.defineProperty;var mt=Object.getOwnPropertyDescriptor;var ht=Object.getOwnPropertyNames;var gt=Object.prototype.hasOwnProperty;var yt=(e,t)=>{for(var r in t)ue(e,r,{get:t[r],enumerable:!0})},bt=(e,t,r,o)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of ht(t))!gt.call(e,i)&&i!==r&&ue(e,i,{get:()=>t[i],enumerable:!(o=mt(t,i))||o.enumerable});return e};var vt=e=>bt(ue({},"__esModule",{value:!0}),e);var rr={};yt(rr,{default:()=>tr});var l=window["display-discounts-pro"];var L={debug:0,info:1,warn:2,error:3},W={Forms:"Forms",Cards:"Cards",General:"General",PPBlock:"PPBlock"},wt={forms:"Forms",form:"Forms",cards:"Cards",card:"Cards",pp:"PPBlock",productpage:"PPBlock",general:"General"},de=class{constructor(){this.enabled=!0,this.minLevel=this._getInitialLevel(),this.allowedCategories=new Set(Object.values(W))}_getInitialLevel(){try{if(typeof window<"u"&&l&&l.logLevel){let t=l.logLevel.toLowerCase();if(L.hasOwnProperty(t))return L[t]}if(typeof localStorage<"u"){let t=localStorage.getItem("wf_discount_log_level");if(t&&L.hasOwnProperty(t.toLowerCase()))return L[t.toLowerCase()]}}catch{}return L.info}_normalizeCategory(t){if(!t)return W.General;let r=t.toLowerCase();return wt[r]||W[t]||W.General}_shouldLog(t,r){if(!this.enabled||L[t]<this.minLevel)return!1;let o=this._normalizeCategory(r);return this.allowedCategories.has(o)}log(t,r=null,o="info",i="General"){let a=this._normalizeCategory(i);if(this._shouldLog(o,a))try{let s=`[${a}][${o.toUpperCase()}]`,c=console[o]||console.log;r!=null?c.call(console,s,t,r):c.call(console,s,t)}catch{}}logError(t,r="",o="General"){let i=this._normalizeCategory(o);if(this._shouldLog("error",i))try{let a=`[${i}][ERROR]`;r?console.error(a,r,t):console.error(a,t)}catch{}}logWarning(t,r=null,o="General"){let i=this._normalizeCategory(o);if(this._shouldLog("warn",i))try{let a=`[${i}][WARN]`;r!=null?console.warn(a,t,r):console.warn(a,t)}catch{}}debug(t,r=null,o="General"){this.log(t,r,"debug",o)}info(t,r=null,o="General"){this.log(t,r,"info",o)}warn(t,r=null,o="General"){this.log(t,r,"warn",o)}error(t,r=null,o="General"){this.log(t,r,"error",o)}setMinLevel(t){let r=t.toLowerCase();if(L.hasOwnProperty(r)){this.minLevel=L[r];try{typeof localStorage<"u"&&localStorage.setItem("wf_discount_log_level",r)}catch{}}}setAllowedCategories(t){Array.isArray(t)&&(this.allowedCategories=new Set(t.map(r=>this._normalizeCategory(r))))}onlyForms(){return this.setAllowedCategories(["Forms"]),this}onlyCards(){return this.setAllowedCategories(["Cards"]),this}onlyPP(){return this.setAllowedCategories(["PPBlock"]),this}onlyGeneral(){return this.setAllowedCategories(["General"]),this}all(){return this.setAllowedCategories(Object.values(W)),this}},n=new de;typeof window<"u"&&(l.logger=n);function Z(e,t){if(!e)return!0;t||(t=document.body);try{let r=e;for(;r&&r!==t&&r!==document.body&&r!==document.documentElement;){if(r.style&&r.style.display==="none"||r.style&&r.style.visibility==="hidden")return!0;if(r.className){let o=typeof r.className=="string"?r.className:r.className.baseVal||"";if(o.includes("visually-hidden")||o.includes("sr-only")||o.includes("screen-reader"))return!0}r=r.parentElement}return!1}catch{return!1}}function St(e){try{let t=e.replace(/[^\d.,]/g,"");return/,\d{2}$/.test(t)?"european":/\.\d{2}$/.test(t)?"us":/\.\d{3}/.test(t)&&!/\.\d{2}$/.test(t)?"european":"us"}catch(t){return n.logError(t,"Error detecting money format","General"),"us"}}function T(e,t=!1){try{let r=e/100;if(typeof window<"u"&&window.Shopify&&window.Shopify.formatMoney)try{let i=t?l?.shopMoneyWithCurrencyFormat||l?.shopMoneyFormat||"{{amount}}":l?.shopMoneyFormat||"{{amount}}";return window.Shopify.formatMoney(e,i)}catch(i){n.logError(i,"Shopify.formatMoney failed","General")}let o=r.toFixed(2);if(typeof window<"u"&&l&&(l._currencyPrefix||l._currencySuffix)){let i=l._currencyPrefix||"",a=l._currencySuffix||"";return`${i}${o}${a}`}if(typeof window<"u")return`${l&&l.currencySymbol||l&&l.currencySymbols&&l.currencySymbols[window.Currency]||"$"}${o}`;try{if(typeof Intl<"u"&&Intl.NumberFormat){let i=typeof window<"u"&&window.Currency||"USD";return new Intl.NumberFormat("en-US",{style:"currency",currency:i,minimumFractionDigits:2,maximumFractionDigits:2}).format(r)}}catch(i){n.logError(i,"Intl.NumberFormat failed","General")}return`$${o}`}catch(r){return n.logError(r,"Error formatting price","General"),`$${(e/100).toFixed(2)}`}}function O(e){if(!e||typeof e!="string")return null;try{let t=e.trim().replace(/\bfrom\b/gi,"").replace(/\beach\b/gi,"").replace(/\bper item\b/gi,"").replace(/\bper\b/gi,"");t=t.replace(/\b[A-Z]{3}\b/g,"");let r=St(t),o;if(r==="european"){if(o=t.match(/[\d.]+,\d{2}/),o){let i=o[0].replace(/\./g,"").replace(",","."),a=parseFloat(i);if(!isNaN(a))return Math.round(a*100)}}else if(o=t.match(/[\d,]+\.\d{2}|[\d,]+/),o){let i=o[0].replace(/,/g,""),a=parseFloat(i);if(!isNaN(a))return Math.round(a*100)}if(o=t.match(/\d+\.?\d*/),o){let i=parseFloat(o[0]);if(!isNaN(i))return Math.round(i*100)}return null}catch(t){return n.logError(t,"Error parsing price","General"),null}}function K(e){if(!e||typeof e!="string")return!1;try{return/\b[A-Z]{3}\b/.test(e)}catch{return!1}}function Re(e){if(!e||typeof e!="string")return{prefix:"",suffix:""};try{let t=e.match(/[\d.,]+/);if(!t)return{prefix:"",suffix:""};let r=t[0],o=e.indexOf(r),i=e.substring(0,o).trim(),a=e.substring(o+r.length).trim();return typeof window<"u"&&(i&&(l._currencyPrefix=i),a&&(l._currencySuffix=a)),{prefix:i,suffix:a}}catch(t){return n.logError(t,"Error extracting currency format","General"),{prefix:"",suffix:""}}}function X(e,t){if(!t||!t.type)return e;try{let r=0;if(t.type==="percentage"){let o=t.value||0;r=Math.floor(e*o/100)}else t.type==="fixed"&&(r=Math.min(t.value||0,e));return Math.max(0,e-r)}catch(r){return n.logError(r,"Error calculating discounted price","General"),e}}function Me(e){try{return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})}catch(t){return n.logError(t,"Error formatting date","General"),e}}var R="dawn";function Be(e){if(!e||typeof e!="string")return R;let t=e.toLowerCase().trim(),r=t.indexOf(" - ");r!==-1&&(t=t.substring(0,r));let o=t.indexOf("(");o!==-1&&(t=t.substring(0,o));let i=t.indexOf("[");i!==-1&&(t=t.substring(0,i)),t=t.trim();let a=["preview","live","published","unpublished","development","dev","draft","staging","test","copy","duplicate","backup"];for(let s of a){let c=new RegExp(`\\s+${s}$`,"i");t=t.replace(c,"")}return t=t.replace(/\s+copy\s*\d*$/i,""),t=t.replace(/\s+v?\d+(\.\d+)*$/i,""),t=t.trim(),t||R}function Et(e){if(!e)return null;let r=String(e).match(/\d+/g);return!r||r.length===0?null:r[r.length-1]}function Ct(e){return!e||typeof e!="string"?null:e.toLowerCase().trim()||null}function It(e){if(!e)return null;let t=Number(e);return isNaN(t)?null:String(Math.trunc(t))}function Pt(e){return!e||typeof e!="string"?(n.error({url:e},"Invalid base URL"),""):e.replace(/\/$/,"")}function Tt(e,t,r,o){let i=Pt(l.apiBaseUrl||"");if(!i)return n.error({},"DISCOUNT_API_BASE_URL not configured"),null;let a=`${i}/api/theme-selectors`,s=new URLSearchParams;return e&&s.append("theme",e),t&&s.append("themeId",t),r&&s.append("schemaName",r),o&&s.append("themeStoreId",o),`${a}?${s.toString()}`}l._themeState||(l._themeState={selectors:null,fallbackSelectors:null,resolvedTheme:null,usedFallback:!1,isReady:!1,listeners:[],cache:new Map});function _t(e){if(!e)return;let t=l._themeState;l.themeSelectors||(l.themeSelectors={}),e.theme&&e.selectors&&(l.themeSelectors[e.theme]=e.selectors,t.resolvedTheme=e.theme,t.selectors=e.selectors),e.fallbackSelectors&&(t.fallbackSelectors=e.fallbackSelectors),t.usedFallback=e.usedFallback||!1,t.isReady=!0,n.info({theme:e.theme,usedFallback:t.usedFallback,selectorCount:Object.keys(e.selectors||{}).length},"Theme selectors applied")}function Ue(e){return n.error({err:e},"Failed to fetch theme selectors"),{usedFallback:!0,selectors:null}}function fe(){let e=l._themeState;[...e.listeners].forEach(r=>{try{r({isReady:e.isReady,resolvedTheme:e.resolvedTheme,usedFallback:e.usedFallback})}catch(o){n.error({err:o},"Error in theme selector listener")}})}async function pe(e,t,r,o){let i=l._themeState,a=Be(e),s=Et(t),c=Ct(r),u=It(o),d=s||a;if(i.cache.has(d))return n.info({cacheKey:d},"Returning cached theme selectors promise"),i.cache.get(d);let f=(async()=>{try{let p=Tt(a,s,c,u);if(!p){let h=Ue(new Error("Could not build theme selectors URL"));return fe(),h}n.info({theme:a,themeId:s,schemaName:c,storeId:u},"Fetching theme selectors");let m=await fetch(p,{method:"GET",credentials:"omit",headers:{Accept:"application/json"}});if(!m.ok)throw new Error(`HTTP ${m.status}: ${m.statusText}`);let v=await m.json();return _t(v),fe(),v}catch(p){let m=Ue(p);return fe(),m}})();return i.cache.set(d,f),f}function ze(e,t,r){let o=Be(e),i=l._themeState;if(l.themeSelectors&&l.themeSelectors[o]){let a=l.themeSelectors[o][t];if(a!=null)return{value:a,source:`theme:${o}`}}if(i.selectors&&i.selectors[t]!==void 0&&i.selectors[t]!==null)return{value:i.selectors[t],source:"state"};if(i.fallbackSelectors&&i.fallbackSelectors[t]!==void 0&&i.fallbackSelectors[t]!==null)return{value:i.fallbackSelectors[t],source:"fallback-backend"};if(l.themeSelectors&&l.themeSelectors[R]){let a=l.themeSelectors[R][t];if(a!=null)return{value:a,source:`theme:${R}`}}return{value:r,source:"fallback"}}function $e(e=4e3){let t=l._themeState;return t.isReady?Promise.resolve(!0):new Promise(r=>{let o=setTimeout(()=>{n.warn({timeoutMs:e},"Theme selectors ready timeout"),r(!1)},e),i=me(a=>{a.isReady&&(clearTimeout(o),r(!0))});l._themePromise&&l._themePromise.then(()=>{t.isReady&&(clearTimeout(o),r(!0))}).catch(a=>{n.error({err:a},"Theme selectors promise rejected")})})}function me(e){if(typeof e!="function")return n.error({},"subscribeToThemeSelectorUpdates: callback must be a function"),()=>{};let t=l._themeState;return t.listeners.push(e),()=>{let r=t.listeners.indexOf(e);r>-1&&t.listeners.splice(r,1)}}function qe(){try{let e=window.Shopify?.theme;if(!e){n.warn({},"Shopify.theme not available, using default theme"),l._themePromise=pe(R,null,null,null);return}let t=e.name||R,r=e.id||null,o=e.schema_name||null,i=e.theme_store_id||null;n.info({themeName:t,themeId:r,schemaName:o,storeId:i},"Auto-detected theme"),l._themePromise=pe(t,r,o,i)}catch(e){n.error({err:e},"Error in auto-detect theme"),l._themePromise=pe(R,null,null,null)}}typeof window<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",qe):qe());function J(){if(l._shopDomain)return l._shopDomain;if(window.Shopify?.shop)return l._shopDomain=window.Shopify.shop,l._shopDomain;try{let e=window.location.hostname;return e.endsWith(".myshopify.com")?(l._shopDomain=e,l._shopDomain):(n.warn({hostname:e},"Could not resolve shop domain from hostname"),null)}catch(e){return n.error({err:e},"Error resolving shop domain"),null}}function Ge(e){return!e||typeof e!="string"?(n.error({url:e},"Invalid base URL"),""):e.replace(/\/$/,"")}function Ve(e){let t=Ge(l.apiBaseUrl||"");if(!t)return n.error({},"DISCOUNT_API_BASE_URL not configured"),null;let r=`${t}/api/discounts`,o=new URLSearchParams;return Object.keys(e).forEach(i=>{let a=e[i];a!=null&&a!==""&&(Array.isArray(a)?o.append(i,a.join(",")):o.append(i,String(a)))}),`${r}?${o.toString()}`}function xt(){let e=Ge(l.apiBaseUrl||"");return e?`${e}/api/best-discounts`:(n.error({},"DISCOUNT_API_BASE_URL not configured"),null)}function At(e){let t=[],r=[],o=[];return e?(e.productId&&t.push(e.productId),e.variantId&&r.push(e.variantId),e.handle&&o.push(e.handle),e.productIds&&Array.isArray(e.productIds)&&t.push(...e.productIds),e.variantIds&&Array.isArray(e.variantIds)&&r.push(...e.variantIds),e.handles&&Array.isArray(e.handles)&&o.push(...e.handles),{productIds:[...new Set(t)],variantIds:[...new Set(r)],handles:[...new Set(o)]}):{productIds:t,variantIds:r,handles:o}}async function je(e){try{if(l._fetchPromise)return n.info({},"Reusing existing discounts fetch promise"),await l._fetchPromise;if(l._fetchCache)return n.info({},"Returning cached discount data"),l._fetchCache;let t=J();if(!t)return n.error({},"Cannot load discounts: shop domain not resolved"),null;let r=l.storefrontToken;if(!r)return n.error({},"Cannot load discounts: DISCOUNT_STOREFRONT_TOKEN not configured"),null;let{productIds:o,variantIds:i,handles:a}=At(e),s=Ve({shop:t,productIds:o.length>0?o:void 0,variantIds:i.length>0?i:void 0,handles:a.length>0?a:void 0});if(!s)return null;n.info({shop:t,productCount:o.length,variantCount:i.length,handleCount:a.length},"Fetching discount data");let c=(async()=>{try{let u=await fetch(s,{method:"GET",credentials:"omit",headers:{Accept:"application/json",Authorization:`Bearer ${r}`}});if(!u.ok)throw new Error(`HTTP ${u.status}: ${u.statusText}`);let d=await u.json();return n.info({discountCount:d.discounts?.length||0,productCount:d.products?.length||0},"Discount data loaded"),l._fetchCache=d,d}catch(u){return n.error({err:u},"Failed to load discount data"),null}finally{l._fetchPromise=null}})();return l._fetchPromise=c,await c}catch(t){return n.error({err:t},"Error in loadDiscountData"),null}}async function He({productIds:e=[],handles:t=[],variantIds:r=[]}){try{let o=J();if(!o)return n.error({},"Cannot fetch additional discounts: shop domain not resolved"),{success:!1,hasData:!1};let i=l.storefrontToken;if(!i)return n.error({},"Cannot fetch additional discounts: DISCOUNT_STOREFRONT_TOKEN not configured"),{success:!1,hasData:!1};if(e.length===0&&t.length===0&&r.length===0)return n.warn({},"No IDs provided for additional discount fetch"),{success:!0,hasData:!1};let a=Ve({shop:o,productIds:e.length>0?e:void 0,variantIds:r.length>0?r:void 0,handles:t.length>0?t:void 0});if(!a)return{success:!1,hasData:!1};n.info({shop:o,productCount:e.length,variantCount:r.length,handleCount:t.length},"Fetching additional discount data");let s=await fetch(a,{method:"GET",credentials:"omit",headers:{Accept:"application/json",Authorization:`Bearer ${i}`}});if(!s.ok)throw new Error(`HTTP ${s.status}: ${s.statusText}`);let c=await s.json();if(n.info({discountCount:c.discounts?.length||0,productCount:c.products?.length||0},"Additional discount data loaded"),l._fetchCache){let u=l._fetchCache,d=new Set((u.discounts||[]).map(v=>v.id)),f=(c.discounts||[]).filter(v=>!d.has(v.id)),p=new Set((u.products||[]).map(v=>v.id)),m=(c.products||[]).filter(v=>!p.has(v.id));l._fetchCache={...u,discounts:[...u.discounts||[],...f],products:[...u.products||[],...m]},n.info({newDiscounts:f.length,newProducts:m.length},"Merged additional discount data with cache")}else l._fetchCache=c;return{success:!0,hasData:(c.discounts?.length||0)>0||(c.products?.length||0)>0,data:c}}catch(o){return n.error({err:o},"Failed to fetch additional discount data"),{success:!1,hasData:!1,data:null}}}async function he({shop:e,entries:t}){try{if(!e&&(e=J(),!e))return n.error({},"Cannot request best discounts: shop domain not resolved"),{results:[],errors:["Shop domain not resolved"]};if(!Array.isArray(t)||t.length===0)return n.warn({},"No entries provided for best discounts request"),{results:[],errors:[]};let r=l.storefrontToken;if(!r)return n.error({},"Cannot request best discounts: DISCOUNT_STOREFRONT_TOKEN not configured"),{results:[],errors:["Storefront token not configured"]};let o=xt();if(!o)return{results:[],errors:["Could not build API URL"]};n.info({shop:e,entryCount:t.length},"Requesting best discounts");let i=await fetch(o,{method:"POST",credentials:"omit",headers:{"Content-Type":"application/json",Accept:"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({shop:e,requests:t})});if(!i.ok)throw new Error(`HTTP ${i.status}: ${i.statusText}`);let a=await i.json();return n.info({resultCount:a.results?.length||0,errorCount:a.errors?.length||0},"Best discounts response received"),{results:a.results||[],errors:a.errors||[]}}catch(r){return n.error({err:r},"Failed to request best discounts"),{results:[],errors:[r.message||"Unknown error"]}}}function Ke(e,t={}){let{formPriceDiscountedSelector:r="",isForm:o=!1}=t;try{if(o)try{let a=e.querySelector("script[data-selected-variant]");if(a){let s=JSON.parse(a.textContent),c=s.price||s.final_price;if(typeof c=="number"&&c>0)return n.log("Price from variant JSON",{price:c},"debug","Forms"),{price:c,hasCurrencyCode:!1}}}catch(a){n.log("Failed to parse variant JSON",{error:a.message},"debug","Forms")}if(o&&r){let a=Dt(e,r);if(a)return n.log("Price from discounted form selector",{price:a.price},"debug","Forms"),a}let i=Ft(e);if(i){let a=Re(i),s=O(i);if(typeof s=="number"&&s>0)return n.log("Price from DOM text walking",{price:s,priceText:a},"debug","PriceExtractor"),{price:s,hasCurrencyCode:K(i)}}return n.log("No price found",{},"debug","PriceExtractor"),null}catch(i){return n.log("Error in parsePriceFromDOM",{error:i.message},"error","PriceExtractor"),null}}function Dt(e,t){try{let r=e.querySelectorAll(t);for(let o of r){if(Z(o,e)){n.log("Skipping hidden discounted price element",{selector:t},"debug","Forms");continue}let i=o.textContent.trim();if(i){let a=O(i);if(typeof a=="number"&&a>0)return{price:a,hasCurrencyCode:K(i)}}}return null}catch(r){return n.log("Error in getDiscountedFormPrice",{error:r.message,selector:t},"error","Forms"),null}}function Ft(e){try{let t=e.querySelectorAll("*"),r=[];for(let i of t)if(!We(i,e)){for(let a of i.childNodes)if(a.nodeType===3){let s=a.textContent.trim();s&&/\d/.test(s)&&r.push(s)}}if(r.length>0)return n.log("Found price from TEXT_NODE",{text:r[0]},"debug","PriceExtractor"),r[0];for(let i of t)if(!We(i,e)&&i.children.length===0){let a=i.textContent.trim();if(a&&/\d/.test(a))return n.log("Found price from leaf element",{text:a},"debug","PriceExtractor"),a}let o=e.textContent.trim();return o&&/\d/.test(o)?(n.log("Using fallback container text",{text:o},"debug","PriceExtractor"),o):""}catch(t){return n.log("Error in getCleanPriceText",{error:t.message},"error","PriceExtractor"),""}}function We(e,t){try{let r=e;for(;r&&r!==t;){if(r.classList&&(r.classList.contains("visually-hidden")||r.classList.contains("sr-only")||r.classList.contains("screen-reader"))||r.hasAttribute("hidden")||r.getAttribute("aria-hidden")==="true"||r.style.display==="none"||r.style.visibility==="hidden")return!0;r=r.parentElement}return!1}catch(r){return n.log("Error in isElementHiddenInline",{error:r.message},"error","PriceExtractor"),!1}}function Xe(e,t,r=""){try{let o=[];if(t&&(o=Array.from(e.querySelectorAll(t))),o.length===0&&r!=="custom"){let a=[".product-price .js-value",".product-price",".price__current .js-value",".price__current",".price .js-value",".price"];for(let s of a)if(o=Array.from(e.querySelectorAll(s)),o.length>0){n.log("Using fallback selector",{fallbackSelector:s},"debug","PriceExtractor");break}}let i=o.filter(a=>!Nt(a));return n.log("Found price elements",{total:o.length,visible:i.length,selector:t},"debug","PriceExtractor"),i.map(a=>({container:a}))}catch(o){return n.log("Error in findPriceElements",{error:o.message,selector:t},"error","PriceExtractor"),[]}}function Nt(e){try{let t=e;for(;t&&t!==document.body;){let r=window.getComputedStyle(t);if(r.display==="none"||r.visibility==="hidden"||r.opacity==="0")return!0;t=t.parentElement}return!1}catch(t){return n.log("Error in isElementOrAncestorHidden",{error:t.message},"error","PriceExtractor"),!1}}var ge=!1,Je=!1;function ye(e,t,r){let{productId:o,regularPrice:i,finalPrice:a,discount:s,hasCurrencyCode:c,singlePrice:u}=r,d=[];try{n.debug({productId:o,discountId:s.id},"Creating automatic discount display"),t.forEach((f,p)=>{try{let m=f.container.querySelector(".discounted-price-container"),v=f.container.querySelector(".automatic-wrapper");if(m||v){n.debug({productId:o,index:p},"Discount elements already exist, skipping");return}let h=s.variantScope&&s.variantScope.type==="ALL",b=s.variantScope&&s.variantScope.type==="PARTIAL",g=document.createElement("div");if(g.className="discounted-price-container",h){if(f.container.style.display="none",!u){let U=document.createElement("span");U.className="discount-from-prefix",U.textContent="From ",g.appendChild(U)}let C=document.createElement("span");C.className="discounted-price__regular",C.textContent=T(i,c),g.appendChild(C);let x=document.createElement("span");x.className="discounted-price__sale",x.textContent=T(a,c),g.appendChild(x)}let y=document.createElement("span");y.className="discounted-price__badge";let E=l.automaticBadgeText||"Save {amount}",I=Ze(s,c);y.textContent=E.replace("{amount}",I);let S=document.createElement("div");S.className="automatic-wrapper";let D=l.badgeAlignment||"left",w={left:"flex-start",center:"center",right:"flex-end"};if(S.style.display="flex",S.style.justifyContent=w[D]||"flex-start",S.style.alignItems="center",S.style.gap="8px",S.style.marginTop="4px",h&&S.appendChild(g),S.appendChild(y),b){let C=document.createElement("span");C.className="discount-selected-items-text",C.textContent="in selected items",C.style.fontSize="0.875em",C.style.color="#666",S.appendChild(C)}f.container.parentNode.insertBefore(S,f.container.nextSibling),d.push(S),n.debug({productId:o,index:p},"Automatic discount display created")}catch(m){n.error({err:m,productId:o,index:p},"Failed to create discount display for price element")}}),Qe(),Ye(),n.info({productId:o,count:d.length},"Automatic discount displays created")}catch(f){n.error({err:f,productId:o},"Failed to create automatic discount display")}return d}function be(e,t,r){let{productId:o,discount:i,hasCurrencyCode:a}=r,s=[];try{n.debug({productId:o,discountId:i.id},"Creating coupon badge"),t.forEach((c,u)=>{try{let d=c.container.querySelector(".coupon-badge"),f=c.container.querySelector(".coupon-wrapper");if(d||f){n.debug({productId:o,index:u},"Coupon badge already exists, skipping");return}let p=i.variantScope&&i.variantScope.type==="PARTIAL",m=document.createElement("div");m.className="coupon-badge";let v=l.couponBadgeText||"Save {amount} with coupon",h=Ze(i,a);m.textContent=v.replace("{amount}",h);let b=document.createElement("div");b.className="coupon-wrapper";let g=l.badgeAlignment||"left",y={left:"flex-start",center:"center",right:"flex-end"};if(b.style.display="flex",b.style.justifyContent=y[g]||"flex-start",b.style.alignItems="center",b.style.gap="8px",b.style.marginTop="4px",b.appendChild(m),p){let E=document.createElement("span");E.className="discount-selected-items-text",E.textContent="in selected items",E.style.fontSize="0.875em",E.style.color="#666",b.appendChild(E)}c.container.parentNode.insertBefore(b,c.container.nextSibling),s.push(b),n.debug({productId:o,index:u},"Coupon badge created")}catch(d){n.error({err:d,productId:o,index:u},"Failed to create coupon badge for price element")}}),Qe(),Ye(),n.info({productId:o,count:s.length},"Coupon badges created")}catch(c){n.error({err:c,productId:o},"Failed to create coupon badge")}return s}function Qe(){ge||(ge=!0,requestAnimationFrame(()=>{try{window.dispatchEvent(new Event("resize")),n.debug({},"Layout nudge triggered")}catch(e){n.error({err:e},"Failed to trigger layout nudge")}finally{ge=!1}}))}function Ye(){if(Je)return;Je=!0;let e=()=>{try{setTimeout(()=>{window.dispatchEvent(new Event("resize")),n.debug({},"Post-load nudge (50ms) triggered")},50),setTimeout(()=>{window.dispatchEvent(new Event("resize")),n.debug({},"Post-load nudge (250ms) triggered")},250)}catch(t){n.error({err:t},"Failed to trigger post-load nudges")}};document.readyState==="complete"?e():window.addEventListener("load",e,{once:!0})}function Ze(e,t){try{return e.type==="percentage"?`${e.value}%`:e.type==="fixed_amount"?T(e.value,t):(n.warn({discountType:e.type},"Unknown discount type"),T(e.value,t))}catch(r){return n.error({err:r,discount:e},"Failed to format discount amount"),"$0.00"}}function kt(e){try{let t=encodeURIComponent(e),r=window.location.pathname+window.location.search,o=encodeURIComponent(r),i=`/discount/${t}?return_to=${o}`;return n.debug({discountCode:e,discountUrl:i},"Built discount URL"),i}catch(t){return n.error({err:t,discountCode:e},"Failed to build discount URL"),`/discount/${encodeURIComponent(e)}`}}async function B(e,t={}){let{silent:r=!0}=t;try{let o=`wf_coupon_applied_${e}`;sessionStorage.setItem(o,"1"),n.info({discountCode:e,silent:r},"Applying discount code");let i=kt(e);if(typeof Shopify<"u"&&Shopify.designMode){n.debug({discountCode:e},"In theme editor, skipping network requests");return}if(!r){n.info({discountCode:e,discountUrl:i},"Non-silent mode, navigating directly"),window.location.href=i;return}try{n.debug({discountCode:e},"Attempting Strategy 1: fetch()");let a=new AbortController,s=setTimeout(()=>a.abort(),2500),c=await fetch(i,{method:"GET",credentials:"include",mode:"cors",redirect:"follow",signal:a.signal});if(clearTimeout(s),c.ok||c.status>=200&&c.status<400){n.info({discountCode:e,status:c.status},"Strategy 1 succeeded");return}n.warn({discountCode:e,status:c.status},"Strategy 1 failed, trying Strategy 2")}catch(a){n.warn({err:a,discountCode:e},"Strategy 1 failed, trying Strategy 2")}try{n.debug({discountCode:e},"Attempting Strategy 2: iframe"),await Lt(i,e),n.info({discountCode:e},"Strategy 2 succeeded");return}catch(a){n.warn({err:a,discountCode:e},"Strategy 2 failed, trying Strategy 3")}n.info({discountCode:e,discountUrl:i},"Strategy 3: direct navigation"),window.location.href=i}catch(o){throw n.error({err:o,discountCode:e},"Failed to apply discount code"),o}}function Lt(e,t){return new Promise((r,o)=>{let i=null,a=null,s=!1,c=()=>{a&&clearTimeout(a),i&&i.parentNode&&setTimeout(()=>{try{i&&i.parentNode&&i.parentNode.removeChild(i)}catch(d){n.warn({err:d,discountCode:t},"Failed to remove iframe")}},250)},u=(d,f=null)=>{s||(s=!0,c(),d?r():o(f||new Error("Iframe strategy failed")))};try{i=document.createElement("iframe"),i.style.display="none",i.style.position="absolute",i.style.width="0",i.style.height="0",i.style.border="none",i.setAttribute("aria-hidden","true"),i.src=e,i.onload=()=>{n.debug({discountCode:t},"Iframe loaded"),u(!0)},i.onerror=d=>{n.warn({err:d,discountCode:t},"Iframe error"),u(!1,d)},a=setTimeout(()=>{n.warn({discountCode:t},"Iframe timeout"),u(!1,new Error("Iframe timeout"))},3500),document.body.appendChild(i)}catch(d){n.error({err:d,discountCode:t},"Failed to create iframe"),u(!1,d)}})}function ee(){l._couponState||(l._couponState={},n.debug("Initialized coupon state tracker"))}function et(e){try{ee();let t=l._couponState[e];return t&&typeof t=="object"?t:{applied:t===!0}}catch(t){return n.error({err:t,code:e},"Failed to get coupon state"),{applied:!1}}}function te(e,t){try{ee(),typeof t=="object"?l._couponState[e]=t:l._couponState[e]={applied:!!t},n.debug({code:e,state:l._couponState[e]},"Set coupon state")}catch(r){n.error({err:r,code:e},"Failed to set coupon state")}}var tt={"check-mark-flower-filled.svg":"M23.334 11.96c-.713-.726-.872-1.829-.393-2.727.342-.64.366-1.401.064-2.062-.301-.66-.893-1.142-1.601-1.302-.991-.225-1.722-1.067-1.803-2.081-.059-.723-.451-1.378-1.062-1.77-.609-.393-1.367-.478-2.05-.229-.956.347-2.026.032-2.642-.776-.44-.576-1.124-.915-1.85-.915-.725 0-1.409.339-1.849.915-.613.809-1.683 1.124-2.639.777-.682-.248-1.44-.163-2.05.229-.61.392-1.003 1.047-1.061 1.77-.082 1.014-.812 1.857-1.803 2.081-.708.16-1.3.642-1.601 1.302s-.277 1.422.065 2.061c.479.897.32 2.001-.392 2.727-.509.517-.747 1.242-.644 1.96s.536 1.347 1.17 1.7c.888.495 1.352 1.51 1.144 2.505-.147.71.044 1.448.519 1.996.476.549 1.18.844 1.902.798 1.016-.063 1.953.54 2.317 1.489.259.678.82 1.195 1.517 1.399.695.204 1.447.072 2.031-.357.819-.603 1.936-.603 2.754 0 .584.43 1.336.562 2.031.357.697-.204 1.258-.722 1.518-1.399.363-.949 1.301-1.553 2.316-1.489.724.046 1.427-.249 1.902-.798.475-.548.667-1.286.519-1.996-.207-.995.256-2.01 1.145-2.505.633-.354 1.065-.982 1.169-1.7s-.135-1.443-.643-1.96zm-12.584 5.43l-4.5-4.364 1.857-1.857 2.643 2.506 5.643-5.784 1.857 1.857-7.5 7.642z","check-mark-circle-filled.svg":"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z","check-mark-square-filled.svg":"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z","check-mark.svg":"M20.285 2l-11.285 11.567-5.286-5.011-3.714 3.716 9 8.728 15-15.285z"};function ve(e,t,r,o,i){try{n.debug({regularPrice:e,finalPrice:t,isAutomatic:o},"Creating price container");let a=document.createElement("div");a.className="ddp-discounted-price-container";let s=document.createElement("span");s.className="ddp-discounted-price__regular",s.textContent=T(e,i),a.appendChild(s);let c=document.createElement("span");if(c.className="ddp-discounted-price__sale",c.textContent=T(t,i),a.appendChild(c),o&&r){let d=document.createElement("span");d.className="ddp-discounted-price__badge";let f=l.automaticBadgeText||"Save {amount}",p=Se(r,i);d.textContent=f.replace("{amount}",p),a.appendChild(d)}if((l.settings||{}).showTermsLink&&r){let d=document.createElement("button");d.className="ddp-terms-link",d.type="button",d.textContent="Terms",d.setAttribute("aria-label","View discount terms and conditions"),d.addEventListener("click",f=>{f.preventDefault(),re(r)}),a.appendChild(d)}return n.debug({},"Price container created"),a}catch(a){n.error({err:a},"Failed to create price container");let s=document.createElement("div");return s.textContent=T(t,i),s}}function we(e,t,r,o,i,a){try{n.debug({discountId:e.id,productId:o,variantId:i,isAutoApplied:a},"Creating coupon block");let s=l.settings||{},c=window.Shopify&&window.Shopify.designMode,u=document.createElement("div");u.className="ddp-coupon-block",u.dataset.discountId=e.id,u.dataset.code=e.code;let d=document.createElement("div");d.className="ddp-coupon-main-content";let f=document.createElement("div");f.className="ddp-coupon-flag",f.textContent="Coupon:",d.appendChild(f);let p=document.createElement("div");p.className="ddp-coupon-label-wrapper";let m=document.createElement("input");m.type="checkbox",m.id=`ddp-coupon-${e.id}`,m.className="ddp-coupon-checkbox";let h=et(e.code).applied||a||c&&l.showAppliedPreview;h&&(m.checked=!0),a&&(m.disabled=!0,m.title="This coupon is automatically applied");let b=document.createElement("label");b.htmlFor=m.id,b.className="ddp-coupon-label";let g=s.couponLabelText||"Apply code {code} to save {amount}",y=Se(e,!0),E=g.replace("{code}",e.code).replace("{amount}",y);b.textContent=E,p.appendChild(m),p.appendChild(b),d.appendChild(p);let I=document.createElement("div");I.className="ddp-coupon-applied",h&&(I.classList.add("visible"),p.style.display="none");let S=s.appliedIconFile||"check-mark-circle-filled.svg",D=tt[S]||tt["check-mark-circle-filled.svg"],w=document.createElementNS("http://www.w3.org/2000/svg","svg");w.setAttribute("width","24"),w.setAttribute("height","24"),w.setAttribute("viewBox","0 0 24 24"),w.setAttribute("fill","currentColor"),w.setAttribute("aria-hidden","true");let C=document.createElementNS("http://www.w3.org/2000/svg","path");C.setAttribute("d",D),w.appendChild(C),I.appendChild(w);let x=document.createElement("span");x.textContent=s.appliedText||"Coupon applied",I.appendChild(x),d.appendChild(I),u.appendChild(d);let U=document.createElement("div");if(U.className="ddp-coupon-toolbar",s.showTermsLink){let _=document.createElement("button");_.className="ddp-terms-link",_.type="button",_.textContent="Terms",_.setAttribute("aria-label","View coupon terms and conditions"),_.addEventListener("click",q=>{q.preventDefault(),re(e)}),U.appendChild(_)}if(u.appendChild(U),m.addEventListener("change",async _=>{try{if(_.target.checked){n.info({code:e.code,productId:o,variantId:i},"Applying coupon"),p.style.display="none",I.classList.add("visible"),te(e.code,{applied:!0,timestamp:Date.now()}),typeof t=="function"&&await t(e.code);try{await B(e.code)}catch(q){n.error({err:q,code:e.code},"Failed to apply discount code"),_.target.checked=!1,p.style.display="",I.classList.remove("visible"),te(e.code,{applied:!1})}}else{n.info({code:e.code,productId:o,variantId:i},"Removing coupon"),p.style.display="",I.classList.remove("visible"),te(e.code,{applied:!1}),typeof r=="function"&&await r(e.code);try{await B("")}catch(q){n.error({err:q,code:e.code},"Failed to remove discount code")}}}catch(q){n.error({err:q,code:e.code},"Error handling coupon checkbox change")}}),a)try{sessionStorage.setItem(`wf_auto_applied_${e.code}`,"true")}catch(_){n.warn({err:_},"Failed to set auto-applied flag in sessionStorage")}return n.debug({discountId:e.id},"Coupon block created"),u}catch(s){n.error({err:s,discountId:e?.id},"Failed to create coupon block");let c=document.createElement("div");return c.className="ddp-coupon-block-error",c.textContent="Coupon temporarily unavailable",c}}function re(e){try{n.debug({discountId:e.id},"Showing terms modal");let t=l.settings||{},r=document.createElement("div");r.className="ddp-terms-modal-overlay",r.setAttribute("role","dialog"),r.setAttribute("aria-modal","true"),r.setAttribute("aria-labelledby","ddp-terms-modal-title");let o=document.createElement("div");o.className="ddp-terms-modal-content";let i=document.createElement("div");i.className="ddp-terms-modal-header";let a=document.createElement("h2");a.id="ddp-terms-modal-title",a.textContent="Discount Information",i.appendChild(a);let s=document.createElement("button");s.className="ddp-terms-modal-close",s.type="button",s.textContent="\xD7",s.setAttribute("aria-label","Close modal"),i.appendChild(s),o.appendChild(i);let c=document.createElement("div");c.className="ddp-terms-modal-body";let u=document.createElement("div");u.className="ddp-terms-section";let d=document.createElement("h3");d.textContent="Details",u.appendChild(d);let f=document.createElement("p"),p=document.createElement("strong");p.textContent="Type: ",f.appendChild(p);let m=document.createTextNode(e.type==="percentage"?"Percentage":"Fixed Amount");f.appendChild(m),u.appendChild(f);let v=document.createElement("p"),h=document.createElement("strong");h.textContent="Value: ",v.appendChild(h);let b=Se(e,!0),g=document.createTextNode(b);if(v.appendChild(g),u.appendChild(v),e.endsAt){let w=document.createElement("p"),C=document.createElement("strong");C.textContent="Expires: ",w.appendChild(C);let x=document.createTextNode(Me(e.endsAt));w.appendChild(x),u.appendChild(w)}if(e.appliesOncePerCustomer!==void 0){let w=document.createElement("p"),C=document.createElement("strong");C.textContent="Usage: ",w.appendChild(C);let x=document.createTextNode(e.appliesOncePerCustomer?"One time per customer":"Multiple uses allowed");w.appendChild(x),u.appendChild(w)}c.appendChild(u);let y=document.createElement("div");y.className="ddp-terms-section";let E=document.createElement("h3");E.textContent="Terms & Conditions",y.appendChild(E),(t.discountTermsTemplate||"Please see store policies for complete terms.").split(`
`).filter(w=>w.trim()).forEach(w=>{let C=document.createElement("p");C.textContent=w.trim(),y.appendChild(C)}),c.appendChild(y),o.appendChild(c),r.appendChild(o);let D=()=>{try{r.remove(),document.body.style.overflow="",n.debug({},"Terms modal closed")}catch(w){n.error({err:w},"Failed to close terms modal")}};s.addEventListener("click",D),r.addEventListener("click",w=>{w.target===r&&D()}),document.addEventListener("keydown",w=>{w.key==="Escape"&&document.body.contains(r)&&D()},{once:!0}),document.body.style.overflow="hidden",document.body.appendChild(r),s.focus(),n.info({discountId:e.id},"Terms modal shown")}catch(t){n.error({err:t,discountId:e?.id},"Failed to show terms modal")}}function rt(){try{let e=document.createElement("div");e.className="ddp-skeleton-loader",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.setAttribute("aria-label","Loading discounts");let t=document.createElement("div");t.className="ddp-skeleton-line ddp-skeleton-line--price",t.style.height="28px",t.style.width="120px",e.appendChild(t);let r=document.createElement("div");r.className="ddp-skeleton-line ddp-skeleton-line--lg",r.style.width="85%",e.appendChild(r);let o=document.createElement("div");o.className="ddp-skeleton-line ddp-skeleton-line--md",o.style.width="65%",e.appendChild(o);let i=document.createElement("div");i.className="ddp-skeleton-line ddp-skeleton-line--sm",i.style.width="45%",e.appendChild(i);let a=document.createElement("span");return a.className="ddp-sr-only",a.textContent="Loading discounts ...",e.appendChild(a),n.debug({},"Skeleton loader created"),e}catch(e){n.error({err:e},"Failed to create skeleton loader");let t=document.createElement("div");return t.textContent="Loading...",t}}function Se(e,t){try{return e.type==="percentage"?`${e.value}%`:e.type==="fixed_amount"?T(e.value,t):(n.warn({discountType:e.type},"Unknown discount type"),T(e.value,t))}catch(r){return n.error({err:r,discount:e},"Failed to format discount amount"),"$0.00"}}function Ee(e,t){try{let r=e.querySelector(t);if(!r){let i=e.closest('[id^="shopify-section-"]');i&&(r=i.querySelector(t))}if(!r){let i=['input[name="id"]','select[name="id"]',"[data-variant-id]",".product-variant-id"];for(let a of i){if(r=e.querySelector(a),r)break;let s=e.closest('[id^="shopify-section-"]');if(s&&(r=s.querySelector(a),r))break}}if(!r)return n.warn({container:e.id||e.className},"No variant input found"),{variantId:null,inputElement:null};let o=null;return r.tagName==="INPUT"||r.tagName==="SELECT"?o=r.value:r.dataset.variantId&&(o=r.dataset.variantId),n.debug({variantId:o,selector:t},"Found variant info"),{variantId:o,inputElement:r}}catch(r){return n.error({err:r,container:e?.id},"Failed to get variant info"),{variantId:null,inputElement:null}}}function Ce(e){try{let t=['input[name="selling_plan"]','select[name="selling_plan"]',"[data-selling-plan-id]"],r=null;for(let i of t){if(r=e.querySelector(i),r)break;let a=e.closest('[id^="shopify-section-"]');if(a&&(r=a.querySelector(i),r))break}if(!r)return n.debug({container:e.id||e.className},"No selling plan input found"),{sellingPlanId:null,inputElement:null};let o=null;return r.tagName==="INPUT"||r.tagName==="SELECT"?o=r.value:r.dataset.sellingPlanId&&(o=r.dataset.sellingPlanId),o===""&&(o=null),n.debug({sellingPlanId:o},"Found selling plan info"),{sellingPlanId:o,inputElement:r}}catch(t){return n.error({err:t,container:e?.id},"Failed to get selling plan info"),{sellingPlanId:null,inputElement:null}}}function nt(e,t,r,o){try{n.info("Setting up variant detection");let i=new WeakSet,a=null,s=null,c=(g,y)=>{g&&g!==a&&(a=g,n.debug({variantId:g,source:y},"Variant changed"),r&&r(g))},u=(g,y)=>{g!==s&&(s=g,n.debug({sellingPlanId:g,source:y},"Selling plan changed"),o&&o(g))},d=()=>{try{e.querySelectorAll('form[action*="cart/add"], form[action*="/cart/add"]').forEach(y=>{if(i.has(y))return;i.add(y);let E=y.querySelector(t)||y.querySelector('input[name="id"]')||y.querySelector('select[name="id"]');E&&(E.addEventListener("change",S=>{c(S.target.value,"cart-form-change")}),E.addEventListener("input",S=>{c(S.target.value,"cart-form-input")}),n.debug("Attached cart form variant listener"));let I=y.querySelector('input[name="selling_plan"]')||y.querySelector('select[name="selling_plan"]');I&&(I.addEventListener("change",S=>{u(S.target.value||null,"cart-form-plan-change")}),I.addEventListener("input",S=>{u(S.target.value||null,"cart-form-plan-input")}),n.debug("Attached cart form selling plan listener"))})}catch(g){n.error({err:g},"Cart form detection failed")}},f=()=>{try{e.querySelectorAll(t).forEach(y=>{if(i.has(y))return;i.add(y),new MutationObserver(I=>{I.forEach(S=>{if(S.type==="attributes"&&S.attributeName==="value"){let D=y.value;c(D,"mutation-observer")}})}).observe(y,{attributes:!0,attributeFilter:["value"]}),n.debug("Attached mutation observer to variant input")})}catch(g){n.error({err:g},"Mutation observer setup failed")}},p=()=>{try{e.addEventListener("change",g=>{let y=g.target;y.matches('input[name="id"], select[name="id"]')&&c(y.value,"event-delegation-change"),y.matches('input[name="selling_plan"], select[name="selling_plan"]')&&u(y.value||null,"event-delegation-plan-change")},!0),e.addEventListener("input",g=>{let y=g.target;y.matches('input[name="id"]')&&c(y.value,"event-delegation-input"),y.matches('input[name="selling_plan"]')&&u(y.value||null,"event-delegation-plan-input")},!0),n.debug("Attached event delegation listeners")}catch(g){n.error({err:g},"Event delegation setup failed")}},m=()=>{try{["variant:change","variant:changed","product:variant:changed","option:change","variantChange","shopify:variant:change"].forEach(y=>{e.addEventListener(y,E=>{let I=E.detail?.variant?.id||E.detail?.variantId||E.detail?.id;I&&c(String(I),`custom-event-${y}`)})}),n.debug("Attached custom event listeners")}catch(g){n.error({err:g},"Custom events setup failed")}},v=()=>{try{let g=()=>{let E=new URLSearchParams(window.location.search).get("variant");E&&c(E,"url-parameter")};window.addEventListener("popstate",g),g(),n.debug("Attached URL monitoring")}catch(g){n.error({err:g},"URL monitoring setup failed")}};d(),f(),p(),m(),v();let h=Ee(e,t);h.variantId&&(a=h.variantId);let b=Ce(e);b.sellingPlanId!==void 0&&(s=b.sellingPlanId),n.info({initialVariantId:a,initialSellingPlanId:s},"Variant detection setup complete")}catch(i){n.error({err:i},"Failed to setup variant detection")}}var ne={DEFAULT:"any",ONE_TIME:"one_time",SUBSCRIPTION:"subscription"};function oe(e){try{return e&&e!==""&&e!=="0"?(n.debug({sellingPlanId:e},"Resolved context: subscription"),ne.SUBSCRIPTION):(n.debug({sellingPlanId:e},"Resolved context: one-time"),ne.ONE_TIME)}catch(t){return n.error({err:t,sellingPlanId:e},"Failed to resolve purchase context"),ne.ONE_TIME}}function Ot(e,t){try{if(!e)return n.warn("No discount provided to eligibility check"),!1;if(oe(t)===ne.SUBSCRIPTION){let i=e.appliesOnSubscription===!0;return n.debug({discountId:e.id,sellingPlanId:t,appliesOnSubscription:e.appliesOnSubscription,eligible:i},"Checked subscription eligibility"),i}let o=e.appliesOnOneTimePurchase!==!1;return n.debug({discountId:e.id,sellingPlanId:t,appliesOnOneTimePurchase:e.appliesOnOneTimePurchase,eligible:o},"Checked one-time eligibility"),o}catch(r){return n.error({err:r,discountId:e?.id,sellingPlanId:t},"Failed to check discount eligibility"),!0}}function ot(e,t){try{if(!Array.isArray(e))return n.warn({discounts:e},"Invalid discounts array provided"),[];let r=oe(t),o=e.filter(i=>Ot(i,t));return n.info({context:r,sellingPlanId:t,totalDiscounts:e.length,eligibleDiscounts:o.length},"Filtered discounts by purchase context"),o}catch(r){return n.error({err:r,sellingPlanId:t,discountCount:e?.length},"Failed to filter discounts by purchase context"),e||[]}}var G={},dt={},it=!1,ft=!1,P={productIds:new Set,handles:new Set,variantIds:new Set,containers:new Map},Ie=null,Pe=!1,Q=new Map,j=0,pt=!1,Rt=5,Mt=1e4,Ut=250,qt=5,at=250,Bt=750,zt=8e3,st=300,ct=new WeakMap,Te=new WeakMap,_e=new WeakSet,ae=new WeakMap,xe=new WeakMap,ie=new Map;var Ae="",z="",H="",A="",$="",De="",M={};function lt(){n.info("Initializing theme selectors");let e=l.selectorOverrides||{},t=e.themeSelectors_forceAutoDetection===!0,r="leave empty for theme auto detection";function o(i,a){let s=`themeSelectors_${i}_enable`,c=`themeSelectors_${i}_custom`,u=e[s]===!0,d=e[c];if(!t&&u&&d&&d.toLowerCase()!==r.toLowerCase())return n.info({key:i,customValue:d},"Using custom selector"),d;let p=l._themeState?.resolvedTheme||"dawn",m=ze(p,i,null);return m&&m.value?(n.info({key:i,detected:m.value,source:m.source},"Using detected selector"),m.value):(n.info({key:i,fallback:a},"Using default selector"),a)}Ae=o("cardPrice",".price__container"),z=o("cardContainer",".grid__item, product-card, .product-card"),H=o("variantInput",'input[ref="variantId"], input[name="id"], select[name="id"], [data-variant-id]'),A=o("formContainer",'form[action*="/cart/add"]'),$=o("formPrice",".price__container"),De=o("formPrice_discounted",".price__sale"),M.cardPrice=Ae,M.cardContainer=z,M.variantInput=H,M.formContainer=A,M.formPrice=$,M.formPrice_discounted=De,l._formPriceSelector=$,l._formSelector=A,n.info({selectors:M},"Selectors initialized")}function se(){if(!z)return n.warn("Product container selector not initialized"),[];try{let e=Array.from(document.querySelectorAll(z));return n.info({count:e.length},"Found product containers"),e}catch(e){return n.error({err:e,selector:z},"Error finding product containers"),[]}}function ce(){if(!A)return n.warn("Form container selector not initialized"),[];try{let e=Array.from(document.querySelectorAll(A));return n.info({count:e.length},"Found form containers"),e}catch(e){return n.error({err:e,selector:A},"Error finding form containers"),[]}}function V(e){if(!e)return!1;try{return!!(A&&e.matches(A)||e.querySelector('form[action*="/cart/add"]'))}catch(t){return n.error({err:t},"Error checking if form container"),!1}}function N(e){if(!e)return null;try{let t=e.querySelector(H);if(t){let c=t.value||t.getAttribute("data-variant-id")||t.getAttribute("ref");if(c){let u=dt[c];if(u)return n.debug({variantId:c,productId:u},"Found product ID via variant mapping"),u}}let r=e.getAttribute("data-product-id");if(r)return n.debug({productId:r},"Found product ID via container attribute"),r;let o=e.querySelector('input[name="product-id"], input[name="product_id"]');if(o?.value)return n.debug({productId:o.value},"Found product ID via product input"),o.value;let i=e.querySelector("[data-product-id]");if(i){let c=i.getAttribute("data-product-id");if(c)return n.debug({productId:c},"Found product ID via inner element"),c}let a=e.querySelector('a[href*="/products/"]');if(a){let u=a.getAttribute("href").match(/\/products\/([^?/#]+)/);if(u){let d=u[1];for(let[f,p]of Object.entries(G))if(p.handle===d)return n.debug({handle:d,productId:f},"Found product ID via handle match"),f;n.debug({handle:d},"Product handle found but not in cache"),Le(e,null,d)}}if(a){let c=a.getAttribute("id");if(c){let u=c.match(/(\d{10,})/);if(u){let d=u[1];if(G[d])return n.debug({productId:d},"Found product ID via link ID extraction"),d}}}let s=e.closest('[id*="shopify-section"]')?.id;if(s){let c=document.getElementById(s);if(c){let u=c.querySelector('input[name="product-id"], input[name="product_id"]');if(u?.value)return n.debug({productId:u.value,sectionId:s},"Found product ID via section scope"),u.value}}return n.debug("Could not find product ID for container"),null}catch(t){return n.error({err:t},"Error finding product ID"),null}}function ke(e){if(!e||!e.products){n.warn("Invalid discount data received");return}try{e.autoApplyEnabled!==void 0&&(pt=e.autoApplyEnabled);let t=e.products,r=0;for(let[o,i]of Object.entries(t))if(G[o]=i,r++,i.variants&&Array.isArray(i.variants))for(let a of i.variants)a.id&&(dt[a.id]=o);n.info({mergedCount:r,totalProducts:Object.keys(G).length},"Merged discount data")}catch(t){n.error({err:t},"Error merging discount data")}}function $t(){let e={productIds:new Set,variantIds:new Set,handles:new Set};try{let t=[...se(),...ce()];for(let o of t){let i=N(o);i&&e.productIds.add(i);let a=o.querySelector(H);if(a){let c=a.value||a.getAttribute("data-variant-id")||a.getAttribute("ref");c&&e.variantIds.add(c)}let s=o.querySelector('a[href*="/products/"]');if(s){let u=s.getAttribute("href").match(/\/products\/([^?/#]+)/);u&&e.handles.add(u[1])}}let r={productIds:Array.from(e.productIds),variantIds:Array.from(e.variantIds),handles:Array.from(e.handles)};return n.info(r,"Collected page product context"),r}catch(t){return n.error({err:t},"Error collecting page product context"),{productIds:[],variantIds:[],handles:[]}}}async function Gt(){try{n.info("Loading discount data from database");let e=$t(),t=await je(e);t&&ke(t)}catch(e){n.error({err:e},"Error loading products from database")}}function Le(e,t=null,r=null,o=[]){try{let i=t||r||o.join(",");if(Q.get(i)>=Rt){n.debug({key:i},"Max attempts reached for missing product");return}if(j>=qt){n.warn("Global fetch failure count exceeded, not queuing");return}t&&P.productIds.add(t),r&&P.handles.add(r),o.length>0&&o.forEach(s=>P.variantIds.add(s)),e&&P.containers.set(e,{productId:t,handle:r,variantIds:o}),n.debug({productId:t,handle:r,variantIds:o},"Queued missing product data"),Ie&&clearTimeout(Ie);let a=Math.min(Ut*Math.pow(2,j),Mt);Ie=setTimeout(()=>{Vt()},a)}catch(i){n.error({err:i},"Error queuing missing product data")}}async function Vt(){if(Pe){n.debug("Missing product fetch already in flight");return}if(P.productIds.size===0&&P.handles.size===0&&P.variantIds.size===0){n.debug("Missing product queue is empty");return}Pe=!0;try{let e=Array.from(P.productIds),t=Array.from(P.handles),r=Array.from(P.variantIds),o=new Map(P.containers);P.productIds.clear(),P.handles.clear(),P.variantIds.clear(),P.containers.clear(),n.info({productIds:e,handles:t,variantIds:r},"Flushing missing product queue"),e.forEach(a=>{let s=Q.get(a)||0;Q.set(a,s+1)}),t.forEach(a=>{let s=Q.get(a)||0;Q.set(a,s+1)});let i=await He({productIds:e,handles:t,variantIds:r});if(i.success&&i.data){ke(i.data),j=0;for(let[a,s]of o.entries()){if(!a.isConnected)continue;let c=s.productId||N(a);c&&G[c]&&(n.debug({productId:c},"Reapplying discounts after missing product fetch"),k(a,c))}}else{j++,n.warn({failureCount:j},"Missing product fetch failed");for(let[a,s]of o.entries())a.isConnected&&Le(a,s.productId,s.handle,s.variantIds)}}catch(e){n.error({err:e},"Error flushing missing product queue"),j++}finally{Pe=!1}}function le(e,t){if(!e||e.length===0)return{automaticDiscount:null,couponDiscount:null,automaticFinalPrice:null,couponFinalPrice:null};try{let r=typeof t=="number"?t:O(t),o=e.filter(d=>d.isAutomatic),i=e.filter(d=>!d.isAutomatic),a=null,s=1/0;for(let d of o){let f=X(r,d);f<s&&(s=f,a=d)}let c=null,u=1/0;for(let d of i){let f=X(r,d);f<u&&(u=f,c=d)}return a&&c&&s<=u&&(c=null,u=null),{automaticDiscount:a,couponDiscount:c,automaticFinalPrice:a?s:null,couponFinalPrice:c?u:null}}catch(r){return n.error({err:r},"Error computing best discounts locally"),{automaticDiscount:null,couponDiscount:null,automaticFinalPrice:null,couponFinalPrice:null}}}async function jt(e){let{productId:t,variantId:r,regularPrice:o,sellingPlanId:i=null,discounts:a}=e;try{let s=`${t}:${r}:${i||"none"}`;if(ie.has(s))return n.debug({cacheKey:s},"Best discount fetch already in flight"),await ie.get(s);let c=(async()=>{try{let u=J();if(!u)throw new Error("Shop domain not found");return await he({shop:u,entries:[{productId:t,variantId:r,regularPrice:typeof o=="number"?o:O(o),sellingPlanId:i}]})}catch(u){return n.error({err:u,cacheKey:s},"Best discount API request failed"),le(a,o)}finally{ie.delete(s)}})();return ie.set(s,c),await c}catch(s){return n.error({err:s},"Error ensuring best discounts from API"),le(a,o)}}function Ht(e){if(e)try{if(ae.has(e))return;F(e);let t=rt();if(!t)return;let r=e.querySelector($);r&&r.parentElement?(r.parentElement.insertBefore(t,r),r.style.display="none"):e.insertBefore(t,e.firstChild),ae.set(e,Date.now());let o=setTimeout(()=>{Oe(e,{force:!0})},zt);xe.set(e,o),n.debug("Showing form processing skeleton")}catch(t){n.error({err:t},"Error showing skeleton")}}function Oe(e,t={}){if(e)try{let r=ae.get(e);if(!r)return;let o=Date.now()-r;if(!(t.force===!0)&&o<st){setTimeout(()=>{Oe(e,{force:!0})},st-o);return}let a=e.querySelector(".ddp-skeleton-loader");a&&a.remove();let s=xe.get(e);s&&(clearTimeout(s),xe.delete(e)),ae.delete(e),n.debug("Cleared form processing skeleton")}catch(r){n.error({err:r},"Error clearing skeleton")}}function Wt(e,t){if(e)try{let r=Te.get(e);if(r===t){n.debug({variantId:t},"Variant unchanged, skipping");return}n.info({prevVariantId:r,nextVariantId:t},"Variant changed"),Te.set(e,t),V(e)&&Ht(e),_e.add(e),setTimeout(()=>{if(!e.isConnected)return;let o=N(e);o&&k(e,o),_e.delete(e)},Bt)}catch(r){n.error({err:r},"Error marking variant switch")}}function Kt(){return typeof Shopify>"u"||!Shopify.designMode?null:l.previewMode?l.previewMode:null}function Xt({type:e,value:t,isAutomatic:r,code:o}){return{id:"preview-"+Date.now(),title:r?"Preview Automatic Discount":"Preview Coupon Code",type:e||"percentage",value:t||10,isAutomatic:r===!0,codes:r?[]:[o||"PREVIEW10"],description:"This is a preview discount for theme editor.",validFrom:new Date().toISOString(),validUntil:null,isPreview:!0}}function k(e,t){if(!e||!t){n.debug("Cannot apply discounts: missing container or product ID");return}try{if(V(e)){let h=ct.get(e)||0,b=Date.now()-h;if(b<at&&!_e.has(e)){n.debug({elapsed:b},"Debouncing form processing"),setTimeout(()=>{e.isConnected&&k(e,t)},at-b);return}ct.set(e,Date.now())}let r=Kt();if(r){n.debug("Preview mode active");let h=Xt(r);V(e)?Y(e,{productId:t,discounts:[h],automaticDiscount:h.isAutomatic?h:null,couponDiscount:h.isAutomatic?null:h,isPreview:!0}):ut(e,[h]);return}let o=G[t];if(!o){n.debug({productId:t},"Product data not in cache, queuing"),Le(e,t);return}let i=o.discounts||[];if(i.length===0){n.debug({productId:t},"No discounts for product"),F(e);return}let s=Ee(e,H)?.variantId;if(s&&Te.set(e,s),s&&(i=i.filter(h=>!h.variants||h.variants.length===0?!0:h.variants.includes(s)),i.length===0)){n.debug({productId:t,variantId:s},"No discounts for variant"),F(e);return}let u=Ce(e)?.sellingPlanId,d=oe(u);if(i=ot(i,d),i.length===0){n.debug({productId:t,purchaseContext:d},"No discounts for purchase context"),F(e);return}let f=V(e),p=Ke(e,{formPriceDiscountedSelector:f?De:"",isForm:f});if(!p||!p.price){n.debug("Could not parse price from DOM"),F(e);return}p.regularPrice=p.price;let m=l.selectorOverrides?.useBestDiscountAPI===!0,v;if(m&&V(e))jt({productId:t,variantId:s,regularPrice:p.regularPrice,sellingPlanId:u,discounts:i}).then(h=>{if(!e.isConnected)return;let b={productId:t,variantId:s,sellingPlanId:u,productData:o,priceData:p,discounts:i,...h};Y(e,b)}).catch(h=>{n.error({err:h},"Error getting best discounts from API");let b=le(i,p.regularPrice),g={productId:t,variantId:s,sellingPlanId:u,productData:o,priceData:p,discounts:i,...b};e.isConnected&&Y(e,g)});else{v=le(i,p.regularPrice);let h={productId:t,variantId:s,sellingPlanId:u,productData:o,priceData:p,discounts:i,...v};V(e)?Y(e,h):ut(e,i)}}catch(r){n.error({err:r,productId:t},"Error applying discounts to product")}}function Y(e,t){if(e)try{Oe(e),F(e);let{productId:r,variantId:o,priceData:i,automaticDiscount:a,couponDiscount:s,automaticFinalPrice:c,couponFinalPrice:u,isPreview:d=!1}=t,f=a,p=c,m=e.querySelector($);m&&(m.style.display="none");let v=document.createElement("div");if(v.className="ddp-discounts ddp-discounts-container",f){let h=ve(i.regularPrice,p,f,!0,i.hasCurrencyCode);h&&v.appendChild(h)}if(s&&pt){let h=we(s,b=>{B(b)},b=>{B("")},r,o,!1);h&&v.appendChild(h)}if(m&&m.parentElement)m.parentElement.insertBefore(v,m);else{let h=e.querySelector('form[action*="/cart/add"]');h?h.insertBefore(v,h.firstChild):e.insertBefore(v,e.firstChild)}n.info({productId:r,variantId:o,hasAutomatic:!!a,hasCoupon:!!s},"Rendered form UI")}catch(r){n.error({err:r},"Error rendering form UI");let o=e.querySelector($);o&&(o.style.display="")}}function ut(e,t){if(!(!e||!t||t.length===0))try{F(e);let r=Xe(e,Ae);if(r.length===0){n.debug("No price elements found for badge attachment");return}if(Z(r[0].container,e)){n.debug("Price element is hidden, skipping badge");return}let o=N(e),i=r[0].container.textContent,a=O(i),s=K(i),c=t.filter(d=>d.isAutomatic),u=t.filter(d=>!d.isAutomatic);if(c.length>0){let d=c.sort((p,m)=>m.value-p.value)[0],f=a?X(a,d):null;ye(e,r,{productId:o,regularPrice:a,finalPrice:f,discount:d,hasCurrencyCode:s,singlePrice:!1})}if(u.length>0){let d=u.sort((f,p)=>p.value-f.value)[0];be(e,r,{productId:o,discount:d,hasCurrencyCode:s})}n.debug({automaticCount:c.length,couponCount:u.length},"Rendered card badges")}catch(r){n.error({err:r},"Error rendering card badges")}}function F(e){if(e)try{e.querySelectorAll(".ddp-discounts, .ddp-discounts-container").forEach(r=>r.remove()),e.querySelectorAll(".ddp-discount-badge, .ddp-coupon-badge").forEach(r=>r.remove()),e.querySelectorAll(".ddp-skeleton-loader").forEach(r=>r.remove());let t=e.querySelector($);t&&t.style.display==="none"&&(t.style.display="")}catch(t){n.error({err:t},"Error clearing existing discounts")}}function Fe(e){if(e)try{nt(e,H,t=>{t&&(n.debug({variantId:t},"Variant change detected"),Wt(e,t))},t=>{let r=N(e);r&&k(e,r)}),n.debug("Attached variant listeners")}catch(t){n.error({err:t},"Error attaching variant listeners")}}function Jt(){try{new MutationObserver(t=>{for(let r of t)if(r.type==="childList")for(let o of r.addedNodes){if(o.nodeType!==Node.ELEMENT_NODE)continue;let i=o.matches&&o.matches(z),a=o.matches&&o.matches(A);if(i||a){n.debug("New container detected via mutation");let s=N(o);s&&(k(o,s),Fe(o))}if(o.querySelectorAll){let s=o.querySelectorAll(z),c=o.querySelectorAll(A);for(let u of[...s,...c]){n.debug("New container detected in subtree");let d=N(u);d&&(k(u,d),Fe(u))}}}}).observe(document.body,{childList:!0,subtree:!0}),n.info("DOM observer initialized")}catch(e){n.error({err:e},"Error setting up DOM observer")}}function Qt(){try{let t=function(){e.setAttribute("data-timestamp",Date.now().toString())},e=document.getElementById("discount-heartbeat");e||(e=document.createElement("div"),e.id="discount-heartbeat",e.style.display="none",document.body.appendChild(e)),t(),setInterval(t,3e4),n.info("Heartbeat initialized")}catch(e){n.error({err:e},"Error setting up heartbeat")}}async function Yt(e=3e3){let t=Date.now();for(;Date.now()-t<e;){if(typeof Shopify<"u"&&Shopify.theme&&Shopify.theme.name)return n.info({themeName:Shopify.theme.name},"Shopify theme detected"),!0;await new Promise(r=>setTimeout(r,100))}return n.warn("Shopify theme not detected within timeout"),!1}async function Ne(){if(it){n.warn("Initialization already attempted");return}it=!0,n.info("Starting Discount Display Pro initialization");try{await Yt(),document.readyState==="loading"&&await new Promise(o=>{document.addEventListener("DOMContentLoaded",o)}),await $e(4e3),me(()=>{n.info("Theme selectors updated, reinitializing selectors"),lt();let o=[...se(),...ce()];for(let i of o){let a=N(i);a&&k(i,a)}}),lt(),ee(),await Gt();let e=se(),t=ce(),r=[...e,...t];n.info({totalContainers:r.length},"Found containers");for(let o of r){let i=N(o);i&&(k(o,i),Fe(o))}Jt(),Qt(),ft=!0,n.info("Discount Display Pro initialization complete")}catch(e){n.error({err:e},"Error during initialization")}}function Zt(e){if(!e)return"";try{return new Date(e).toLocaleDateString(void 0,{year:"numeric",month:"long",day:"numeric"})}catch{return e}}function er(e){let t=window.location.href,r=encodeURIComponent(t);return`/discount/${encodeURIComponent(e)}?return_to=${r}`}l.ui={createPriceContainer:ve,createCouponBlock:we,showTermsModal:re};l.cards={createAutomaticDiscountDisplay:ye,createCouponBadge:be};l.forms={renderPPFormUI:Y,applyDiscountCode:B,buildDiscountUrlWithReturnTo:er};l.utils={formatPrice:T,formatDate:Zt,parsePrice:O,calculateDiscountedPrice:X,clearExistingDiscounts:F,requestBestDiscounts:he};l.logger=n;l.state={get initializationComplete(){return ft},get products(){return G},get selectors(){return M}};typeof window<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Ne):Ne());var tr={initialize:Ne,applyDiscountsToProduct:k,clearExistingDiscounts:F,findProductContainers:se,findFormContainers:ce,mergeDiscountData:ke};return vt(rr);})();
//# sourceMappingURL=discount-display-pro.js.map
