{
  "version": 3,
  "sources": ["../../src/index.js", "../../src/namespace.js", "../../src/logger.js", "../../src/hidden-element-detector.js", "../../src/currency-formatter.js", "../../src/theme-selectors.js", "../../src/api-client.js", "../../src/price-extractor.js", "../../src/badge-renderer.js", "../../src/coupon-handler.js", "../../src/ui-components.js", "../../src/variant-detector.js", "../../src/subscription-handler.js"],
  "sourcesContent": ["/**\n * Discount Display Pro - Main Orchestrator\n *\n * Entry point that coordinates all modules:\n * - Theme selector initialization\n * - Product data loading\n * - DOM scanning and discount application\n * - Variant change detection\n * - Missing product queue management\n * - Preview mode support\n * - MutationObserver for dynamic content\n */\n\nimport { logger } from './logger.js';\nimport { isHiddenWithinBoundary } from './hidden-element-detector.js';\nimport { formatPrice, parsePrice, hasCurrencyCode, extractCurrencyFormat, calculateDiscountedPrice } from './currency-formatter.js';\nimport {\n  normalizeThemeName, pickThemeSelector, ensureThemeSelectorsReady,\n  subscribeToThemeSelectorUpdates\n} from './theme-selectors.js';\nimport { resolveShopDomain, loadDiscountData, fetchAdditionalDiscountData, requestBestDiscounts } from './api-client.js';\nimport { parsePriceFromDOM, findPriceElements } from './price-extractor.js';\nimport { createAutomaticDiscountDisplay, createCouponBadge } from './badge-renderer.js';\nimport { createPriceContainer, createCouponBlock, showTermsModal, buildSkeletonLoader } from './ui-components.js';\nimport { setupVariantDetection, getCurrentVariantInfo, getCurrentSellingPlanInfo } from './variant-detector.js';\nimport { applyDiscountCode, getCouponState, setCouponState, initCouponState } from './coupon-handler.js';\nimport { PURCHASE_CONTEXT, resolvePurchaseContext, isDiscountEligibleForSellingPlan, filterDiscountsByPurchaseContext } from './subscription-handler.js';\nimport _ns from './namespace.js';\n\n// ============================================================================\n// Core State Management\n// ============================================================================\n\n/**\n * Product data cache - keyed by product ID\n * Structure: { [productId]: { id, handle, title, variants, discounts, ... } }\n */\nlet products = {};\n\n/**\n * Variant ID to Product ID mapping for quick lookups\n */\nlet VARIANT_TO_PRODUCT = {};\n\n/**\n * Initialization state flags\n */\nlet initializationAttempted = false;\nlet initializationComplete = false;\n\n/**\n * Missing product queue - for products discovered in DOM but not in initial data\n */\nconst missingProductQueue = {\n  productIds: new Set(),\n  handles: new Set(),\n  variantIds: new Set(),\n  containers: new Map() // container -> { productId, handle, variantIds }\n};\n\nlet missingProductQueueTimer = null;\nlet missingProductFetchInFlight = false;\nconst missingProductAttempts = new Map(); // key -> attempt count\nlet missingProductFetchFailureCount = 0;\n\n/**\n * Whether the shop's tier allows coupon auto-apply (BASIC+)\n */\nlet autoApplyEnabled = false;\n\nconst MAX_MISSING_PRODUCT_ATTEMPTS = 5;\nconst MAX_FAILURE_BACKOFF_MS = 10000;\nconst BASE_FAILURE_BACKOFF_MS = 250;\nconst MAX_GLOBAL_FETCH_FAILURES = 5;\n\n/**\n * Debounce and processing state - WeakMaps for per-container state\n */\nconst FORM_PROCESS_DEBOUNCE_MS = 250;\nconst VARIANT_REAPPLY_FALLBACK_MS = 750;\nconst SKELETON_TIMEOUT_MS = 8000;\nconst SKELETON_MIN_DISPLAY_MS = 300;\n\nconst __wfLastRunAt = new WeakMap(); // container -> timestamp\nconst __wfLastVariant = new WeakMap(); // container -> variantId\nconst __wfReapplying = new WeakSet(); // container set\nconst __wfSkeletonShownAt = new WeakMap(); // container -> timestamp\nconst __wfSkeletonTimeoutTimers = new WeakMap(); // container -> timeoutId\nconst __wfBestDiscountFetches = new Map(); // cacheKey -> Promise\nconst __wfBestDiscountAwaitingContainers = new Map(); // cacheKey -> Set(containers)\n\n/**\n * Selector state - computed once at init, refreshed on theme selector updates\n */\nlet EMBED_PRICE_CONTAINER_SELECTOR = '';\nlet PRODUCT_CONTAINER_SELECTOR = '';\nlet VARIANT_INPUT_SELECTOR = '';\nlet FORM_CONTAINER_SELECTOR = '';\nlet FORM_PRICE_CONTAINER_SELECTOR = '';\nlet FORM_PRICE_DISCOUNTED_SELECTOR = '';\nconst SELECTOR_RESOLUTION = {}; // For debugging/logging\n\n// ============================================================================\n// Selector Initialization\n// ============================================================================\n\n/**\n * Initialize all theme selectors based on _ns.selectorOverrides and theme detection\n */\nfunction initializeSelectors() {\n  logger.info('Initializing theme selectors');\n\n  const settings = _ns.selectorOverrides || {};\n  const FORCE_AUTO = settings.themeSelectors_forceAutoDetection === true;\n  const placeholder = 'leave empty for theme auto detection';\n\n  /**\n   * Resolve a selector with custom override logic\n   */\n  function resolveSelector(key, defaultFallback) {\n    const enableKey = `themeSelectors_${key}_enable`;\n    const customKey = `themeSelectors_${key}_custom`;\n\n    const isEnabled = settings[enableKey] === true;\n    const customValue = settings[customKey];\n\n    // Use custom value if: not force auto, setting enabled, custom value exists, and not placeholder\n    if (!FORCE_AUTO && isEnabled && customValue && customValue.toLowerCase() !== placeholder.toLowerCase()) {\n      logger.info({ key, customValue }, 'Using custom selector');\n      return customValue;\n    }\n\n    // Otherwise use theme detection\n    const state = _ns._themeState;\n    const themeName = state?.resolvedTheme || 'dawn';\n    const result = pickThemeSelector(themeName, key, null);\n    if (result && result.value) {\n      logger.info({ key, detected: result.value, source: result.source }, 'Using detected selector');\n      return result.value;\n    }\n\n    // Fall back to default\n    logger.info({ key, fallback: defaultFallback }, 'Using default selector');\n    return defaultFallback;\n  }\n\n  // Resolve each selector\n  EMBED_PRICE_CONTAINER_SELECTOR = resolveSelector('cardPrice', '.price__container');\n  PRODUCT_CONTAINER_SELECTOR = resolveSelector('cardContainer', '.grid__item, product-card, .product-card');\n  VARIANT_INPUT_SELECTOR = resolveSelector('variantInput', 'input[ref=\"variantId\"], input[name=\"id\"], select[name=\"id\"], [data-variant-id]');\n  FORM_CONTAINER_SELECTOR = resolveSelector('formContainer', 'form[action*=\"/cart/add\"]');\n  FORM_PRICE_CONTAINER_SELECTOR = resolveSelector('formPrice', '.price__container');\n  FORM_PRICE_DISCOUNTED_SELECTOR = resolveSelector('formPrice_discounted', '.price__sale');\n\n  // Store resolution for debugging\n  SELECTOR_RESOLUTION.cardPrice = EMBED_PRICE_CONTAINER_SELECTOR;\n  SELECTOR_RESOLUTION.cardContainer = PRODUCT_CONTAINER_SELECTOR;\n  SELECTOR_RESOLUTION.variantInput = VARIANT_INPUT_SELECTOR;\n  SELECTOR_RESOLUTION.formContainer = FORM_CONTAINER_SELECTOR;\n  SELECTOR_RESOLUTION.formPrice = FORM_PRICE_CONTAINER_SELECTOR;\n  SELECTOR_RESOLUTION.formPrice_discounted = FORM_PRICE_DISCOUNTED_SELECTOR;\n\n  // Expose key selectors on window for external access\n  _ns._formPriceSelector = FORM_PRICE_CONTAINER_SELECTOR;\n  _ns._formSelector = FORM_CONTAINER_SELECTOR;\n\n  logger.info({ selectors: SELECTOR_RESOLUTION }, 'Selectors initialized');\n}\n\n// ============================================================================\n// Container Detection\n// ============================================================================\n\n/**\n * Find all product card containers on the page\n */\nfunction findProductContainers() {\n  if (!PRODUCT_CONTAINER_SELECTOR) {\n    logger.warn('Product container selector not initialized');\n    return [];\n  }\n\n  try {\n    const containers = Array.from(document.querySelectorAll(PRODUCT_CONTAINER_SELECTOR));\n    logger.info({ count: containers.length }, 'Found product containers');\n    return containers;\n  } catch (err) {\n    logger.error({ err, selector: PRODUCT_CONTAINER_SELECTOR }, 'Error finding product containers');\n    return [];\n  }\n}\n\n/**\n * Find all form containers on the page\n */\nfunction findFormContainers() {\n  if (!FORM_CONTAINER_SELECTOR) {\n    logger.warn('Form container selector not initialized');\n    return [];\n  }\n\n  try {\n    const containers = Array.from(document.querySelectorAll(FORM_CONTAINER_SELECTOR));\n    logger.info({ count: containers.length }, 'Found form containers');\n    return containers;\n  } catch (err) {\n    logger.error({ err, selector: FORM_CONTAINER_SELECTOR }, 'Error finding form containers');\n    return [];\n  }\n}\n\n/**\n * Check if a container is a form container\n */\nfunction isFormContainer(container) {\n  if (!container) return false;\n\n  try {\n    // Check if matches form selector\n    if (FORM_CONTAINER_SELECTOR && container.matches(FORM_CONTAINER_SELECTOR)) {\n      return true;\n    }\n\n    // Check if contains cart form\n    const cartForm = container.querySelector('form[action*=\"/cart/add\"]');\n    if (cartForm) {\n      return true;\n    }\n\n    return false;\n  } catch (err) {\n    logger.error({ err }, 'Error checking if form container');\n    return false;\n  }\n}\n\n// ============================================================================\n// Product ID Detection\n// ============================================================================\n\n/**\n * Find product ID for a given container using multiple strategies\n */\nfunction findProductId(container) {\n  if (!container) return null;\n\n  try {\n    // Strategy 1: Variant input -> VARIANT_TO_PRODUCT mapping\n    const variantInput = container.querySelector(VARIANT_INPUT_SELECTOR);\n    if (variantInput) {\n      const variantId = variantInput.value || variantInput.getAttribute('data-variant-id') || variantInput.getAttribute('ref');\n      if (variantId) {\n        const productId = VARIANT_TO_PRODUCT[variantId];\n        if (productId) {\n          logger.debug({ variantId, productId }, 'Found product ID via variant mapping');\n          return productId;\n        }\n      }\n    }\n\n    // Strategy 2: Container data-product-id attribute\n    const containerProductId = container.getAttribute('data-product-id');\n    if (containerProductId) {\n      logger.debug({ productId: containerProductId }, 'Found product ID via container attribute');\n      return containerProductId;\n    }\n\n    // Strategy 3: Input[name=\"product-id\"] or input[name=\"product_id\"]\n    const productInput = container.querySelector('input[name=\"product-id\"], input[name=\"product_id\"]');\n    if (productInput?.value) {\n      logger.debug({ productId: productInput.value }, 'Found product ID via product input');\n      return productInput.value;\n    }\n\n    // Strategy 4: Inner element with data-product-id\n    const innerProductEl = container.querySelector('[data-product-id]');\n    if (innerProductEl) {\n      const innerProductId = innerProductEl.getAttribute('data-product-id');\n      if (innerProductId) {\n        logger.debug({ productId: innerProductId }, 'Found product ID via inner element');\n        return innerProductId;\n      }\n    }\n\n    // Strategy 5: Link href /products/<handle> -> match to products by handle\n    const productLink = container.querySelector('a[href*=\"/products/\"]');\n    if (productLink) {\n      const href = productLink.getAttribute('href');\n      const match = href.match(/\\/products\\/([^?/#]+)/);\n      if (match) {\n        const handle = match[1];\n        // Search products by handle\n        for (const [productId, product] of Object.entries(products)) {\n          if (product.handle === handle) {\n            logger.debug({ handle, productId }, 'Found product ID via handle match');\n            return productId;\n          }\n        }\n        // Queue handle for fetching\n        logger.debug({ handle }, 'Product handle found but not in cache');\n        queueMissingProductData(container, null, handle);\n      }\n    }\n\n    // Strategy 6: Link ID attribute numeric extraction\n    if (productLink) {\n      const linkId = productLink.getAttribute('id');\n      if (linkId) {\n        const numericMatch = linkId.match(/(\\d{10,})/); // Shopify IDs are typically 10+ digits\n        if (numericMatch) {\n          const candidateId = numericMatch[1];\n          if (products[candidateId]) {\n            logger.debug({ productId: candidateId }, 'Found product ID via link ID extraction');\n            return candidateId;\n          }\n        }\n      }\n    }\n\n    // Strategy 7: Section-scope variant/product-id search\n    const sectionId = container.closest('[id*=\"shopify-section\"]')?.id;\n    if (sectionId) {\n      const sectionScope = document.getElementById(sectionId);\n      if (sectionScope) {\n        const sectionProductInput = sectionScope.querySelector('input[name=\"product-id\"], input[name=\"product_id\"]');\n        if (sectionProductInput?.value) {\n          logger.debug({ productId: sectionProductInput.value, sectionId }, 'Found product ID via section scope');\n          return sectionProductInput.value;\n        }\n      }\n    }\n\n    logger.debug('Could not find product ID for container');\n    return null;\n  } catch (err) {\n    logger.error({ err }, 'Error finding product ID');\n    return null;\n  }\n}\n\n// ============================================================================\n// Data Management\n// ============================================================================\n\n/**\n * Merge discount data from API into local cache\n */\nfunction mergeDiscountData(discountData) {\n  if (!discountData || !discountData.products) {\n    logger.warn('Invalid discount data received');\n    return;\n  }\n\n  try {\n    // Capture tier-gated feature flags from API response\n    if (discountData.autoApplyEnabled !== undefined) {\n      autoApplyEnabled = discountData.autoApplyEnabled;\n    }\n\n    const newProducts = discountData.products;\n    let mergedCount = 0;\n\n    for (const [productId, productData] of Object.entries(newProducts)) {\n      products[productId] = productData;\n      mergedCount++;\n\n      // Build variant-to-product mapping\n      if (productData.variants && Array.isArray(productData.variants)) {\n        for (const variant of productData.variants) {\n          if (variant.id) {\n            VARIANT_TO_PRODUCT[variant.id] = productId;\n          }\n        }\n      }\n    }\n\n    logger.info({ mergedCount, totalProducts: Object.keys(products).length }, 'Merged discount data');\n  } catch (err) {\n    logger.error({ err }, 'Error merging discount data');\n  }\n}\n\n/**\n * Collect all product context from the current page (product IDs, variant IDs, handles)\n */\nfunction collectPageProductContext() {\n  const context = {\n    productIds: new Set(),\n    variantIds: new Set(),\n    handles: new Set()\n  };\n\n  try {\n    // Find all containers\n    const containers = [\n      ...findProductContainers(),\n      ...findFormContainers()\n    ];\n\n    for (const container of containers) {\n      // Try to find product ID\n      const productId = findProductId(container);\n      if (productId) {\n        context.productIds.add(productId);\n      }\n\n      // Try to find variant ID\n      const variantInput = container.querySelector(VARIANT_INPUT_SELECTOR);\n      if (variantInput) {\n        const variantId = variantInput.value || variantInput.getAttribute('data-variant-id') || variantInput.getAttribute('ref');\n        if (variantId) {\n          context.variantIds.add(variantId);\n        }\n      }\n\n      // Try to find product handle\n      const productLink = container.querySelector('a[href*=\"/products/\"]');\n      if (productLink) {\n        const href = productLink.getAttribute('href');\n        const match = href.match(/\\/products\\/([^?/#]+)/);\n        if (match) {\n          context.handles.add(match[1]);\n        }\n      }\n    }\n\n    // Convert Sets to Arrays\n    const result = {\n      productIds: Array.from(context.productIds),\n      variantIds: Array.from(context.variantIds),\n      handles: Array.from(context.handles)\n    };\n\n    logger.info(result, 'Collected page product context');\n    return result;\n  } catch (err) {\n    logger.error({ err }, 'Error collecting page product context');\n    return { productIds: [], variantIds: [], handles: [] };\n  }\n}\n\n/**\n * Load all products from database (initial page load)\n */\nasync function loadAllProductsFromDatabase() {\n  try {\n    logger.info('Loading discount data from database');\n\n    // Collect page context to send with request\n    const context = collectPageProductContext();\n\n    const discountData = await loadDiscountData(context);\n    if (discountData) {\n      mergeDiscountData(discountData);\n    }\n  } catch (err) {\n    logger.error({ err }, 'Error loading products from database');\n  }\n}\n\n// ============================================================================\n// Missing Product Queue\n// ============================================================================\n\n/**\n * Queue a product for fetching if not in cache\n */\nfunction queueMissingProductData(container, productId = null, handle = null, variantIds = []) {\n  try {\n    // Don't queue if already at max attempts\n    const key = productId || handle || variantIds.join(',');\n    if (missingProductAttempts.get(key) >= MAX_MISSING_PRODUCT_ATTEMPTS) {\n      logger.debug({ key }, 'Max attempts reached for missing product');\n      return;\n    }\n\n    // Don't queue if global failure count too high\n    if (missingProductFetchFailureCount >= MAX_GLOBAL_FETCH_FAILURES) {\n      logger.warn('Global fetch failure count exceeded, not queuing');\n      return;\n    }\n\n    // Add to queue\n    if (productId) missingProductQueue.productIds.add(productId);\n    if (handle) missingProductQueue.handles.add(handle);\n    if (variantIds.length > 0) {\n      variantIds.forEach(vid => missingProductQueue.variantIds.add(vid));\n    }\n\n    // Store container mapping\n    if (container) {\n      missingProductQueue.containers.set(container, { productId, handle, variantIds });\n    }\n\n    logger.debug({ productId, handle, variantIds }, 'Queued missing product data');\n\n    // Schedule flush\n    if (missingProductQueueTimer) {\n      clearTimeout(missingProductQueueTimer);\n    }\n\n    const backoffMs = Math.min(\n      BASE_FAILURE_BACKOFF_MS * Math.pow(2, missingProductFetchFailureCount),\n      MAX_FAILURE_BACKOFF_MS\n    );\n\n    missingProductQueueTimer = setTimeout(() => {\n      flushMissingProductData();\n    }, backoffMs);\n  } catch (err) {\n    logger.error({ err }, 'Error queuing missing product data');\n  }\n}\n\n/**\n * Flush missing product queue and fetch from API\n */\nasync function flushMissingProductData() {\n  if (missingProductFetchInFlight) {\n    logger.debug('Missing product fetch already in flight');\n    return;\n  }\n\n  if (missingProductQueue.productIds.size === 0 &&\n      missingProductQueue.handles.size === 0 &&\n      missingProductQueue.variantIds.size === 0) {\n    logger.debug('Missing product queue is empty');\n    return;\n  }\n\n  missingProductFetchInFlight = true;\n\n  try {\n    // Snapshot current queue\n    const productIds = Array.from(missingProductQueue.productIds);\n    const handles = Array.from(missingProductQueue.handles);\n    const variantIds = Array.from(missingProductQueue.variantIds);\n    const containers = new Map(missingProductQueue.containers);\n\n    // Clear queue\n    missingProductQueue.productIds.clear();\n    missingProductQueue.handles.clear();\n    missingProductQueue.variantIds.clear();\n    missingProductQueue.containers.clear();\n\n    logger.info({ productIds, handles, variantIds }, 'Flushing missing product queue');\n\n    // Increment attempt counts\n    productIds.forEach(id => {\n      const count = missingProductAttempts.get(id) || 0;\n      missingProductAttempts.set(id, count + 1);\n    });\n    handles.forEach(h => {\n      const count = missingProductAttempts.get(h) || 0;\n      missingProductAttempts.set(h, count + 1);\n    });\n\n    // Fetch data\n    const result = await fetchAdditionalDiscountData({\n      productIds,\n      handles,\n      variantIds\n    });\n\n    if (result.success && result.data) {\n      mergeDiscountData(result.data);\n\n      // Reset failure count on success\n      missingProductFetchFailureCount = 0;\n\n      // Reapply discounts to waiting containers\n      for (const [container, queueData] of containers.entries()) {\n        if (!container.isConnected) continue;\n\n        const productId = queueData.productId || findProductId(container);\n        if (productId && products[productId]) {\n          logger.debug({ productId }, 'Reapplying discounts after missing product fetch');\n          applyDiscountsToProduct(container, productId);\n        }\n      }\n    } else {\n      // Increment failure count\n      missingProductFetchFailureCount++;\n      logger.warn({ failureCount: missingProductFetchFailureCount }, 'Missing product fetch failed');\n\n      // Re-queue if not at max attempts\n      for (const [container, queueData] of containers.entries()) {\n        if (!container.isConnected) continue;\n        queueMissingProductData(container, queueData.productId, queueData.handle, queueData.variantIds);\n      }\n    }\n  } catch (err) {\n    logger.error({ err }, 'Error flushing missing product queue');\n    missingProductFetchFailureCount++;\n  } finally {\n    missingProductFetchInFlight = false;\n  }\n}\n\n// ============================================================================\n// Best Discount Computation\n// ============================================================================\n\n/**\n * Compute best discounts locally (client-side)\n */\nfunction computeBestDiscountsLocally(discounts, regularPrice) {\n  if (!discounts || discounts.length === 0) {\n    return {\n      automaticDiscount: null,\n      couponDiscount: null,\n      automaticFinalPrice: null,\n      couponFinalPrice: null\n    };\n  }\n\n  try {\n    const priceValue = typeof regularPrice === 'number' ? regularPrice : parsePrice(regularPrice);\n\n    // Separate automatic and coupon discounts\n    const automaticDiscounts = discounts.filter(d => d.isAutomatic);\n    const couponDiscounts = discounts.filter(d => !d.isAutomatic);\n\n    // Find best automatic discount (lowest final price)\n    let bestAutomatic = null;\n    let bestAutomaticPrice = Infinity;\n\n    for (const discount of automaticDiscounts) {\n      const finalPrice = calculateDiscountedPrice(priceValue, discount);\n      if (finalPrice < bestAutomaticPrice) {\n        bestAutomaticPrice = finalPrice;\n        bestAutomatic = discount;\n      }\n    }\n\n    // Find best coupon discount (lowest final price)\n    let bestCoupon = null;\n    let bestCouponPrice = Infinity;\n\n    for (const discount of couponDiscounts) {\n      const finalPrice = calculateDiscountedPrice(priceValue, discount);\n      if (finalPrice < bestCouponPrice) {\n        bestCouponPrice = finalPrice;\n        bestCoupon = discount;\n      }\n    }\n\n    // If automatic discount wins, suppress coupon\n    if (bestAutomatic && bestCoupon && bestAutomaticPrice <= bestCouponPrice) {\n      bestCoupon = null;\n      bestCouponPrice = null;\n    }\n\n    return {\n      automaticDiscount: bestAutomatic,\n      couponDiscount: bestCoupon,\n      automaticFinalPrice: bestAutomatic ? bestAutomaticPrice : null,\n      couponFinalPrice: bestCoupon ? bestCouponPrice : null\n    };\n  } catch (err) {\n    logger.error({ err }, 'Error computing best discounts locally');\n    return {\n      automaticDiscount: null,\n      couponDiscount: null,\n      automaticFinalPrice: null,\n      couponFinalPrice: null\n    };\n  }\n}\n\n/**\n * Ensure best discounts from API (with caching and fallback)\n */\nasync function ensureBestDiscountsFromAPI(options) {\n  const {\n    productId,\n    variantId,\n    regularPrice,\n    sellingPlanId = null,\n    discounts\n  } = options;\n\n  try {\n    // Build cache key\n    const cacheKey = `${productId}:${variantId}:${sellingPlanId || 'none'}`;\n\n    // Check if fetch already in flight\n    if (__wfBestDiscountFetches.has(cacheKey)) {\n      logger.debug({ cacheKey }, 'Best discount fetch already in flight');\n      return await __wfBestDiscountFetches.get(cacheKey);\n    }\n\n    // Start fetch\n    const fetchPromise = (async () => {\n      try {\n        const shopDomain = resolveShopDomain();\n        if (!shopDomain) {\n          throw new Error('Shop domain not found');\n        }\n\n        const result = await requestBestDiscounts({\n          shop: shopDomain,\n          entries: [{\n            productId,\n            variantId,\n            regularPrice: typeof regularPrice === 'number' ? regularPrice : parsePrice(regularPrice),\n            sellingPlanId\n          }]\n        });\n\n        return result;\n      } catch (err) {\n        logger.error({ err, cacheKey }, 'Best discount API request failed');\n        // Fallback to local computation\n        return computeBestDiscountsLocally(discounts, regularPrice);\n      } finally {\n        // Clean up cache\n        __wfBestDiscountFetches.delete(cacheKey);\n      }\n    })();\n\n    __wfBestDiscountFetches.set(cacheKey, fetchPromise);\n    return await fetchPromise;\n  } catch (err) {\n    logger.error({ err }, 'Error ensuring best discounts from API');\n    return computeBestDiscountsLocally(discounts, regularPrice);\n  }\n}\n\n// ============================================================================\n// Skeleton Loader\n// ============================================================================\n\n/**\n * Show processing skeleton for form container\n */\nfunction showFormProcessingSkeleton(container) {\n  if (!container) return;\n\n  try {\n    // Check if already showing\n    if (__wfSkeletonShownAt.has(container)) {\n      return;\n    }\n\n    // Clear any existing discount UI\n    clearExistingDiscounts(container);\n\n    // Create skeleton\n    const skeleton = buildSkeletonLoader();\n    if (!skeleton) return;\n\n    // Insert skeleton\n    const priceEl = container.querySelector(FORM_PRICE_CONTAINER_SELECTOR);\n    if (priceEl && priceEl.parentElement) {\n      priceEl.parentElement.insertBefore(skeleton, priceEl);\n      priceEl.style.display = 'none';\n    } else {\n      container.insertBefore(skeleton, container.firstChild);\n    }\n\n    // Mark shown\n    __wfSkeletonShownAt.set(container, Date.now());\n\n    // Set timeout to remove skeleton if it takes too long\n    const timeoutId = setTimeout(() => {\n      clearFormProcessingSkeleton(container, { force: true });\n    }, SKELETON_TIMEOUT_MS);\n\n    __wfSkeletonTimeoutTimers.set(container, timeoutId);\n\n    logger.debug('Showing form processing skeleton');\n  } catch (err) {\n    logger.error({ err }, 'Error showing skeleton');\n  }\n}\n\n/**\n * Clear processing skeleton from form container\n */\nfunction clearFormProcessingSkeleton(container, options = {}) {\n  if (!container) return;\n\n  try {\n    const shownAt = __wfSkeletonShownAt.get(container);\n    if (!shownAt) return;\n\n    const elapsed = Date.now() - shownAt;\n    const force = options.force === true;\n\n    // Ensure minimum display time unless forced\n    if (!force && elapsed < SKELETON_MIN_DISPLAY_MS) {\n      setTimeout(() => {\n        clearFormProcessingSkeleton(container, { force: true });\n      }, SKELETON_MIN_DISPLAY_MS - elapsed);\n      return;\n    }\n\n    // Remove skeleton\n    const skeleton = container.querySelector('.ddp-skeleton-loader');\n    if (skeleton) {\n      skeleton.remove();\n    }\n\n    // Clear timeout\n    const timeoutId = __wfSkeletonTimeoutTimers.get(container);\n    if (timeoutId) {\n      clearTimeout(timeoutId);\n      __wfSkeletonTimeoutTimers.delete(container);\n    }\n\n    // Clear state\n    __wfSkeletonShownAt.delete(container);\n\n    logger.debug('Cleared form processing skeleton');\n  } catch (err) {\n    logger.error({ err }, 'Error clearing skeleton');\n  }\n}\n\n/**\n * Mark variant switch and trigger debounced reapply\n */\nfunction markVariantSwitch(container, nextVariantId) {\n  if (!container) return;\n\n  try {\n    const prevVariantId = __wfLastVariant.get(container);\n\n    if (prevVariantId === nextVariantId) {\n      logger.debug({ variantId: nextVariantId }, 'Variant unchanged, skipping');\n      return;\n    }\n\n    logger.info({ prevVariantId, nextVariantId }, 'Variant changed');\n\n    // Update stored variant\n    __wfLastVariant.set(container, nextVariantId);\n\n    // Show skeleton for forms\n    if (isFormContainer(container)) {\n      showFormProcessingSkeleton(container);\n    }\n\n    // Set reapplying flag\n    __wfReapplying.add(container);\n\n    // Debounce reapply\n    setTimeout(() => {\n      if (!container.isConnected) return;\n\n      const productId = findProductId(container);\n      if (productId) {\n        applyDiscountsToProduct(container, productId);\n      }\n\n      __wfReapplying.delete(container);\n    }, VARIANT_REAPPLY_FALLBACK_MS);\n  } catch (err) {\n    logger.error({ err }, 'Error marking variant switch');\n  }\n}\n\n// ============================================================================\n// Preview Mode\n// ============================================================================\n\n/**\n * Get preview mode state (only in Shopify design mode)\n */\nfunction getPreviewMode() {\n  if (typeof Shopify === 'undefined' || !Shopify.designMode) {\n    return null;\n  }\n\n  if (_ns.previewMode) {\n    return _ns.previewMode;\n  }\n\n  return null;\n}\n\n/**\n * Build preview discount based on block settings\n */\nfunction buildPreviewDiscount({ type, value, isAutomatic, code }) {\n  return {\n    id: 'preview-' + Date.now(),\n    title: isAutomatic ? 'Preview Automatic Discount' : 'Preview Coupon Code',\n    type: type || 'percentage',\n    value: value || 10,\n    isAutomatic: isAutomatic === true,\n    codes: isAutomatic ? [] : [code || 'PREVIEW10'],\n    description: 'This is a preview discount for theme editor.',\n    validFrom: new Date().toISOString(),\n    validUntil: null,\n    isPreview: true\n  };\n}\n\n// ============================================================================\n// Discount Application - Core Logic\n// ============================================================================\n\n/**\n * Apply discounts to a product container (main entry point)\n */\nfunction applyDiscountsToProduct(container, productId) {\n  if (!container || !productId) {\n    logger.debug('Cannot apply discounts: missing container or product ID');\n    return;\n  }\n\n  try {\n    // Debounce for form containers\n    if (isFormContainer(container)) {\n      const lastRunAt = __wfLastRunAt.get(container) || 0;\n      const elapsed = Date.now() - lastRunAt;\n\n      if (elapsed < FORM_PROCESS_DEBOUNCE_MS && !__wfReapplying.has(container)) {\n        logger.debug({ elapsed }, 'Debouncing form processing');\n        setTimeout(() => {\n          if (container.isConnected) {\n            applyDiscountsToProduct(container, productId);\n          }\n        }, FORM_PROCESS_DEBOUNCE_MS - elapsed);\n        return;\n      }\n\n      __wfLastRunAt.set(container, Date.now());\n    }\n\n    // Check preview mode\n    const previewMode = getPreviewMode();\n    if (previewMode) {\n      logger.debug('Preview mode active');\n      const previewDiscount = buildPreviewDiscount(previewMode);\n\n      if (isFormContainer(container)) {\n        renderFormUI(container, {\n          productId,\n          discounts: [previewDiscount],\n          automaticDiscount: previewDiscount.isAutomatic ? previewDiscount : null,\n          couponDiscount: !previewDiscount.isAutomatic ? previewDiscount : null,\n          isPreview: true\n        });\n      } else {\n        renderCardBadges(container, [previewDiscount]);\n      }\n      return;\n    }\n\n    // Get product data\n    const productData = products[productId];\n    if (!productData) {\n      logger.debug({ productId }, 'Product data not in cache, queuing');\n      queueMissingProductData(container, productId);\n      return;\n    }\n\n    // Get discounts\n    let discounts = productData.discounts || [];\n    if (discounts.length === 0) {\n      logger.debug({ productId }, 'No discounts for product');\n      clearExistingDiscounts(container);\n      return;\n    }\n\n    // Detect current variant\n    const variantInfo = getCurrentVariantInfo(container, VARIANT_INPUT_SELECTOR);\n    const variantId = variantInfo?.variantId;\n\n    if (variantId) {\n      __wfLastVariant.set(container, variantId);\n    }\n\n    // Filter discounts by variant eligibility\n    if (variantId) {\n      discounts = discounts.filter(discount => {\n        // Check if discount applies to this variant\n        if (!discount.variants || discount.variants.length === 0) {\n          return true; // Applies to all variants\n        }\n        return discount.variants.includes(variantId);\n      });\n\n      if (discounts.length === 0) {\n        logger.debug({ productId, variantId }, 'No discounts for variant');\n        clearExistingDiscounts(container);\n        return;\n      }\n    }\n\n    // Detect selling plan\n    const sellingPlanInfo = getCurrentSellingPlanInfo(container);\n    const sellingPlanId = sellingPlanInfo?.sellingPlanId;\n    const purchaseContext = resolvePurchaseContext(sellingPlanId);\n\n    // Filter discounts by selling plan eligibility\n    discounts = filterDiscountsByPurchaseContext(discounts, purchaseContext);\n\n    if (discounts.length === 0) {\n      logger.debug({ productId, purchaseContext }, 'No discounts for purchase context');\n      clearExistingDiscounts(container);\n      return;\n    }\n\n    // Parse price from DOM\n    const isForm = isFormContainer(container);\n    const priceData = parsePriceFromDOM(container, {\n      formPriceDiscountedSelector: isForm ? FORM_PRICE_DISCOUNTED_SELECTOR : '',\n      isForm\n    });\n\n    if (!priceData || !priceData.price) {\n      logger.debug('Could not parse price from DOM');\n      clearExistingDiscounts(container);\n      return;\n    }\n\n    // Normalize price data shape for downstream consumers\n    priceData.regularPrice = priceData.price;\n\n    // Compute best discounts\n    const useAPI = _ns.selectorOverrides?.useBestDiscountAPI === true;\n    let bestDiscounts;\n\n    if (useAPI && isFormContainer(container)) {\n      // Use API for form containers\n      ensureBestDiscountsFromAPI({\n        productId,\n        variantId,\n        regularPrice: priceData.regularPrice,\n        sellingPlanId,\n        discounts\n      }).then(result => {\n        if (!container.isConnected) return;\n\n        const ctx = {\n          productId,\n          variantId,\n          sellingPlanId,\n          productData,\n          priceData,\n          discounts,\n          ...result\n        };\n\n        renderFormUI(container, ctx);\n      }).catch(err => {\n        logger.error({ err }, 'Error getting best discounts from API');\n\n        // Fallback to local computation\n        const fallbackResult = computeBestDiscountsLocally(discounts, priceData.regularPrice);\n        const ctx = {\n          productId,\n          variantId,\n          sellingPlanId,\n          productData,\n          priceData,\n          discounts,\n          ...fallbackResult\n        };\n\n        if (container.isConnected) {\n          renderFormUI(container, ctx);\n        }\n      });\n    } else {\n      // Use local computation\n      bestDiscounts = computeBestDiscountsLocally(discounts, priceData.regularPrice);\n\n      const ctx = {\n        productId,\n        variantId,\n        sellingPlanId,\n        productData,\n        priceData,\n        discounts,\n        ...bestDiscounts\n      };\n\n      if (isFormContainer(container)) {\n        renderFormUI(container, ctx);\n      } else {\n        renderCardBadges(container, discounts);\n      }\n    }\n  } catch (err) {\n    logger.error({ err, productId }, 'Error applying discounts to product');\n  }\n}\n\n/**\n * Render form UI (product page)\n */\nfunction renderFormUI(container, ctx) {\n  if (!container) return;\n\n  try {\n    // Clear skeleton\n    clearFormProcessingSkeleton(container);\n\n    // Clear existing discounts\n    clearExistingDiscounts(container);\n\n    const {\n      productId,\n      variantId,\n      priceData,\n      automaticDiscount,\n      couponDiscount,\n      automaticFinalPrice,\n      couponFinalPrice,\n      isPreview = false\n    } = ctx;\n\n    // Determine winning discount (for auto-apply logic)\n    let winningDiscount = automaticDiscount;\n    let winningFinalPrice = automaticFinalPrice;\n\n    // Find and hide original price element\n    const priceEl = container.querySelector(FORM_PRICE_CONTAINER_SELECTOR);\n    if (priceEl) {\n      priceEl.style.display = 'none';\n    }\n\n    // Create main container\n    const discountContainer = document.createElement('div');\n    discountContainer.className = 'ddp-discounts ddp-discounts-container';\n\n    // Mount price container if we have a discount\n    if (winningDiscount) {\n      const priceContainer = createPriceContainer(\n        priceData.regularPrice,\n        winningFinalPrice,\n        winningDiscount,\n        true, // isAutomatic\n        priceData.hasCurrencyCode\n      );\n\n      if (priceContainer) {\n        discountContainer.appendChild(priceContainer);\n      }\n    }\n\n    // Create coupon block if eligible (BASIC+ tier only)\n    if (couponDiscount && autoApplyEnabled) {\n      const couponBlock = createCouponBlock(\n        couponDiscount,\n        (code) => { applyDiscountCode(code); },  // onApply\n        (code) => { applyDiscountCode(''); },     // onRemove\n        productId,\n        variantId,\n        false // isAutoApplied\n      );\n\n      if (couponBlock) {\n        discountContainer.appendChild(couponBlock);\n      }\n    }\n\n    // Insert container\n    if (priceEl && priceEl.parentElement) {\n      priceEl.parentElement.insertBefore(discountContainer, priceEl);\n    } else {\n      const formEl = container.querySelector('form[action*=\"/cart/add\"]');\n      if (formEl) {\n        formEl.insertBefore(discountContainer, formEl.firstChild);\n      } else {\n        container.insertBefore(discountContainer, container.firstChild);\n      }\n    }\n\n    logger.info({ productId, variantId, hasAutomatic: !!automaticDiscount, hasCoupon: !!couponDiscount }, 'Rendered form UI');\n  } catch (err) {\n    logger.error({ err }, 'Error rendering form UI');\n\n    // Restore original price on error\n    const priceEl = container.querySelector(FORM_PRICE_CONTAINER_SELECTOR);\n    if (priceEl) {\n      priceEl.style.display = '';\n    }\n  }\n}\n\n/**\n * Render card badges (collection/search pages)\n */\nfunction renderCardBadges(container, discounts) {\n  if (!container || !discounts || discounts.length === 0) return;\n\n  try {\n    // Clear existing badges\n    clearExistingDiscounts(container);\n\n    // Find price elements to attach badges\n    const priceElements = findPriceElements(container, EMBED_PRICE_CONTAINER_SELECTOR);\n    if (priceElements.length === 0) {\n      logger.debug('No price elements found for badge attachment');\n      return;\n    }\n\n    // Check if first price element is hidden\n    if (isHiddenWithinBoundary(priceElements[0].container, container)) {\n      logger.debug('Price element is hidden, skipping badge');\n      return;\n    }\n\n    const productId = findProductId(container);\n\n    // Parse price from first visible price element for automatic discount calculations\n    const priceText = priceElements[0].container.textContent;\n    const regularPrice = parsePrice(priceText);\n    const priceHasCurrency = hasCurrencyCode(priceText);\n\n    // Separate automatic and coupon discounts\n    const automaticDiscounts = discounts.filter(d => d.isAutomatic);\n    const couponDiscounts = discounts.filter(d => !d.isAutomatic);\n\n    // Render automatic badge (highest value)\n    if (automaticDiscounts.length > 0) {\n      const topAutomatic = automaticDiscounts.sort((a, b) => b.value - a.value)[0];\n      const finalPrice = regularPrice ? calculateDiscountedPrice(regularPrice, topAutomatic) : null;\n      createAutomaticDiscountDisplay(container, priceElements, {\n        productId,\n        regularPrice,\n        finalPrice,\n        discount: topAutomatic,\n        hasCurrencyCode: priceHasCurrency,\n        singlePrice: false\n      });\n    }\n\n    // Render coupon badge (highest value)\n    if (couponDiscounts.length > 0) {\n      const topCoupon = couponDiscounts.sort((a, b) => b.value - a.value)[0];\n      createCouponBadge(container, priceElements, {\n        productId,\n        discount: topCoupon,\n        hasCurrencyCode: priceHasCurrency\n      });\n    }\n\n    logger.debug({ automaticCount: automaticDiscounts.length, couponCount: couponDiscounts.length }, 'Rendered card badges');\n  } catch (err) {\n    logger.error({ err }, 'Error rendering card badges');\n  }\n}\n\n/**\n * Clear existing discount UI from container\n */\nfunction clearExistingDiscounts(container) {\n  if (!container) return;\n\n  try {\n    // Remove discount containers\n    container.querySelectorAll('.ddp-discounts, .ddp-discounts-container').forEach(el => el.remove());\n\n    // Remove badges\n    container.querySelectorAll('.ddp-discount-badge, .ddp-coupon-badge').forEach(el => el.remove());\n\n    // Remove skeletons\n    container.querySelectorAll('.ddp-skeleton-loader').forEach(el => el.remove());\n\n    // Restore hidden price elements\n    const priceEl = container.querySelector(FORM_PRICE_CONTAINER_SELECTOR);\n    if (priceEl && priceEl.style.display === 'none') {\n      priceEl.style.display = '';\n    }\n  } catch (err) {\n    logger.error({ err }, 'Error clearing existing discounts');\n  }\n}\n\n// ============================================================================\n// Variant Change Detection\n// ============================================================================\n\n/**\n * Attach variant change listeners to a container\n */\nfunction attachVariantListeners(container) {\n  if (!container) return;\n\n  try {\n    setupVariantDetection(\n      container,\n      VARIANT_INPUT_SELECTOR,\n      (variantId) => {\n        if (!variantId) return;\n        logger.debug({ variantId }, 'Variant change detected');\n        markVariantSwitch(container, variantId);\n      },\n      (sellingPlanId) => {\n        // Re-process on selling plan change\n        const productId = findProductId(container);\n        if (productId) {\n          applyDiscountsToProduct(container, productId);\n        }\n      }\n    );\n\n    logger.debug('Attached variant listeners');\n  } catch (err) {\n    logger.error({ err }, 'Error attaching variant listeners');\n  }\n}\n\n// ============================================================================\n// DOM Observer\n// ============================================================================\n\n/**\n * Setup MutationObserver to watch for new containers\n */\nfunction setupDOMObserver() {\n  try {\n    const observer = new MutationObserver((mutations) => {\n      for (const mutation of mutations) {\n        if (mutation.type !== 'childList') continue;\n\n        for (const node of mutation.addedNodes) {\n          if (node.nodeType !== Node.ELEMENT_NODE) continue;\n\n          // Check if node itself is a container\n          const isProductContainer = node.matches && node.matches(PRODUCT_CONTAINER_SELECTOR);\n          const isFormContainerMatch = node.matches && node.matches(FORM_CONTAINER_SELECTOR);\n\n          if (isProductContainer || isFormContainerMatch) {\n            logger.debug('New container detected via mutation');\n            const productId = findProductId(node);\n            if (productId) {\n              applyDiscountsToProduct(node, productId);\n              attachVariantListeners(node);\n            }\n          }\n\n          // Check descendants\n          if (node.querySelectorAll) {\n            const productContainers = node.querySelectorAll(PRODUCT_CONTAINER_SELECTOR);\n            const formContainers = node.querySelectorAll(FORM_CONTAINER_SELECTOR);\n\n            for (const container of [...productContainers, ...formContainers]) {\n              logger.debug('New container detected in subtree');\n              const productId = findProductId(container);\n              if (productId) {\n                applyDiscountsToProduct(container, productId);\n                attachVariantListeners(container);\n              }\n            }\n          }\n        }\n      }\n    });\n\n    observer.observe(document.body, {\n      childList: true,\n      subtree: true\n    });\n\n    logger.info('DOM observer initialized');\n  } catch (err) {\n    logger.error({ err }, 'Error setting up DOM observer');\n  }\n}\n\n// ============================================================================\n// Heartbeat\n// ============================================================================\n\n/**\n * Setup heartbeat div for monitoring\n */\nfunction setupHeartbeat() {\n  try {\n    let heartbeatDiv = document.getElementById('discount-heartbeat');\n\n    if (!heartbeatDiv) {\n      heartbeatDiv = document.createElement('div');\n      heartbeatDiv.id = 'discount-heartbeat';\n      heartbeatDiv.style.display = 'none';\n      document.body.appendChild(heartbeatDiv);\n    }\n\n    function updateHeartbeat() {\n      heartbeatDiv.setAttribute('data-timestamp', Date.now().toString());\n    }\n\n    // Update immediately and then every 30s\n    updateHeartbeat();\n    setInterval(updateHeartbeat, 30000);\n\n    logger.info('Heartbeat initialized');\n  } catch (err) {\n    logger.error({ err }, 'Error setting up heartbeat');\n  }\n}\n\n// ============================================================================\n// Initialization\n// ============================================================================\n\n/**\n * Wait for Shopify.theme.name to be available\n */\nasync function waitForShopifyTheme(maxWaitMs = 3000) {\n  const startTime = Date.now();\n\n  while (Date.now() - startTime < maxWaitMs) {\n    if (typeof Shopify !== 'undefined' && Shopify.theme && Shopify.theme.name) {\n      logger.info({ themeName: Shopify.theme.name }, 'Shopify theme detected');\n      return true;\n    }\n\n    await new Promise(resolve => setTimeout(resolve, 100));\n  }\n\n  logger.warn('Shopify theme not detected within timeout');\n  return false;\n}\n\n/**\n * Main initialization function\n */\nasync function initialize() {\n  if (initializationAttempted) {\n    logger.warn('Initialization already attempted');\n    return;\n  }\n\n  initializationAttempted = true;\n  logger.info('Starting Discount Display Pro initialization');\n\n  try {\n    // Step 1: Wait for Shopify theme\n    await waitForShopifyTheme();\n\n    // Step 2: Wait for DOM\n    if (document.readyState === 'loading') {\n      await new Promise(resolve => {\n        document.addEventListener('DOMContentLoaded', resolve);\n      });\n    }\n\n    // Step 3: Ensure theme selectors ready\n    await ensureThemeSelectorsReady(4000);\n\n    // Step 4: Subscribe to theme selector updates\n    subscribeToThemeSelectorUpdates(() => {\n      logger.info('Theme selectors updated, reinitializing selectors');\n      initializeSelectors();\n\n      // Reapply to all containers\n      const containers = [\n        ...findProductContainers(),\n        ...findFormContainers()\n      ];\n\n      for (const container of containers) {\n        const productId = findProductId(container);\n        if (productId) {\n          applyDiscountsToProduct(container, productId);\n        }\n      }\n    });\n\n    // Step 5: Initialize selectors\n    initializeSelectors();\n\n    // Step 6: Initialize coupon state\n    initCouponState();\n\n    // Step 7: Load all products from database\n    await loadAllProductsFromDatabase();\n\n    // Step 8: Find all containers\n    const productContainers = findProductContainers();\n    const formContainers = findFormContainers();\n    const allContainers = [...productContainers, ...formContainers];\n\n    logger.info({ totalContainers: allContainers.length }, 'Found containers');\n\n    // Step 9: Apply discounts to each container\n    for (const container of allContainers) {\n      const productId = findProductId(container);\n      if (productId) {\n        applyDiscountsToProduct(container, productId);\n        attachVariantListeners(container);\n      }\n    }\n\n    // Step 10: Setup MutationObserver\n    setupDOMObserver();\n\n    // Step 11: Setup heartbeat\n    setupHeartbeat();\n\n    // Mark complete\n    initializationComplete = true;\n    logger.info('Discount Display Pro initialization complete');\n  } catch (err) {\n    logger.error({ err }, 'Error during initialization');\n  }\n}\n\n// ============================================================================\n// Global API Exposure\n// ============================================================================\n\n/**\n * Format date helper (for terms modal, etc.)\n */\nfunction formatDate(dateString) {\n  if (!dateString) return '';\n\n  try {\n    const date = new Date(dateString);\n    return date.toLocaleDateString(undefined, {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric'\n    });\n  } catch (err) {\n    return dateString;\n  }\n}\n\n/**\n * Build discount URL with return_to parameter\n */\nfunction buildDiscountUrlWithReturnTo(code) {\n  const currentUrl = window.location.href;\n  const returnToUrl = encodeURIComponent(currentUrl);\n  return `/discount/${encodeURIComponent(code)}?return_to=${returnToUrl}`;\n}\n\n// Expose APIs on window\n_ns.ui = {\n  createPriceContainer,\n  createCouponBlock,\n  showTermsModal\n};\n\n_ns.cards = {\n  createAutomaticDiscountDisplay,\n  createCouponBadge\n};\n\n_ns.forms = {\n  renderPPFormUI: renderFormUI,\n  applyDiscountCode,\n  buildDiscountUrlWithReturnTo\n};\n\n_ns.utils = {\n  formatPrice,\n  formatDate,\n  parsePrice,\n  calculateDiscountedPrice,\n  clearExistingDiscounts,\n  requestBestDiscounts\n};\n\n// Logger already exposed in logger.js but reinforce here\n_ns.logger = logger;\n\n// Expose initialization state for debugging\n_ns.state = {\n  get initializationComplete() { return initializationComplete; },\n  get products() { return products; },\n  get selectors() { return SELECTOR_RESOLUTION; }\n};\n\n// ============================================================================\n// Entry Point\n// ============================================================================\n\n// Auto-initialize\nif (typeof window !== 'undefined') {\n  // Start initialization immediately if DOM is ready, otherwise wait\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', initialize);\n  } else {\n    initialize();\n  }\n}\n\nexport default {\n  initialize,\n  applyDiscountsToProduct,\n  clearExistingDiscounts,\n  findProductContainers,\n  findFormContainers,\n  mergeDiscountData\n};\n", "/**\n * App namespace reference.\n * All shared state lives under window[\"discounts-display-pro\"].\n * This key is not auto-discoverable in browser DevTools autocomplete.\n */\nexport default window[\"discounts-display-pro\"];\n", "/**\n * Client-side logger for Discount Display Pro theme extension\n * Exposed as window[\"discounts-display-pro\"].logger\n */\n\nimport _ns from './namespace.js';\n\nconst LOG_LEVELS = {\n  debug: 0,\n  info: 1,\n  warn: 2,\n  error: 3\n};\n\nconst CATEGORIES = {\n  Forms: 'Forms',\n  Cards: 'Cards',\n  General: 'General',\n  PPBlock: 'PPBlock'\n};\n\n// Category aliases for convenience\nconst CATEGORY_ALIASES = {\n  forms: 'Forms',\n  form: 'Forms',\n  cards: 'Cards',\n  card: 'Cards',\n  pp: 'PPBlock',\n  productpage: 'PPBlock',\n  general: 'General'\n};\n\nclass Logger {\n  constructor() {\n    this.enabled = true;\n    this.minLevel = this._getInitialLevel();\n    this.allowedCategories = new Set(Object.values(CATEGORIES));\n  }\n\n  /**\n   * Get initial log level from _ns.logLevel or localStorage\n   */\n  _getInitialLevel() {\n    try {\n      // First check _ns.logLevel\n      if (typeof window !== 'undefined' && _ns && _ns.logLevel) {\n        const level = _ns.logLevel.toLowerCase();\n        if (LOG_LEVELS.hasOwnProperty(level)) {\n          return LOG_LEVELS[level];\n        }\n      }\n\n      // Then check localStorage\n      if (typeof localStorage !== 'undefined') {\n        const storedLevel = localStorage.getItem('wf_discount_log_level');\n        if (storedLevel && LOG_LEVELS.hasOwnProperty(storedLevel.toLowerCase())) {\n          return LOG_LEVELS[storedLevel.toLowerCase()];\n        }\n      }\n    } catch (error) {\n      // Silent fail if localStorage is not available\n    }\n\n    return LOG_LEVELS.info; // Default level\n  }\n\n  /**\n   * Normalize category name using aliases\n   */\n  _normalizeCategory(category) {\n    if (!category) return CATEGORIES.General;\n    const lower = category.toLowerCase();\n    return CATEGORY_ALIASES[lower] || CATEGORIES[category] || CATEGORIES.General;\n  }\n\n  /**\n   * Check if logging should proceed for given level and category\n   */\n  _shouldLog(level, category) {\n    if (!this.enabled) return false;\n    if (LOG_LEVELS[level] < this.minLevel) return false;\n\n    const normalizedCategory = this._normalizeCategory(category);\n    return this.allowedCategories.has(normalizedCategory);\n  }\n\n  /**\n   * Main logging method\n   */\n  log(message, data = null, type = 'info', category = 'General') {\n    const normalizedCategory = this._normalizeCategory(category);\n\n    if (!this._shouldLog(type, normalizedCategory)) return;\n\n    try {\n      const prefix = `[${normalizedCategory}][${type.toUpperCase()}]`;\n      const consoleMethod = console[type] || console.log;\n\n      if (data !== null && data !== undefined) {\n        consoleMethod.call(console, prefix, message, data);\n      } else {\n        consoleMethod.call(console, prefix, message);\n      }\n    } catch (error) {\n      // Silent fail - don't let logging break the app\n    }\n  }\n\n  /**\n   * Log an error with context\n   */\n  logError(error, context = '', category = 'General') {\n    const normalizedCategory = this._normalizeCategory(category);\n\n    if (!this._shouldLog('error', normalizedCategory)) return;\n\n    try {\n      const prefix = `[${normalizedCategory}][ERROR]`;\n\n      if (context) {\n        console.error(prefix, context, error);\n      } else {\n        console.error(prefix, error);\n      }\n    } catch (err) {\n      // Silent fail\n    }\n  }\n\n  /**\n   * Log a warning with details\n   */\n  logWarning(message, details = null, category = 'General') {\n    const normalizedCategory = this._normalizeCategory(category);\n\n    if (!this._shouldLog('warn', normalizedCategory)) return;\n\n    try {\n      const prefix = `[${normalizedCategory}][WARN]`;\n\n      if (details !== null && details !== undefined) {\n        console.warn(prefix, message, details);\n      } else {\n        console.warn(prefix, message);\n      }\n    } catch (error) {\n      // Silent fail\n    }\n  }\n\n  /**\n   * Convenience methods for specific log levels\n   */\n  debug(message, data = null, category = 'General') {\n    this.log(message, data, 'debug', category);\n  }\n\n  info(message, data = null, category = 'General') {\n    this.log(message, data, 'info', category);\n  }\n\n  warn(message, data = null, category = 'General') {\n    this.log(message, data, 'warn', category);\n  }\n\n  error(message, data = null, category = 'General') {\n    this.log(message, data, 'error', category);\n  }\n\n  /**\n   * Set minimum log level\n   */\n  setMinLevel(level) {\n    const levelLower = level.toLowerCase();\n    if (LOG_LEVELS.hasOwnProperty(levelLower)) {\n      this.minLevel = LOG_LEVELS[levelLower];\n\n      try {\n        if (typeof localStorage !== 'undefined') {\n          localStorage.setItem('wf_discount_log_level', levelLower);\n        }\n      } catch (error) {\n        // Silent fail\n      }\n    }\n  }\n\n  /**\n   * Set allowed categories\n   */\n  setAllowedCategories(categories) {\n    if (Array.isArray(categories)) {\n      this.allowedCategories = new Set(\n        categories.map(cat => this._normalizeCategory(cat))\n      );\n    }\n  }\n\n  /**\n   * Convenience toggles for specific categories\n   */\n  onlyForms() {\n    this.setAllowedCategories(['Forms']);\n    return this;\n  }\n\n  onlyCards() {\n    this.setAllowedCategories(['Cards']);\n    return this;\n  }\n\n  onlyPP() {\n    this.setAllowedCategories(['PPBlock']);\n    return this;\n  }\n\n  onlyGeneral() {\n    this.setAllowedCategories(['General']);\n    return this;\n  }\n\n  all() {\n    this.setAllowedCategories(Object.values(CATEGORIES));\n    return this;\n  }\n}\n\n// Create and export singleton instance\nexport const logger = new Logger();\n\n// Expose on window for global access\nif (typeof window !== 'undefined') {\n  _ns.logger = logger;\n}\n", "/**\n * Hidden Element Detector\n *\n * CRITICAL: This checks visibility using INLINE STYLES ONLY, NOT getComputedStyle().\n *\n * WHY: The app hides the price container itself (priceEl.style.display = 'none')\n * to render its own UI. If getComputedStyle() were used, ALL children would appear\n * hidden because the parent is hidden. By checking only inline styles, we can\n * distinguish what the THEME has hidden vs what the APP has hidden.\n */\n\n/**\n * Check if an element is hidden within a boundary container\n * @param {HTMLElement} el - Element to check\n * @param {HTMLElement} boundary - Boundary container (not checked itself)\n * @returns {boolean} - True if element is hidden, false if visible\n */\nexport function isHiddenWithinBoundary(el, boundary) {\n  // Return true for null/undefined elements\n  if (!el) return true;\n\n  // Safety check for boundary\n  if (!boundary) {\n    boundary = document.body;\n  }\n\n  try {\n    let current = el;\n\n    // Walk up the DOM tree from el to boundary (exclusive)\n    while (current && current !== boundary && current !== document.body && current !== document.documentElement) {\n\n      // Check inline style for display: none\n      if (current.style && current.style.display === 'none') {\n        return true;\n      }\n\n      // Check inline style for visibility: hidden\n      if (current.style && current.style.visibility === 'hidden') {\n        return true;\n      }\n\n      // Check for screen reader / visually hidden classes\n      if (current.className) {\n        // Handle SVGAnimatedString (SVG elements have className as object)\n        const classNameStr = typeof current.className === 'string'\n          ? current.className\n          : (current.className.baseVal || '');\n\n        if (classNameStr.includes('visually-hidden') ||\n            classNameStr.includes('sr-only') ||\n            classNameStr.includes('screen-reader')) {\n          return true;\n        }\n      }\n\n      // Move to parent\n      current = current.parentElement;\n    }\n\n    return false;\n  } catch (error) {\n    // On error, assume visible to avoid breaking functionality\n    return false;\n  }\n}\n\n/**\n * Alias for isHiddenWithinBoundary - used by getCleanPriceText\n * @param {HTMLElement} el - Element to check\n * @param {HTMLElement} container - Container boundary\n * @returns {boolean} - True if element is hidden\n */\nexport function isElementHiddenWithinContainer(el, container) {\n  return isHiddenWithinBoundary(el, container);\n}\n", "import _ns from './namespace.js';\n\n/**\n * Currency Formatter and Price Parser\n *\n * Four-tier price formatting fallback:\n * 1. Shopify.formatMoney if currency matches base currency\n * 2. Detected DOM prefix/suffix\n * 3. Presentment currency symbol\n * 4. Intl.NumberFormat\n */\n\nimport { logger } from './logger.js';\n\n/**\n * Detect money format from a price text sample\n * @param {string} text - Price text to analyze\n * @returns {string} - 'european' or 'us'\n */\nfunction detectMoneyFormat(text) {\n  try {\n    // Remove currency symbols and letters\n    const cleaned = text.replace(/[^\\d.,]/g, '');\n\n    // European format: comma as decimal separator (e.g., 1.234,56)\n    if (/,\\d{2}$/.test(cleaned)) {\n      return 'european';\n    }\n\n    // US format: dot as decimal separator (e.g., 1,234.56)\n    if (/\\.\\d{2}$/.test(cleaned)) {\n      return 'us';\n    }\n\n    // Check for European thousands separator (dot with 3 digits after)\n    if (/\\.\\d{3}/.test(cleaned) && !/\\.\\d{2}$/.test(cleaned)) {\n      return 'european';\n    }\n\n    // Default to US format\n    return 'us';\n  } catch (error) {\n    logger.logError(error, 'Error detecting money format', 'General');\n    return 'us';\n  }\n}\n\n/**\n * Format price with four-tier fallback\n * @param {number} priceInCents - Price in cents\n * @param {boolean} includeCurrencyCode - Whether to include currency code\n * @returns {string} - Formatted price string\n */\nexport function formatPrice(priceInCents, includeCurrencyCode = false) {\n  try {\n    const priceInDollars = priceInCents / 100;\n\n    // Tier 1: Shopify.formatMoney if available and currency matches\n    if (typeof window !== 'undefined' && window.Shopify && window.Shopify.formatMoney) {\n      try {\n        const format = includeCurrencyCode\n          ? (_ns?.shopMoneyWithCurrencyFormat || _ns?.shopMoneyFormat || '{{amount}}')\n          : (_ns?.shopMoneyFormat || '{{amount}}');\n\n        // Shopify.formatMoney expects cents\n        return window.Shopify.formatMoney(priceInCents, format);\n      } catch (error) {\n        logger.logError(error, 'Shopify.formatMoney failed', 'General');\n      }\n    }\n\n    // Format the numeric value\n    const formatted = priceInDollars.toFixed(2);\n\n    // Tier 2: Detected DOM prefix/suffix\n    if (typeof window !== 'undefined' && _ns &&\n        (_ns._currencyPrefix || _ns._currencySuffix)) {\n      const prefix = _ns._currencyPrefix || '';\n      const suffix = _ns._currencySuffix || '';\n      return `${prefix}${formatted}${suffix}`;\n    }\n\n    // Tier 3: Presentment currency symbol\n    if (typeof window !== 'undefined') {\n      const symbol = (_ns && _ns.currencySymbol) ||\n                    (_ns && _ns.currencySymbols && _ns.currencySymbols[window.Currency]) ||\n                    '$';\n      return `${symbol}${formatted}`;\n    }\n\n    // Tier 4: Intl.NumberFormat fallback\n    try {\n      if (typeof Intl !== 'undefined' && Intl.NumberFormat) {\n        const currency = (typeof window !== 'undefined' && window.Currency) || 'USD';\n        const formatter = new Intl.NumberFormat('en-US', {\n          style: 'currency',\n          currency: currency,\n          minimumFractionDigits: 2,\n          maximumFractionDigits: 2\n        });\n        return formatter.format(priceInDollars);\n      }\n    } catch (error) {\n      logger.logError(error, 'Intl.NumberFormat failed', 'General');\n    }\n\n    // Final fallback: simple format\n    return `$${formatted}`;\n\n  } catch (error) {\n    logger.logError(error, 'Error formatting price', 'General');\n    return `$${(priceInCents / 100).toFixed(2)}`;\n  }\n}\n\n/**\n * Parse price text to cents\n * @param {string} text - Price text to parse\n * @returns {number|null} - Price in cents, or null if parsing fails\n */\nexport function parsePrice(text) {\n  if (!text || typeof text !== 'string') return null;\n\n  try {\n    // Remove common labels\n    let cleaned = text.trim()\n      .replace(/\\bfrom\\b/gi, '')\n      .replace(/\\beach\\b/gi, '')\n      .replace(/\\bper item\\b/gi, '')\n      .replace(/\\bper\\b/gi, '');\n\n    // Remove currency codes (3 uppercase letters)\n    cleaned = cleaned.replace(/\\b[A-Z]{3}\\b/g, '');\n\n    // Detect format\n    const format = detectMoneyFormat(cleaned);\n\n    // Extract numeric part with decimal/thousand separators\n    let match;\n    if (format === 'european') {\n      // European: 1.234,56 or 1234,56\n      match = cleaned.match(/[\\d.]+,\\d{2}/);\n      if (match) {\n        // Replace dots (thousands) and comma (decimal)\n        const normalized = match[0].replace(/\\./g, '').replace(',', '.');\n        const priceInDollars = parseFloat(normalized);\n        if (!isNaN(priceInDollars)) {\n          return Math.round(priceInDollars * 100);\n        }\n      }\n    } else {\n      // US format: 1,234.56 or 1234.56\n      match = cleaned.match(/[\\d,]+\\.\\d{2}|[\\d,]+/);\n      if (match) {\n        // Remove commas (thousands)\n        const normalized = match[0].replace(/,/g, '');\n        const priceInDollars = parseFloat(normalized);\n        if (!isNaN(priceInDollars)) {\n          return Math.round(priceInDollars * 100);\n        }\n      }\n    }\n\n    // Fallback: extract any decimal number\n    match = cleaned.match(/\\d+\\.?\\d*/);\n    if (match) {\n      const priceInDollars = parseFloat(match[0]);\n      if (!isNaN(priceInDollars)) {\n        return Math.round(priceInDollars * 100);\n      }\n    }\n\n    return null;\n  } catch (error) {\n    logger.logError(error, 'Error parsing price', 'General');\n    return null;\n  }\n}\n\n/**\n * Check if price text contains a currency code\n * @param {string} text - Price text to check\n * @returns {boolean} - True if currency code is present\n */\nexport function hasCurrencyCode(text) {\n  if (!text || typeof text !== 'string') return false;\n\n  try {\n    // Match 3 uppercase letters (currency code pattern)\n    return /\\b[A-Z]{3}\\b/.test(text);\n  } catch (error) {\n    return false;\n  }\n}\n\n/**\n * Extract currency format (prefix/suffix) from price text\n * @param {string} priceText - Price text to analyze\n * @returns {Object} - {prefix, suffix}\n */\nexport function extractCurrencyFormat(priceText) {\n  if (!priceText || typeof priceText !== 'string') {\n    return { prefix: '', suffix: '' };\n  }\n\n  try {\n    // Find numeric part\n    const numericMatch = priceText.match(/[\\d.,]+/);\n    if (!numericMatch) {\n      return { prefix: '', suffix: '' };\n    }\n\n    const numericPart = numericMatch[0];\n    const numericIndex = priceText.indexOf(numericPart);\n\n    const prefix = priceText.substring(0, numericIndex).trim();\n    const suffix = priceText.substring(numericIndex + numericPart.length).trim();\n\n    // Store in window for reuse\n    if (typeof window !== 'undefined') {\n      if (prefix) _ns._currencyPrefix = prefix;\n      if (suffix) _ns._currencySuffix = suffix;\n    }\n\n    return { prefix, suffix };\n  } catch (error) {\n    logger.logError(error, 'Error extracting currency format', 'General');\n    return { prefix: '', suffix: '' };\n  }\n}\n\n/**\n * Calculate discounted price\n * @param {number} regularPrice - Regular price in cents\n * @param {Object} discount - Discount object with type and value\n * @returns {number} - Discounted price in cents\n */\nexport function calculateDiscountedPrice(regularPrice, discount) {\n  if (!discount || !discount.type) return regularPrice;\n\n  try {\n    let discountAmount = 0;\n\n    if (discount.type === 'percentage') {\n      const percentage = discount.value || 0;\n      discountAmount = Math.floor(regularPrice * percentage / 100);\n    } else if (discount.type === 'fixed') {\n      discountAmount = Math.min(discount.value || 0, regularPrice);\n    }\n\n    return Math.max(0, regularPrice - discountAmount);\n  } catch (error) {\n    logger.logError(error, 'Error calculating discounted price', 'General');\n    return regularPrice;\n  }\n}\n\n/**\n * Format date string\n * @param {string} dateString - ISO date string\n * @returns {string} - Formatted date\n */\nexport function formatDate(dateString) {\n  try {\n    return new Date(dateString).toLocaleDateString('en-US', {\n      year: 'numeric',\n      month: 'long',\n      day: 'numeric'\n    });\n  } catch (error) {\n    logger.logError(error, 'Error formatting date', 'General');\n    return dateString;\n  }\n}\n", "import { logger } from './logger.js';\nimport _ns from './namespace.js';\n\nconst DEFAULT_THEME = 'dawn';\n\n/**\n * Normalize theme name to match server-side logic\n * @param {string} themeName - Raw theme name from Shopify.theme.name\n * @returns {string} Normalized theme name\n */\nexport function normalizeThemeName(themeName) {\n  if (!themeName || typeof themeName !== 'string') {\n    return DEFAULT_THEME;\n  }\n\n  let normalized = themeName.toLowerCase().trim();\n\n  // Strip \" - \" suffix and everything after\n  const dashIndex = normalized.indexOf(' - ');\n  if (dashIndex !== -1) {\n    normalized = normalized.substring(0, dashIndex);\n  }\n\n  // Strip \"(\" suffix and everything after\n  const parenIndex = normalized.indexOf('(');\n  if (parenIndex !== -1) {\n    normalized = normalized.substring(0, parenIndex);\n  }\n\n  // Strip \"[\" suffix and everything after\n  const bracketIndex = normalized.indexOf('[');\n  if (bracketIndex !== -1) {\n    normalized = normalized.substring(0, bracketIndex);\n  }\n\n  normalized = normalized.trim();\n\n  // Remove trailing keywords\n  const trailingKeywords = [\n    'preview', 'live', 'published', 'unpublished',\n    'development', 'dev', 'draft', 'staging', 'test',\n    'copy', 'duplicate', 'backup'\n  ];\n\n  for (const keyword of trailingKeywords) {\n    const pattern = new RegExp(`\\\\s+${keyword}$`, 'i');\n    normalized = normalized.replace(pattern, '');\n  }\n\n  // Remove \"copy\" followed by optional digits\n  normalized = normalized.replace(/\\s+copy\\s*\\d*$/i, '');\n\n  // Remove version numbers: v1, v2.0, 1.2.3\n  normalized = normalized.replace(/\\s+v?\\d+(\\.\\d+)*$/i, '');\n\n  normalized = normalized.trim();\n\n  return normalized || DEFAULT_THEME;\n}\n\n/**\n * Extract normalized theme ID (last numeric sequence)\n * @param {string|number} themeId - Raw theme ID\n * @returns {string|null} Normalized theme ID or null\n */\nexport function normalizeThemeId(themeId) {\n  if (!themeId) return null;\n\n  const str = String(themeId);\n  const matches = str.match(/\\d+/g);\n\n  if (!matches || matches.length === 0) {\n    return null;\n  }\n\n  return matches[matches.length - 1];\n}\n\n/**\n * Normalize schema name\n * @param {string} schemaName - Raw schema name\n * @returns {string|null} Normalized schema name or null\n */\nexport function normalizeSchemaName(schemaName) {\n  if (!schemaName || typeof schemaName !== 'string') {\n    return null;\n  }\n\n  const normalized = schemaName.toLowerCase().trim();\n  return normalized || null;\n}\n\n/**\n * Normalize theme store ID\n * @param {string|number} storeId - Raw store ID\n * @returns {string|null} Normalized store ID or null\n */\nexport function normalizeThemeStoreId(storeId) {\n  if (!storeId) return null;\n\n  const num = Number(storeId);\n  if (isNaN(num)) return null;\n\n  return String(Math.trunc(num));\n}\n\n/**\n * Sanitize base URL (remove trailing slash)\n * @param {string} url - Base URL\n * @returns {string} Sanitized URL\n */\nfunction sanitizeBaseUrl(url) {\n  if (!url || typeof url !== 'string') {\n    logger.error({ url }, 'Invalid base URL');\n    return '';\n  }\n  return url.replace(/\\/$/, '');\n}\n\n/**\n * Build theme selectors endpoint URL\n * @param {string} themeName - Normalized theme name\n * @param {string|null} themeId - Normalized theme ID\n * @param {string|null} schemaName - Normalized schema name\n * @param {string|null} storeId - Normalized store ID\n * @returns {string} Complete endpoint URL\n */\nfunction buildThemeSelectorsUrl(themeName, themeId, schemaName, storeId) {\n  const base = sanitizeBaseUrl(_ns.apiBaseUrl || '');\n  if (!base) {\n    logger.error({}, 'DISCOUNT_API_BASE_URL not configured');\n    return null;\n  }\n\n  const path = `${base}/api/theme-selectors`;\n  const params = new URLSearchParams();\n\n  if (themeName) params.append('theme', themeName);\n  if (themeId) params.append('themeId', themeId);\n  if (schemaName) params.append('schemaName', schemaName);\n  if (storeId) params.append('themeStoreId', storeId);\n\n  return `${path}?${params.toString()}`;\n}\n\n/**\n * Global state for theme selectors\n */\nif (!_ns._themeState) {\n  _ns._themeState = {\n    selectors: null,\n    fallbackSelectors: null,\n    resolvedTheme: null,\n    usedFallback: false,\n    isReady: false,\n    listeners: [],\n    cache: new Map(),\n  };\n}\n\n/**\n * Apply payload from theme selectors API\n * @param {object} data - Response data\n */\nfunction applyPayload(data) {\n  if (!data) return;\n\n  const state = _ns._themeState;\n\n  // Initialize THEME_SELECTORS if needed\n  if (!_ns.themeSelectors) {\n    _ns.themeSelectors = {};\n  }\n\n  // Store selectors by theme name\n  if (data.theme && data.selectors) {\n    _ns.themeSelectors[data.theme] = data.selectors;\n    state.resolvedTheme = data.theme;\n    state.selectors = data.selectors;\n  }\n\n  // Store fallback selectors\n  if (data.fallbackSelectors) {\n    state.fallbackSelectors = data.fallbackSelectors;\n  }\n\n  state.usedFallback = data.usedFallback || false;\n  state.isReady = true;\n\n  logger.info({\n    theme: data.theme,\n    usedFallback: state.usedFallback,\n    selectorCount: Object.keys(data.selectors || {}).length\n  }, 'Theme selectors applied');\n}\n\n/**\n * Handle fetch error\n * @param {Error} error - Error object\n * @returns {object} Error result\n */\nfunction handleFetchError(error) {\n  logger.error({ err: error }, 'Failed to fetch theme selectors');\n\n  return {\n    usedFallback: true,\n    selectors: null,\n  };\n}\n\n/**\n * Notify all registered listeners\n */\nfunction notifyListeners() {\n  const state = _ns._themeState;\n  const listeners = [...state.listeners];\n\n  listeners.forEach((callback) => {\n    try {\n      callback({\n        isReady: state.isReady,\n        resolvedTheme: state.resolvedTheme,\n        usedFallback: state.usedFallback,\n      });\n    } catch (err) {\n      logger.error({ err }, 'Error in theme selector listener');\n    }\n  });\n}\n\n/**\n * Fetch theme selectors from backend\n * @param {string} themeName - Raw theme name\n * @param {string|number} themeId - Raw theme ID\n * @param {string} schemaName - Raw schema name\n * @param {string|number} storeId - Raw store ID\n * @returns {Promise<object>} Theme selectors data\n */\nexport async function fetchThemeSelectors(themeName, themeId, schemaName, storeId) {\n  const state = _ns._themeState;\n\n  // Normalize parameters\n  const normalizedTheme = normalizeThemeName(themeName);\n  const normalizedId = normalizeThemeId(themeId);\n  const normalizedSchema = normalizeSchemaName(schemaName);\n  const normalizedStoreId = normalizeThemeStoreId(storeId);\n\n  // Create cache key\n  const cacheKey = normalizedId || normalizedTheme;\n\n  // Check cache\n  if (state.cache.has(cacheKey)) {\n    logger.info({ cacheKey }, 'Returning cached theme selectors promise');\n    return state.cache.get(cacheKey);\n  }\n\n  // Create fetch promise\n  const fetchPromise = (async () => {\n    try {\n      const url = buildThemeSelectorsUrl(\n        normalizedTheme,\n        normalizedId,\n        normalizedSchema,\n        normalizedStoreId\n      );\n\n      if (!url) {\n        const result = handleFetchError(new Error('Could not build theme selectors URL'));\n        notifyListeners();\n        return result;\n      }\n\n      logger.info({\n        theme: normalizedTheme,\n        themeId: normalizedId,\n        schemaName: normalizedSchema,\n        storeId: normalizedStoreId,\n      }, 'Fetching theme selectors');\n\n      const response = await fetch(url, {\n        method: 'GET',\n        credentials: 'omit',\n        headers: {\n          'Accept': 'application/json',\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json();\n\n      // Apply payload\n      applyPayload(data);\n\n      // Notify listeners\n      notifyListeners();\n\n      return data;\n    } catch (error) {\n      const result = handleFetchError(error);\n      notifyListeners();\n      return result;\n    }\n  })();\n\n  // Store in cache\n  state.cache.set(cacheKey, fetchPromise);\n\n  return fetchPromise;\n}\n\n/**\n * Register listener for theme selectors resolution\n * @param {Function} callback - Callback function\n */\nexport function onThemeSelectorsResolved(callback) {\n  if (typeof callback !== 'function') {\n    logger.error({}, 'onThemeSelectorsResolved: callback must be a function');\n    return;\n  }\n\n  const state = _ns._themeState;\n\n  // If already resolved, call immediately\n  if (state.isReady) {\n    try {\n      callback({\n        isReady: true,\n        resolvedTheme: state.resolvedTheme,\n        usedFallback: state.usedFallback,\n      });\n    } catch (err) {\n      logger.error({ err }, 'Error in immediate theme selector callback');\n    }\n  }\n\n  // Add to listeners for future updates\n  state.listeners.push(callback);\n}\n\n/**\n * Pick theme-specific selector with fallback chain\n * @param {string} themeName - Theme name\n * @param {string} key - Selector key\n * @param {any} fallbackValue - Final fallback value\n * @returns {object} { value, source } object\n */\nexport function pickThemeSelector(themeName, key, fallbackValue) {\n  const normalizedTheme = normalizeThemeName(themeName);\n  const state = _ns._themeState;\n\n  // 1. Check theme-specific selectors in THEME_SELECTORS\n  if (_ns.themeSelectors && _ns.themeSelectors[normalizedTheme]) {\n    const value = _ns.themeSelectors[normalizedTheme][key];\n    if (value !== undefined && value !== null) {\n      return { value, source: `theme:${normalizedTheme}` };\n    }\n  }\n\n  // 2. Check state selectors (current theme)\n  if (state.selectors && state.selectors[key] !== undefined && state.selectors[key] !== null) {\n    return { value: state.selectors[key], source: 'state' };\n  }\n\n  // 3. Check fallback selectors from backend\n  if (state.fallbackSelectors && state.fallbackSelectors[key] !== undefined && state.fallbackSelectors[key] !== null) {\n    return { value: state.fallbackSelectors[key], source: 'fallback-backend' };\n  }\n\n  // 4. Check Dawn selectors\n  if (_ns.themeSelectors && _ns.themeSelectors[DEFAULT_THEME]) {\n    const value = _ns.themeSelectors[DEFAULT_THEME][key];\n    if (value !== undefined && value !== null) {\n      return { value, source: `theme:${DEFAULT_THEME}` };\n    }\n  }\n\n  // 5. Return provided fallback\n  return { value: fallbackValue, source: 'fallback' };\n}\n\n/**\n * Ensure theme selectors are ready or timeout\n * @param {number} timeoutMs - Timeout in milliseconds\n * @returns {Promise<boolean>} True if ready, false if timeout\n */\nexport function ensureThemeSelectorsReady(timeoutMs = 4000) {\n  const state = _ns._themeState;\n\n  // Already ready\n  if (state.isReady) {\n    return Promise.resolve(true);\n  }\n\n  // Wait for promise or timeout\n  return new Promise((resolve) => {\n    const timeoutId = setTimeout(() => {\n      logger.warn({ timeoutMs }, 'Theme selectors ready timeout');\n      resolve(false);\n    }, timeoutMs);\n\n    // Subscribe to updates\n    const unsubscribe = subscribeToThemeSelectorUpdates((status) => {\n      if (status.isReady) {\n        clearTimeout(timeoutId);\n        resolve(true);\n      }\n    });\n\n    // Also check if promise exists\n    if (_ns._themePromise) {\n      _ns._themePromise\n        .then(() => {\n          if (state.isReady) {\n            clearTimeout(timeoutId);\n            resolve(true);\n          }\n        })\n        .catch((err) => {\n          logger.error({ err }, 'Theme selectors promise rejected');\n        });\n    }\n  });\n}\n\n/**\n * Subscribe to theme selector updates\n * @param {Function} callback - Callback function\n * @returns {Function} Unsubscribe function\n */\nexport function subscribeToThemeSelectorUpdates(callback) {\n  if (typeof callback !== 'function') {\n    logger.error({}, 'subscribeToThemeSelectorUpdates: callback must be a function');\n    return () => {};\n  }\n\n  const state = _ns._themeState;\n  state.listeners.push(callback);\n\n  // Return unsubscribe function\n  return () => {\n    const index = state.listeners.indexOf(callback);\n    if (index > -1) {\n      state.listeners.splice(index, 1);\n    }\n  };\n}\n\n/**\n * Auto-detect and fetch theme selectors on load\n */\nfunction autoDetectTheme() {\n  try {\n    // Read from Shopify global\n    const shopifyTheme = window.Shopify?.theme;\n\n    if (!shopifyTheme) {\n      logger.warn({}, 'Shopify.theme not available, using default theme');\n      _ns._themePromise = fetchThemeSelectors(DEFAULT_THEME, null, null, null);\n      return;\n    }\n\n    const themeName = shopifyTheme.name || DEFAULT_THEME;\n    const themeId = shopifyTheme.id || null;\n    const schemaName = shopifyTheme.schema_name || null;\n    const storeId = shopifyTheme.theme_store_id || null;\n\n    logger.info({\n      themeName,\n      themeId,\n      schemaName,\n      storeId,\n    }, 'Auto-detected theme');\n\n    // Kick off fetch\n    _ns._themePromise = fetchThemeSelectors(themeName, themeId, schemaName, storeId);\n  } catch (error) {\n    logger.error({ err: error }, 'Error in auto-detect theme');\n    _ns._themePromise = fetchThemeSelectors(DEFAULT_THEME, null, null, null);\n  }\n}\n\n// Auto-detect on module load\nif (typeof window !== 'undefined') {\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', autoDetectTheme);\n  } else {\n    autoDetectTheme();\n  }\n}\n", "import { logger } from './logger.js';\nimport _ns from './namespace.js';\n\n/**\n * Resolve shop domain from various sources\n * @returns {string|null} Shop domain or null\n */\nexport function resolveShopDomain() {\n  // 1. Check cached value\n  if (_ns._shopDomain) {\n    return _ns._shopDomain;\n  }\n\n  // 2. Check Shopify.shop global\n  if (window.Shopify?.shop) {\n    _ns._shopDomain = window.Shopify.shop;\n    return _ns._shopDomain;\n  }\n\n  // 3. Parse from hostname (*.myshopify.com)\n  try {\n    const hostname = window.location.hostname;\n    if (hostname.endsWith('.myshopify.com')) {\n      _ns._shopDomain = hostname;\n      return _ns._shopDomain;\n    }\n\n    // Custom domain - try to extract from Shopify Checkout or other sources\n    // For now, return null if we can't determine\n    logger.warn({ hostname }, 'Could not resolve shop domain from hostname');\n    return null;\n  } catch (error) {\n    logger.error({ err: error }, 'Error resolving shop domain');\n    return null;\n  }\n}\n\n/**\n * Sanitize base URL (remove trailing slash)\n * @param {string} url - Base URL\n * @returns {string} Sanitized URL\n */\nfunction sanitizeBaseUrl(url) {\n  if (!url || typeof url !== 'string') {\n    logger.error({ url }, 'Invalid base URL');\n    return '';\n  }\n  return url.replace(/\\/$/, '');\n}\n\n/**\n * Build discounts API URL\n * @param {object} params - Query parameters\n * @returns {string|null} Complete endpoint URL or null\n */\nfunction buildDiscountsUrl(params) {\n  const base = sanitizeBaseUrl(_ns.apiBaseUrl || '');\n  if (!base) {\n    logger.error({}, 'DISCOUNT_API_BASE_URL not configured');\n    return null;\n  }\n\n  const path = `${base}/api/discounts`;\n  const queryParams = new URLSearchParams();\n\n  // Add all provided params\n  Object.keys(params).forEach((key) => {\n    const value = params[key];\n    if (value !== undefined && value !== null && value !== '') {\n      if (Array.isArray(value)) {\n        // Join arrays with comma\n        queryParams.append(key, value.join(','));\n      } else {\n        queryParams.append(key, String(value));\n      }\n    }\n  });\n\n  return `${path}?${queryParams.toString()}`;\n}\n\n/**\n * Build best discounts API URL\n * @returns {string|null} Complete endpoint URL or null\n */\nfunction buildBestDiscountsUrl() {\n  const base = sanitizeBaseUrl(_ns.apiBaseUrl || '');\n  if (!base) {\n    logger.error({}, 'DISCOUNT_API_BASE_URL not configured');\n    return null;\n  }\n\n  return `${base}/api/best-discounts`;\n}\n\n/**\n * Extract IDs from page context\n * @param {object} pageContext - Page context object\n * @returns {object} Extracted IDs\n */\nfunction extractIdsFromContext(pageContext) {\n  const productIds = [];\n  const variantIds = [];\n  const handles = [];\n\n  if (!pageContext) {\n    return { productIds, variantIds, handles };\n  }\n\n  // Extract from various context sources\n  if (pageContext.productId) {\n    productIds.push(pageContext.productId);\n  }\n\n  if (pageContext.variantId) {\n    variantIds.push(pageContext.variantId);\n  }\n\n  if (pageContext.handle) {\n    handles.push(pageContext.handle);\n  }\n\n  if (pageContext.productIds && Array.isArray(pageContext.productIds)) {\n    productIds.push(...pageContext.productIds);\n  }\n\n  if (pageContext.variantIds && Array.isArray(pageContext.variantIds)) {\n    variantIds.push(...pageContext.variantIds);\n  }\n\n  if (pageContext.handles && Array.isArray(pageContext.handles)) {\n    handles.push(...pageContext.handles);\n  }\n\n  // Deduplicate\n  return {\n    productIds: [...new Set(productIds)],\n    variantIds: [...new Set(variantIds)],\n    handles: [...new Set(handles)],\n  };\n}\n\n/**\n * Load discount data from backend\n * @param {object} pageContext - Page context with product/variant IDs\n * @returns {Promise<object|null>} Discount data or null\n */\nexport async function loadDiscountData(pageContext) {\n  try {\n    // Check if already fetching (deduplicate requests)\n    if (_ns._fetchPromise) {\n      logger.info({}, 'Reusing existing discounts fetch promise');\n      return await _ns._fetchPromise;\n    }\n\n    // Check if already cached\n    if (_ns._fetchCache) {\n      logger.info({}, 'Returning cached discount data');\n      return _ns._fetchCache;\n    }\n\n    // Resolve shop domain\n    const shop = resolveShopDomain();\n    if (!shop) {\n      logger.error({}, 'Cannot load discounts: shop domain not resolved');\n      return null;\n    }\n\n    // Get storefront token\n    const token = _ns.storefrontToken;\n    if (!token) {\n      logger.error({}, 'Cannot load discounts: DISCOUNT_STOREFRONT_TOKEN not configured');\n      return null;\n    }\n\n    // Extract IDs from context\n    const { productIds, variantIds, handles } = extractIdsFromContext(pageContext);\n\n    // Build URL\n    const url = buildDiscountsUrl({\n      shop,\n      productIds: productIds.length > 0 ? productIds : undefined,\n      variantIds: variantIds.length > 0 ? variantIds : undefined,\n      handles: handles.length > 0 ? handles : undefined,\n    });\n\n    if (!url) {\n      return null;\n    }\n\n    logger.info({\n      shop,\n      productCount: productIds.length,\n      variantCount: variantIds.length,\n      handleCount: handles.length,\n    }, 'Fetching discount data');\n\n    // Create fetch promise\n    const fetchPromise = (async () => {\n      try {\n        const response = await fetch(url, {\n          method: 'GET',\n          credentials: 'omit',\n          headers: {\n            'Accept': 'application/json',\n            'Authorization': `Bearer ${token}`,\n          },\n        });\n\n        if (!response.ok) {\n          throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n        }\n\n        const data = await response.json();\n\n        logger.info({\n          discountCount: data.discounts?.length || 0,\n          productCount: data.products?.length || 0,\n        }, 'Discount data loaded');\n\n        // Cache the data\n        _ns._fetchCache = data;\n\n        return data;\n      } catch (error) {\n        logger.error({ err: error }, 'Failed to load discount data');\n        return null;\n      } finally {\n        // Clear the promise so it can be retried\n        _ns._fetchPromise = null;\n      }\n    })();\n\n    // Store promise to deduplicate concurrent requests\n    _ns._fetchPromise = fetchPromise;\n\n    return await fetchPromise;\n  } catch (error) {\n    logger.error({ err: error }, 'Error in loadDiscountData');\n    return null;\n  }\n}\n\n/**\n * Fetch additional discount data for missing products\n * @param {object} options - Options object\n * @param {Array<string>} options.productIds - Product IDs\n * @param {Array<string>} options.handles - Product handles\n * @param {Array<string>} options.variantIds - Variant IDs\n * @returns {Promise<object>} Result object\n */\nexport async function fetchAdditionalDiscountData({ productIds = [], handles = [], variantIds = [] }) {\n  try {\n    // Resolve shop domain\n    const shop = resolveShopDomain();\n    if (!shop) {\n      logger.error({}, 'Cannot fetch additional discounts: shop domain not resolved');\n      return { success: false, hasData: false };\n    }\n\n    // Get storefront token\n    const token = _ns.storefrontToken;\n    if (!token) {\n      logger.error({}, 'Cannot fetch additional discounts: DISCOUNT_STOREFRONT_TOKEN not configured');\n      return { success: false, hasData: false };\n    }\n\n    // Check if we have any IDs to fetch\n    if (productIds.length === 0 && handles.length === 0 && variantIds.length === 0) {\n      logger.warn({}, 'No IDs provided for additional discount fetch');\n      return { success: true, hasData: false };\n    }\n\n    // Build URL\n    const url = buildDiscountsUrl({\n      shop,\n      productIds: productIds.length > 0 ? productIds : undefined,\n      variantIds: variantIds.length > 0 ? variantIds : undefined,\n      handles: handles.length > 0 ? handles : undefined,\n    });\n\n    if (!url) {\n      return { success: false, hasData: false };\n    }\n\n    logger.info({\n      shop,\n      productCount: productIds.length,\n      variantCount: variantIds.length,\n      handleCount: handles.length,\n    }, 'Fetching additional discount data');\n\n    const response = await fetch(url, {\n      method: 'GET',\n      credentials: 'omit',\n      headers: {\n        'Accept': 'application/json',\n        'Authorization': `Bearer ${token}`,\n      },\n    });\n\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n    }\n\n    const data = await response.json();\n\n    logger.info({\n      discountCount: data.discounts?.length || 0,\n      productCount: data.products?.length || 0,\n    }, 'Additional discount data loaded');\n\n    // Merge with existing cached data\n    if (_ns._fetchCache) {\n      const existing = _ns._fetchCache;\n\n      // Merge discounts (avoid duplicates by ID)\n      const existingDiscountIds = new Set(\n        (existing.discounts || []).map((d) => d.id)\n      );\n      const newDiscounts = (data.discounts || []).filter(\n        (d) => !existingDiscountIds.has(d.id)\n      );\n\n      // Merge products (avoid duplicates by ID)\n      const existingProductIds = new Set(\n        (existing.products || []).map((p) => p.id)\n      );\n      const newProducts = (data.products || []).filter(\n        (p) => !existingProductIds.has(p.id)\n      );\n\n      _ns._fetchCache = {\n        ...existing,\n        discounts: [...(existing.discounts || []), ...newDiscounts],\n        products: [...(existing.products || []), ...newProducts],\n      };\n\n      logger.info({\n        newDiscounts: newDiscounts.length,\n        newProducts: newProducts.length,\n      }, 'Merged additional discount data with cache');\n    } else {\n      // No existing data, cache new data\n      _ns._fetchCache = data;\n    }\n\n    return {\n      success: true,\n      hasData: (data.discounts?.length || 0) > 0 || (data.products?.length || 0) > 0,\n      data,\n    };\n  } catch (error) {\n    logger.error({ err: error }, 'Failed to fetch additional discount data');\n    return { success: false, hasData: false, data: null };\n  }\n}\n\n/**\n * Request best discounts calculation from backend\n * @param {object} options - Options object\n * @param {string} options.shop - Shop domain\n * @param {Array<object>} options.entries - Discount entries\n * @returns {Promise<object>} Result object with results and errors arrays\n */\nexport async function requestBestDiscounts({ shop, entries }) {\n  try {\n    // Validate inputs\n    if (!shop) {\n      shop = resolveShopDomain();\n      if (!shop) {\n        logger.error({}, 'Cannot request best discounts: shop domain not resolved');\n        return { results: [], errors: ['Shop domain not resolved'] };\n      }\n    }\n\n    if (!Array.isArray(entries) || entries.length === 0) {\n      logger.warn({}, 'No entries provided for best discounts request');\n      return { results: [], errors: [] };\n    }\n\n    // Get storefront token\n    const token = _ns.storefrontToken;\n    if (!token) {\n      logger.error({}, 'Cannot request best discounts: DISCOUNT_STOREFRONT_TOKEN not configured');\n      return { results: [], errors: ['Storefront token not configured'] };\n    }\n\n    // Build URL\n    const url = buildBestDiscountsUrl();\n    if (!url) {\n      return { results: [], errors: ['Could not build API URL'] };\n    }\n\n    logger.info({\n      shop,\n      entryCount: entries.length,\n    }, 'Requesting best discounts');\n\n    const response = await fetch(url, {\n      method: 'POST',\n      credentials: 'omit',\n      headers: {\n        'Content-Type': 'application/json',\n        'Accept': 'application/json',\n        'Authorization': `Bearer ${token}`,\n      },\n      body: JSON.stringify({\n        shop,\n        requests: entries,\n      }),\n    });\n\n    if (!response.ok) {\n      throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n    }\n\n    const data = await response.json();\n\n    logger.info({\n      resultCount: data.results?.length || 0,\n      errorCount: data.errors?.length || 0,\n    }, 'Best discounts response received');\n\n    return {\n      results: data.results || [],\n      errors: data.errors || [],\n    };\n  } catch (error) {\n    logger.error({ err: error }, 'Failed to request best discounts');\n    return {\n      results: [],\n      errors: [error.message || 'Unknown error'],\n    };\n  }\n}\n", "import { logger } from './logger.js';\nimport { isHiddenWithinBoundary } from './hidden-element-detector.js';\nimport { parsePrice, hasCurrencyCode, extractCurrencyFormat } from './currency-formatter.js';\n\n/**\n * parsePriceFromDOM(container, options)\n *\n * Three-strategy price extraction (in priority order):\n *\n * Strategy 1: Variant JSON (forms only)\n * - Look for <script data-selected-variant> inside container\n * - Parse JSON, extract json.price or json.final_price\n * - Most accurate source (theme-provided, bypasses DOM)\n *\n * Strategy 2: Sale price selector (forms only)\n * - Use formPriceDiscountedSelector (e.g., '.price-item--sale' for Dawn)\n * - Find FIRST VISIBLE element matching selector using isHiddenWithinBoundary(match, container)\n * - Parse price from element text\n * - CRITICAL: Uses isHiddenWithinBoundary with inline style check, NOT getComputedStyle\n *\n * Strategy 3: DOM text walking\n * - getCleanPriceText(container) - walks descendants, finds visible price text\n * - Parse the resulting text\n *\n * @param {HTMLElement} container - The DOM element to search within\n * @param {Object} options - Configuration options\n * @param {string} options.formPriceDiscountedSelector - CSS selector for discounted price (forms only)\n * @param {boolean} options.isForm - Whether this is a form context\n * @returns {{ price: number, hasCurrencyCode: boolean }|null} - Parsed price data or null\n */\nexport function parsePriceFromDOM(container, options = {}) {\n  const { formPriceDiscountedSelector = '', isForm = false } = options;\n\n  try {\n    // Strategy 1: Variant JSON (forms only)\n    if (isForm) {\n      try {\n        const scriptEl = container.querySelector('script[data-selected-variant]');\n        if (scriptEl) {\n          const json = JSON.parse(scriptEl.textContent);\n          const price = json.price || json.final_price;\n          if (typeof price === 'number' && price > 0) {\n            logger.log('Price from variant JSON', { price }, 'debug', 'Forms');\n            return { price, hasCurrencyCode: false };\n          }\n        }\n      } catch (e) {\n        logger.log('Failed to parse variant JSON', { error: e.message }, 'debug', 'Forms');\n        // Fall through to next strategy\n      }\n    }\n\n    // Strategy 2: Discounted form price selector (forms only)\n    if (isForm && formPriceDiscountedSelector) {\n      const result = getDiscountedFormPrice(container, formPriceDiscountedSelector);\n      if (result) {\n        logger.log('Price from discounted form selector', { price: result.price }, 'debug', 'Forms');\n        return result;\n      }\n    }\n\n    // Strategy 3: DOM text walking\n    const priceText = getCleanPriceText(container);\n    if (priceText) {\n      const extracted = extractCurrencyFormat(priceText);\n      const price = parsePrice(priceText);\n      if (typeof price === 'number' && price > 0) {\n        logger.log('Price from DOM text walking', { price, priceText: extracted }, 'debug', 'PriceExtractor');\n        return { price, hasCurrencyCode: hasCurrencyCode(priceText) };\n      }\n    }\n\n    logger.log('No price found', {}, 'debug', 'PriceExtractor');\n    return null;\n  } catch (error) {\n    logger.log('Error in parsePriceFromDOM', { error: error.message }, 'error', 'PriceExtractor');\n    return null;\n  }\n}\n\n/**\n * getDiscountedFormPrice(container, selector)\n *\n * Finds the first VISIBLE element matching the selector within container.\n * Uses isHiddenWithinBoundary to check visibility (inline styles only, not getComputedStyle).\n *\n * @param {HTMLElement} container - The DOM element to search within\n * @param {string} selector - CSS selector for discounted price elements\n * @returns {{ price: number, hasCurrencyCode: boolean }|null} - Parsed price data or null\n */\nfunction getDiscountedFormPrice(container, selector) {\n  try {\n    const matches = container.querySelectorAll(selector);\n\n    for (const match of matches) {\n      // Skip if hidden (using inline style check, NOT getComputedStyle)\n      if (isHiddenWithinBoundary(match, container)) {\n        logger.log('Skipping hidden discounted price element', { selector }, 'debug', 'Forms');\n        continue;\n      }\n\n      // Found first visible match - extract price\n      const priceText = match.textContent.trim();\n      if (priceText) {\n        const price = parsePrice(priceText);\n        if (typeof price === 'number' && price > 0) {\n          return { price, hasCurrencyCode: hasCurrencyCode(priceText) };\n        }\n      }\n    }\n\n    return null;\n  } catch (error) {\n    logger.log('Error in getDiscountedFormPrice', { error: error.message, selector }, 'error', 'Forms');\n    return null;\n  }\n}\n\n/**\n * getCleanPriceText(container)\n *\n * Theme-agnostic price text extraction using DOM walking.\n *\n * Strategy:\n * 1. Walk all descendant elements via container.querySelectorAll('*')\n * 2. For each element, check visibility:\n *    - CSS classes: visually-hidden, sr-only, screen-reader\n *    - HTML attributes: hidden, aria-hidden=\"true\"\n *    - INLINE STYLES ONLY: element.style.display === 'none' or element.style.visibility === 'hidden'\n *    - Walk parent chain but STOP at container boundary\n * 3. For visible elements, look at direct TEXT_NODE children for text containing digits\n * 4. Falls back to leaf elements (no child elements) with price-like text\n * 5. Last resort: container.textContent.trim()\n *\n * @param {HTMLElement} container - The DOM element to search within\n * @returns {string} - Clean price text or empty string\n */\nfunction getCleanPriceText(container) {\n  try {\n    const allElements = container.querySelectorAll('*');\n    const candidateTexts = [];\n\n    // Pass 1: Look for TEXT_NODE children in visible elements\n    for (const element of allElements) {\n      // Check if element is hidden\n      if (isElementHiddenInline(element, container)) {\n        continue;\n      }\n\n      // Look at direct TEXT_NODE children\n      for (const node of element.childNodes) {\n        if (node.nodeType === 3) { // TEXT_NODE\n          const text = node.textContent.trim();\n          // Check if text contains digits (price-like)\n          if (text && /\\d/.test(text)) {\n            candidateTexts.push(text);\n          }\n        }\n      }\n    }\n\n    // If we found price-like text from TEXT_NODEs, use the first one\n    if (candidateTexts.length > 0) {\n      logger.log('Found price from TEXT_NODE', { text: candidateTexts[0] }, 'debug', 'PriceExtractor');\n      return candidateTexts[0];\n    }\n\n    // Pass 2: Look for leaf elements (no child elements) with price-like text\n    for (const element of allElements) {\n      if (isElementHiddenInline(element, container)) {\n        continue;\n      }\n\n      // Check if this is a leaf element (no child elements, only text nodes)\n      if (element.children.length === 0) {\n        const text = element.textContent.trim();\n        if (text && /\\d/.test(text)) {\n          logger.log('Found price from leaf element', { text }, 'debug', 'PriceExtractor');\n          return text;\n        }\n      }\n    }\n\n    // Last resort: container's text content\n    const fallbackText = container.textContent.trim();\n    if (fallbackText && /\\d/.test(fallbackText)) {\n      logger.log('Using fallback container text', { text: fallbackText }, 'debug', 'PriceExtractor');\n      return fallbackText;\n    }\n\n    return '';\n  } catch (error) {\n    logger.log('Error in getCleanPriceText', { error: error.message }, 'error', 'PriceExtractor');\n    return '';\n  }\n}\n\n/**\n * isElementHiddenInline(element, boundary)\n *\n * Checks if element is hidden using ONLY:\n * - CSS classes: visually-hidden, sr-only, screen-reader\n * - HTML attributes: hidden, aria-hidden=\"true\"\n * - INLINE STYLES ONLY: element.style.display === 'none' or element.style.visibility === 'hidden'\n *\n * Walks parent chain but STOPS at boundary.\n * Does NOT use getComputedStyle (too slow and not needed for inline checks).\n *\n * @param {HTMLElement} element - Element to check\n * @param {HTMLElement} boundary - Boundary to stop at when walking parents\n * @returns {boolean} - True if element is hidden\n */\nfunction isElementHiddenInline(element, boundary) {\n  try {\n    let current = element;\n\n    while (current && current !== boundary) {\n      // Check CSS classes\n      if (current.classList) {\n        if (current.classList.contains('visually-hidden') ||\n            current.classList.contains('sr-only') ||\n            current.classList.contains('screen-reader')) {\n          return true;\n        }\n      }\n\n      // Check HTML attributes\n      if (current.hasAttribute('hidden') || current.getAttribute('aria-hidden') === 'true') {\n        return true;\n      }\n\n      // Check INLINE styles only (element.style, NOT getComputedStyle)\n      if (current.style.display === 'none' || current.style.visibility === 'hidden') {\n        return true;\n      }\n\n      current = current.parentElement;\n    }\n\n    return false;\n  } catch (error) {\n    logger.log('Error in isElementHiddenInline', { error: error.message }, 'error', 'PriceExtractor');\n    return false; // Assume visible on error\n  }\n}\n\n/**\n * findPriceElements(container, selector, selectorSource)\n *\n * Finds price elements within container using the provided selector.\n * If no results and selectorSource !== 'custom', tries fallback selectors.\n * Filters out hidden containers using getComputedStyle (outer container check only).\n *\n * @param {HTMLElement} container - The DOM element to search within\n * @param {string} selector - CSS selector for price elements\n * @param {string} selectorSource - Source of selector ('custom' or other)\n * @returns {Array<{container: HTMLElement}>} - Array of price element objects\n */\nexport function findPriceElements(container, selector, selectorSource = '') {\n  try {\n    let elements = [];\n\n    // Try provided selector first\n    if (selector) {\n      elements = Array.from(container.querySelectorAll(selector));\n    }\n\n    // If no results and not a custom selector, try fallbacks\n    if (elements.length === 0 && selectorSource !== 'custom') {\n      const fallbackSelectors = [\n        '.product-price .js-value',\n        '.product-price',\n        '.price__current .js-value',\n        '.price__current',\n        '.price .js-value',\n        '.price'\n      ];\n\n      for (const fallbackSelector of fallbackSelectors) {\n        elements = Array.from(container.querySelectorAll(fallbackSelector));\n        if (elements.length > 0) {\n          logger.log('Using fallback selector', { fallbackSelector }, 'debug', 'PriceExtractor');\n          break;\n        }\n      }\n    }\n\n    // Filter out hidden containers (use getComputedStyle for outer container checks)\n    const visibleElements = elements.filter(el => !isElementOrAncestorHidden(el));\n\n    logger.log('Found price elements', {\n      total: elements.length,\n      visible: visibleElements.length,\n      selector\n    }, 'debug', 'PriceExtractor');\n\n    return visibleElements.map(el => ({ container: el }));\n  } catch (error) {\n    logger.log('Error in findPriceElements', { error: error.message, selector }, 'error', 'PriceExtractor');\n    return [];\n  }\n}\n\n/**\n * isElementOrAncestorHidden(element)\n *\n * Uses getComputedStyle to check if element or any ancestor is hidden.\n * This is appropriate for outer container visibility checks (not for price element children).\n *\n * @param {HTMLElement} element - Element to check\n * @returns {boolean} - True if element or ancestor is hidden\n */\nfunction isElementOrAncestorHidden(element) {\n  try {\n    let current = element;\n\n    while (current && current !== document.body) {\n      const style = window.getComputedStyle(current);\n\n      if (style.display === 'none' ||\n          style.visibility === 'hidden' ||\n          style.opacity === '0') {\n        return true;\n      }\n\n      current = current.parentElement;\n    }\n\n    return false;\n  } catch (error) {\n    logger.log('Error in isElementOrAncestorHidden', { error: error.message }, 'error', 'PriceExtractor');\n    return false; // Assume visible on error\n  }\n}\n", "import { logger } from './logger.js';\nimport { formatPrice } from './currency-formatter.js';\nimport _ns from './namespace.js';\n\n/**\n * Badge Renderer Module\n * Handles rendering of discount badges and price displays on product cards (collection pages).\n */\n\nlet layoutNudgeScheduled = false;\nlet postLoadNudgeScheduled = false;\n\n/**\n * Creates automatic discount display elements for product cards.\n *\n * @param {HTMLElement} container - Parent container for discount elements\n * @param {Array<Object>} priceElements - Array of price element objects with container/element properties\n * @param {Object} options - Configuration options\n * @param {string} options.productId - Shopify product ID\n * @param {number} options.regularPrice - Original price before discount\n * @param {number} options.finalPrice - Price after discount applied\n * @param {Object} options.discount - Discount object with type, value, and scope info\n * @param {boolean} options.hasCurrencyCode - Whether to include currency code in formatting\n * @param {boolean} options.singlePrice - Whether this is a single-variant product\n * @returns {Array<HTMLElement>} Array of created discount elements\n */\nexport function createAutomaticDiscountDisplay(container, priceElements, options) {\n  const {\n    productId,\n    regularPrice,\n    finalPrice,\n    discount,\n    hasCurrencyCode,\n    singlePrice\n  } = options;\n\n  const createdElements = [];\n\n  try {\n    logger.debug({ productId, discountId: discount.id }, 'Creating automatic discount display');\n\n    priceElements.forEach((priceEl, index) => {\n      try {\n        // Check for existing discount elements to avoid duplicates\n        const existingContainer = priceEl.container.querySelector('.discounted-price-container');\n        const existingWrapper = priceEl.container.querySelector('.automatic-wrapper');\n\n        if (existingContainer || existingWrapper) {\n          logger.debug({ productId, index }, 'Discount elements already exist, skipping');\n          return;\n        }\n\n        const isFullScope = discount.variantScope && discount.variantScope.type === 'ALL';\n        const isPartialScope = discount.variantScope && discount.variantScope.type === 'PARTIAL';\n\n        // Create price container\n        const priceContainer = document.createElement('div');\n        priceContainer.className = 'discounted-price-container';\n\n        if (isFullScope) {\n          // Hide original price\n          priceEl.container.style.display = 'none';\n\n          // Add \"From\" prefix for multi-variant products\n          if (!singlePrice) {\n            const fromPrefix = document.createElement('span');\n            fromPrefix.className = 'discount-from-prefix';\n            fromPrefix.textContent = 'From ';\n            priceContainer.appendChild(fromPrefix);\n          }\n\n          // Create crossed-out regular price\n          const regularPriceSpan = document.createElement('span');\n          regularPriceSpan.className = 'discounted-price__regular';\n          regularPriceSpan.textContent = formatPrice(regularPrice, hasCurrencyCode);\n          priceContainer.appendChild(regularPriceSpan);\n\n          // Create sale price\n          const salePriceSpan = document.createElement('span');\n          salePriceSpan.className = 'discounted-price__sale';\n          salePriceSpan.textContent = formatPrice(finalPrice, hasCurrencyCode);\n          priceContainer.appendChild(salePriceSpan);\n        }\n\n        // Create badge\n        const badge = document.createElement('span');\n        badge.className = 'discounted-price__badge';\n\n        // Format badge text using template\n        const badgeTemplate = _ns.automaticBadgeText || 'Save {amount}';\n        const discountAmount = formatDiscountAmount(discount, hasCurrencyCode);\n        badge.textContent = badgeTemplate.replace('{amount}', discountAmount);\n\n        // Create alignment wrapper\n        const wrapper = document.createElement('div');\n        wrapper.className = 'automatic-wrapper';\n\n        // Apply alignment from settings\n        const alignment = _ns.badgeAlignment || 'left';\n        const justifyMap = {\n          left: 'flex-start',\n          center: 'center',\n          right: 'flex-end'\n        };\n        wrapper.style.display = 'flex';\n        wrapper.style.justifyContent = justifyMap[alignment] || 'flex-start';\n        wrapper.style.alignItems = 'center';\n        wrapper.style.gap = '8px';\n        wrapper.style.marginTop = '4px';\n\n        // Append price container and badge to wrapper\n        if (isFullScope) {\n          wrapper.appendChild(priceContainer);\n        }\n        wrapper.appendChild(badge);\n\n        // Add \"in selected items\" text for partial scope\n        if (isPartialScope) {\n          const selectedItemsText = document.createElement('span');\n          selectedItemsText.className = 'discount-selected-items-text';\n          selectedItemsText.textContent = 'in selected items';\n          selectedItemsText.style.fontSize = '0.875em';\n          selectedItemsText.style.color = '#666';\n          wrapper.appendChild(selectedItemsText);\n        }\n\n        // Insert wrapper after the price container\n        priceEl.container.parentNode.insertBefore(wrapper, priceEl.container.nextSibling);\n\n        createdElements.push(wrapper);\n\n        logger.debug({ productId, index }, 'Automatic discount display created');\n      } catch (err) {\n        logger.error({ err, productId, index }, 'Failed to create discount display for price element');\n      }\n    });\n\n    // Trigger layout nudge\n    scheduleLayoutNudge();\n    schedulePostLoadNudge();\n\n    logger.info({ productId, count: createdElements.length }, 'Automatic discount displays created');\n  } catch (err) {\n    logger.error({ err, productId }, 'Failed to create automatic discount display');\n  }\n\n  return createdElements;\n}\n\n/**\n * Creates coupon badge display for product cards.\n *\n * @param {HTMLElement} container - Parent container for coupon elements\n * @param {Array<Object>} priceElements - Array of price element objects\n * @param {Object} options - Configuration options\n * @param {string} options.productId - Shopify product ID\n * @param {Object} options.discount - Discount object with type, value, and scope info\n * @param {boolean} options.hasCurrencyCode - Whether to include currency code in formatting\n * @returns {Array<HTMLElement>} Array of created coupon badge elements\n */\nexport function createCouponBadge(container, priceElements, options) {\n  const {\n    productId,\n    discount,\n    hasCurrencyCode\n  } = options;\n\n  const createdElements = [];\n\n  try {\n    logger.debug({ productId, discountId: discount.id }, 'Creating coupon badge');\n\n    priceElements.forEach((priceEl, index) => {\n      try {\n        // Check for existing coupon badges to avoid duplicates\n        const existingBadge = priceEl.container.querySelector('.coupon-badge');\n        const existingWrapper = priceEl.container.querySelector('.coupon-wrapper');\n\n        if (existingBadge || existingWrapper) {\n          logger.debug({ productId, index }, 'Coupon badge already exists, skipping');\n          return;\n        }\n\n        const isPartialScope = discount.variantScope && discount.variantScope.type === 'PARTIAL';\n\n        // Create badge\n        const badge = document.createElement('div');\n        badge.className = 'coupon-badge';\n\n        // Format badge text using template\n        const badgeTemplate = _ns.couponBadgeText || 'Save {amount} with coupon';\n        const discountAmount = formatDiscountAmount(discount, hasCurrencyCode);\n        badge.textContent = badgeTemplate.replace('{amount}', discountAmount);\n\n        // Create alignment wrapper\n        const wrapper = document.createElement('div');\n        wrapper.className = 'coupon-wrapper';\n\n        // Apply alignment from settings\n        const alignment = _ns.badgeAlignment || 'left';\n        const justifyMap = {\n          left: 'flex-start',\n          center: 'center',\n          right: 'flex-end'\n        };\n        wrapper.style.display = 'flex';\n        wrapper.style.justifyContent = justifyMap[alignment] || 'flex-start';\n        wrapper.style.alignItems = 'center';\n        wrapper.style.gap = '8px';\n        wrapper.style.marginTop = '4px';\n\n        wrapper.appendChild(badge);\n\n        // Add \"in selected items\" text for partial scope\n        if (isPartialScope) {\n          const selectedItemsText = document.createElement('span');\n          selectedItemsText.className = 'discount-selected-items-text';\n          selectedItemsText.textContent = 'in selected items';\n          selectedItemsText.style.fontSize = '0.875em';\n          selectedItemsText.style.color = '#666';\n          wrapper.appendChild(selectedItemsText);\n        }\n\n        // Insert wrapper after the price container\n        priceEl.container.parentNode.insertBefore(wrapper, priceEl.container.nextSibling);\n\n        createdElements.push(wrapper);\n\n        logger.debug({ productId, index }, 'Coupon badge created');\n      } catch (err) {\n        logger.error({ err, productId, index }, 'Failed to create coupon badge for price element');\n      }\n    });\n\n    // Trigger layout nudge\n    scheduleLayoutNudge();\n    schedulePostLoadNudge();\n\n    logger.info({ productId, count: createdElements.length }, 'Coupon badges created');\n  } catch (err) {\n    logger.error({ err, productId }, 'Failed to create coupon badge');\n  }\n\n  return createdElements;\n}\n\n/**\n * Schedules a layout nudge to trigger theme layout recalculation.\n * Batches multiple requests into a single RAF callback.\n */\nfunction scheduleLayoutNudge() {\n  if (layoutNudgeScheduled) {\n    return;\n  }\n\n  layoutNudgeScheduled = true;\n\n  requestAnimationFrame(() => {\n    try {\n      // Dispatch resize event to trigger theme layout recalculation\n      window.dispatchEvent(new Event('resize'));\n      logger.debug({}, 'Layout nudge triggered');\n    } catch (err) {\n      logger.error({ err }, 'Failed to trigger layout nudge');\n    } finally {\n      layoutNudgeScheduled = false;\n    }\n  });\n}\n\n/**\n * Schedules post-load layout nudges at 50ms and 250ms after window load.\n * Helps ensure theme layouts properly accommodate discount elements.\n */\nfunction schedulePostLoadNudge() {\n  if (postLoadNudgeScheduled) {\n    return;\n  }\n\n  postLoadNudgeScheduled = true;\n\n  const triggerNudge = () => {\n    try {\n      // First nudge at 50ms\n      setTimeout(() => {\n        window.dispatchEvent(new Event('resize'));\n        logger.debug({}, 'Post-load nudge (50ms) triggered');\n      }, 50);\n\n      // Second nudge at 250ms\n      setTimeout(() => {\n        window.dispatchEvent(new Event('resize'));\n        logger.debug({}, 'Post-load nudge (250ms) triggered');\n      }, 250);\n    } catch (err) {\n      logger.error({ err }, 'Failed to trigger post-load nudges');\n    }\n  };\n\n  if (document.readyState === 'complete') {\n    triggerNudge();\n  } else {\n    window.addEventListener('load', triggerNudge, { once: true });\n  }\n}\n\n/**\n * Formats discount amount for display in badges.\n *\n * @param {Object} discount - Discount object with type and value\n * @param {boolean} hasCurrencyCode - Whether to include currency code\n * @returns {string} Formatted discount amount (e.g., \"20%\" or \"$5.00\")\n */\nfunction formatDiscountAmount(discount, hasCurrencyCode) {\n  try {\n    if (discount.type === 'percentage') {\n      return `${discount.value}%`;\n    } else if (discount.type === 'fixed_amount') {\n      return formatPrice(discount.value, hasCurrencyCode);\n    } else {\n      logger.warn({ discountType: discount.type }, 'Unknown discount type');\n      return formatPrice(discount.value, hasCurrencyCode);\n    }\n  } catch (err) {\n    logger.error({ err, discount }, 'Failed to format discount amount');\n    return '$0.00';\n  }\n}\n", "import { logger } from './logger.js';\nimport _ns from './namespace.js';\n\n/**\n * Builds a discount URL with return_to parameter\n * @param {string} discountCode - The discount code to apply\n * @returns {string} Full discount URL with return path\n */\nexport function buildDiscountUrlWithReturnTo(discountCode) {\n  try {\n    const encodedCode = encodeURIComponent(discountCode);\n    const currentPath = window.location.pathname + window.location.search;\n    const encodedReturnTo = encodeURIComponent(currentPath);\n    const discountUrl = `/discount/${encodedCode}?return_to=${encodedReturnTo}`;\n\n    logger.debug({ discountCode, discountUrl }, 'Built discount URL');\n    return discountUrl;\n  } catch (error) {\n    logger.error({ err: error, discountCode }, 'Failed to build discount URL');\n    // Fallback to simple URL without return_to\n    return `/discount/${encodeURIComponent(discountCode)}`;\n  }\n}\n\n/**\n * Applies a discount code using 3-fallback strategy\n * @param {string} discountCode - The discount code to apply\n * @param {Object} options - Options object\n * @param {boolean} options.silent - If false, navigate directly without trying fetch/iframe\n * @returns {Promise<void>}\n */\nexport async function applyDiscountCode(discountCode, options = {}) {\n  const { silent = true } = options;\n\n  try {\n    // Store applied state in sessionStorage\n    const storageKey = `wf_coupon_applied_${discountCode}`;\n    sessionStorage.setItem(storageKey, '1');\n    logger.info({ discountCode, silent }, 'Applying discount code');\n\n    // Build discount URL\n    const discountUrl = buildDiscountUrlWithReturnTo(discountCode);\n\n    // Check if in theme editor\n    if (typeof Shopify !== 'undefined' && Shopify.designMode) {\n      logger.debug({ discountCode }, 'In theme editor, skipping network requests');\n      return;\n    }\n\n    // If not silent, navigate directly\n    if (!silent) {\n      logger.info({ discountCode, discountUrl }, 'Non-silent mode, navigating directly');\n      window.location.href = discountUrl;\n      return;\n    }\n\n    // Strategy 1: fetch() with timeout\n    try {\n      logger.debug({ discountCode }, 'Attempting Strategy 1: fetch()');\n      const controller = new AbortController();\n      const timeoutId = setTimeout(() => controller.abort(), 2500);\n\n      const response = await fetch(discountUrl, {\n        method: 'GET',\n        credentials: 'include',\n        mode: 'cors',\n        redirect: 'follow',\n        signal: controller.signal\n      });\n\n      clearTimeout(timeoutId);\n\n      if (response.ok || (response.status >= 200 && response.status < 400)) {\n        logger.info({ discountCode, status: response.status }, 'Strategy 1 succeeded');\n        return;\n      }\n\n      logger.warn({ discountCode, status: response.status }, 'Strategy 1 failed, trying Strategy 2');\n    } catch (fetchError) {\n      logger.warn({ err: fetchError, discountCode }, 'Strategy 1 failed, trying Strategy 2');\n    }\n\n    // Strategy 2: hidden iframe with timeout\n    try {\n      logger.debug({ discountCode }, 'Attempting Strategy 2: iframe');\n      await applyViaIframe(discountUrl, discountCode);\n      logger.info({ discountCode }, 'Strategy 2 succeeded');\n      return;\n    } catch (iframeError) {\n      logger.warn({ err: iframeError, discountCode }, 'Strategy 2 failed, trying Strategy 3');\n    }\n\n    // Strategy 3: Direct navigation\n    logger.info({ discountCode, discountUrl }, 'Strategy 3: direct navigation');\n    window.location.href = discountUrl;\n\n  } catch (error) {\n    logger.error({ err: error, discountCode }, 'Failed to apply discount code');\n    throw error;\n  }\n}\n\n/**\n * Applies discount via hidden iframe with timeout\n * @param {string} url - The discount URL\n * @param {string} discountCode - The discount code (for logging)\n * @returns {Promise<void>}\n */\nfunction applyViaIframe(url, discountCode) {\n  return new Promise((resolve, reject) => {\n    let iframe = null;\n    let timeoutId = null;\n    let resolved = false;\n\n    const cleanup = () => {\n      if (timeoutId) {\n        clearTimeout(timeoutId);\n      }\n      if (iframe && iframe.parentNode) {\n        setTimeout(() => {\n          try {\n            if (iframe && iframe.parentNode) {\n              iframe.parentNode.removeChild(iframe);\n            }\n          } catch (err) {\n            logger.warn({ err, discountCode }, 'Failed to remove iframe');\n          }\n        }, 250);\n      }\n    };\n\n    const finish = (success, error = null) => {\n      if (resolved) return;\n      resolved = true;\n      cleanup();\n      if (success) {\n        resolve();\n      } else {\n        reject(error || new Error('Iframe strategy failed'));\n      }\n    };\n\n    try {\n      iframe = document.createElement('iframe');\n      iframe.style.display = 'none';\n      iframe.style.position = 'absolute';\n      iframe.style.width = '0';\n      iframe.style.height = '0';\n      iframe.style.border = 'none';\n      iframe.setAttribute('aria-hidden', 'true');\n      iframe.src = url;\n\n      iframe.onload = () => {\n        logger.debug({ discountCode }, 'Iframe loaded');\n        finish(true);\n      };\n\n      iframe.onerror = (error) => {\n        logger.warn({ err: error, discountCode }, 'Iframe error');\n        finish(false, error);\n      };\n\n      timeoutId = setTimeout(() => {\n        logger.warn({ discountCode }, 'Iframe timeout');\n        finish(false, new Error('Iframe timeout'));\n      }, 3500);\n\n      document.body.appendChild(iframe);\n\n    } catch (error) {\n      logger.error({ err: error, discountCode }, 'Failed to create iframe');\n      finish(false, error);\n    }\n  });\n}\n\n/**\n * Initialize coupon state tracking\n */\nexport function initCouponState() {\n  if (!_ns._couponState) {\n    _ns._couponState = {};\n    logger.debug('Initialized coupon state tracker');\n  }\n}\n\n/**\n * Get coupon applied state by code\n * @param {string} code - Discount code\n * @returns {{ applied: boolean }} State object\n */\nexport function getCouponState(code) {\n  try {\n    initCouponState();\n    const state = _ns._couponState[code];\n    if (state && typeof state === 'object') {\n      return state;\n    }\n    return { applied: state === true };\n  } catch (error) {\n    logger.error({ err: error, code }, 'Failed to get coupon state');\n    return { applied: false };\n  }\n}\n\n/**\n * Set coupon applied state by code\n * @param {string} code - Discount code\n * @param {Object|boolean} stateOrApplied - State object { applied, timestamp } or boolean\n */\nexport function setCouponState(code, stateOrApplied) {\n  try {\n    initCouponState();\n    if (typeof stateOrApplied === 'object') {\n      _ns._couponState[code] = stateOrApplied;\n    } else {\n      _ns._couponState[code] = { applied: !!stateOrApplied };\n    }\n    logger.debug({ code, state: _ns._couponState[code] }, 'Set coupon state');\n  } catch (error) {\n    logger.error({ err: error, code }, 'Failed to set coupon state');\n  }\n}\n", "import { logger } from './logger.js';\nimport { formatPrice, formatDate } from './currency-formatter.js';\nimport { applyDiscountCode, getCouponState, setCouponState } from './coupon-handler.js';\nimport _ns from './namespace.js';\n\n/**\n * UI Components Module\n * Shared UI components for product page form rendering (PP parity).\n */\n\n// SVG path data for the 4 icon options\nconst ICON_PATHS = {\n  'check-mark-flower-filled.svg': 'M23.334 11.96c-.713-.726-.872-1.829-.393-2.727.342-.64.366-1.401.064-2.062-.301-.66-.893-1.142-1.601-1.302-.991-.225-1.722-1.067-1.803-2.081-.059-.723-.451-1.378-1.062-1.77-.609-.393-1.367-.478-2.05-.229-.956.347-2.026.032-2.642-.776-.44-.576-1.124-.915-1.85-.915-.725 0-1.409.339-1.849.915-.613.809-1.683 1.124-2.639.777-.682-.248-1.44-.163-2.05.229-.61.392-1.003 1.047-1.061 1.77-.082 1.014-.812 1.857-1.803 2.081-.708.16-1.3.642-1.601 1.302s-.277 1.422.065 2.061c.479.897.32 2.001-.392 2.727-.509.517-.747 1.242-.644 1.96s.536 1.347 1.17 1.7c.888.495 1.352 1.51 1.144 2.505-.147.71.044 1.448.519 1.996.476.549 1.18.844 1.902.798 1.016-.063 1.953.54 2.317 1.489.259.678.82 1.195 1.517 1.399.695.204 1.447.072 2.031-.357.819-.603 1.936-.603 2.754 0 .584.43 1.336.562 2.031.357.697-.204 1.258-.722 1.518-1.399.363-.949 1.301-1.553 2.316-1.489.724.046 1.427-.249 1.902-.798.475-.548.667-1.286.519-1.996-.207-.995.256-2.01 1.145-2.505.633-.354 1.065-.982 1.169-1.7s-.135-1.443-.643-1.96zm-12.584 5.43l-4.5-4.364 1.857-1.857 2.643 2.506 5.643-5.784 1.857 1.857-7.5 7.642z',\n  'check-mark-circle-filled.svg': 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z',\n  'check-mark-square-filled.svg': 'M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z',\n  'check-mark.svg': 'M20.285 2l-11.285 11.567-5.286-5.011-3.714 3.716 9 8.728 15-15.285z'\n};\n\n/**\n * Creates a price container with discount display.\n *\n * @param {number} regularPrice - Original price before discount\n * @param {number} finalPrice - Price after discount applied\n * @param {Object} discount - Discount object\n * @param {boolean} isAutomatic - Whether this is an automatic discount\n * @param {boolean} hasCurrencyCode - Whether to include currency code in formatting\n * @returns {HTMLElement} Price container element\n */\nexport function createPriceContainer(regularPrice, finalPrice, discount, isAutomatic, hasCurrencyCode) {\n  try {\n    logger.debug({ regularPrice, finalPrice, isAutomatic }, 'Creating price container');\n\n    const container = document.createElement('div');\n    container.className = 'ddp-discounted-price-container';\n\n    // Crossed-out regular price\n    const regularPriceEl = document.createElement('span');\n    regularPriceEl.className = 'ddp-discounted-price__regular';\n    regularPriceEl.textContent = formatPrice(regularPrice, hasCurrencyCode);\n    container.appendChild(regularPriceEl);\n\n    // Bold sale price\n    const salePriceEl = document.createElement('span');\n    salePriceEl.className = 'ddp-discounted-price__sale';\n    salePriceEl.textContent = formatPrice(finalPrice, hasCurrencyCode);\n    container.appendChild(salePriceEl);\n\n    // Add badge for automatic discounts\n    if (isAutomatic && discount) {\n      const badge = document.createElement('span');\n      badge.className = 'ddp-discounted-price__badge';\n\n      // Format badge text\n      const badgeTemplate = _ns.automaticBadgeText || 'Save {amount}';\n      const discountAmount = formatDiscountAmount(discount, hasCurrencyCode);\n      badge.textContent = badgeTemplate.replace('{amount}', discountAmount);\n\n      container.appendChild(badge);\n    }\n\n    // Add terms link if enabled\n    const settings = _ns.settings || {};\n    if (settings.showTermsLink && discount) {\n      const termsLink = document.createElement('button');\n      termsLink.className = 'ddp-terms-link';\n      termsLink.type = 'button';\n      termsLink.textContent = 'Terms';\n      termsLink.setAttribute('aria-label', 'View discount terms and conditions');\n\n      termsLink.addEventListener('click', (e) => {\n        e.preventDefault();\n        showTermsModal(discount);\n      });\n\n      container.appendChild(termsLink);\n    }\n\n    logger.debug({}, 'Price container created');\n    return container;\n  } catch (err) {\n    logger.error({ err }, 'Failed to create price container');\n    const fallback = document.createElement('div');\n    fallback.textContent = formatPrice(finalPrice, hasCurrencyCode);\n    return fallback;\n  }\n}\n\n/**\n * Creates an interactive coupon block.\n *\n * @param {Object} discount - Discount object with code and details\n * @param {Function} onApply - Callback when coupon is applied\n * @param {Function} onRemove - Callback when coupon is removed\n * @param {string} productId - Shopify product ID\n * @param {string} variantId - Shopify variant ID\n * @param {boolean} isAutoApplied - Whether coupon is auto-applied\n * @returns {HTMLElement} Coupon block element\n */\nexport function createCouponBlock(discount, onApply, onRemove, productId, variantId, isAutoApplied) {\n  try {\n    logger.debug({ discountId: discount.id, productId, variantId, isAutoApplied }, 'Creating coupon block');\n\n    const settings = _ns.settings || {};\n    const isInEditor = window.Shopify && window.Shopify.designMode;\n\n    // Main container\n    const block = document.createElement('div');\n    block.className = 'ddp-coupon-block';\n    block.dataset.discountId = discount.id;\n    block.dataset.code = discount.code;\n\n    // Main content wrapper\n    const mainContent = document.createElement('div');\n    mainContent.className = 'ddp-coupon-main-content';\n\n    // Pennant flag\n    const flag = document.createElement('div');\n    flag.className = 'ddp-coupon-flag';\n    flag.textContent = 'Coupon:';\n    mainContent.appendChild(flag);\n\n    // Label wrapper\n    const labelWrapper = document.createElement('div');\n    labelWrapper.className = 'ddp-coupon-label-wrapper';\n\n    // Checkbox and label\n    const checkbox = document.createElement('input');\n    checkbox.type = 'checkbox';\n    checkbox.id = `ddp-coupon-${discount.id}`;\n    checkbox.className = 'ddp-coupon-checkbox';\n\n    // Check if coupon is already applied\n    const couponState = getCouponState(discount.code);\n    const isApplied = couponState.applied || isAutoApplied || (isInEditor && _ns.showAppliedPreview);\n\n    if (isApplied) {\n      checkbox.checked = true;\n    }\n\n    if (isAutoApplied) {\n      checkbox.disabled = true;\n      checkbox.title = 'This coupon is automatically applied';\n    }\n\n    const label = document.createElement('label');\n    label.htmlFor = checkbox.id;\n    label.className = 'ddp-coupon-label';\n\n    // Build label text safely (split template by {amount}, use textContent + <b> for amount)\n    const labelTemplate = settings.couponLabelText || 'Apply code {code} to save {amount}';\n    const discountAmount = formatDiscountAmount(discount, true);\n\n    // Replace {code} and {amount}\n    let labelText = labelTemplate\n      .replace('{code}', discount.code)\n      .replace('{amount}', discountAmount);\n\n    // For simple case, just use textContent\n    // In v1, {amount} was wrapped in <b>, but we use textContent for XSS safety\n    label.textContent = labelText;\n\n    labelWrapper.appendChild(checkbox);\n    labelWrapper.appendChild(label);\n    mainContent.appendChild(labelWrapper);\n\n    // Applied status (hidden by default)\n    const appliedStatus = document.createElement('div');\n    appliedStatus.className = 'ddp-coupon-applied';\n\n    if (isApplied) {\n      appliedStatus.classList.add('visible');\n      labelWrapper.style.display = 'none';\n    }\n\n    // SVG icon\n    const iconFile = settings.appliedIconFile || 'check-mark-circle-filled.svg';\n    const iconPath = ICON_PATHS[iconFile] || ICON_PATHS['check-mark-circle-filled.svg'];\n\n    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\n    svg.setAttribute('width', '24');\n    svg.setAttribute('height', '24');\n    svg.setAttribute('viewBox', '0 0 24 24');\n    svg.setAttribute('fill', 'currentColor');\n    svg.setAttribute('aria-hidden', 'true');\n\n    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');\n    path.setAttribute('d', iconPath);\n    svg.appendChild(path);\n\n    appliedStatus.appendChild(svg);\n\n    const appliedText = document.createElement('span');\n    appliedText.textContent = settings.appliedText || 'Coupon applied';\n    appliedStatus.appendChild(appliedText);\n\n    mainContent.appendChild(appliedStatus);\n    block.appendChild(mainContent);\n\n    // Toolbar\n    const toolbar = document.createElement('div');\n    toolbar.className = 'ddp-coupon-toolbar';\n\n    // Terms link\n    if (settings.showTermsLink) {\n      const termsLink = document.createElement('button');\n      termsLink.className = 'ddp-terms-link';\n      termsLink.type = 'button';\n      termsLink.textContent = 'Terms';\n      termsLink.setAttribute('aria-label', 'View coupon terms and conditions');\n\n      termsLink.addEventListener('click', (e) => {\n        e.preventDefault();\n        showTermsModal(discount);\n      });\n\n      toolbar.appendChild(termsLink);\n    }\n\n    block.appendChild(toolbar);\n\n    // Checkbox change handler\n    checkbox.addEventListener('change', async (e) => {\n      try {\n        if (e.target.checked) {\n          logger.info({ code: discount.code, productId, variantId }, 'Applying coupon');\n\n          // Hide label, show applied status\n          labelWrapper.style.display = 'none';\n          appliedStatus.classList.add('visible');\n\n          // Update state\n          setCouponState(discount.code, { applied: true, timestamp: Date.now() });\n\n          // Call onApply callback\n          if (typeof onApply === 'function') {\n            await onApply(discount.code);\n          }\n\n          // Apply discount code to cart\n          try {\n            await applyDiscountCode(discount.code);\n          } catch (applyErr) {\n            logger.error({ err: applyErr, code: discount.code }, 'Failed to apply discount code');\n            // Revert UI on failure\n            e.target.checked = false;\n            labelWrapper.style.display = '';\n            appliedStatus.classList.remove('visible');\n            setCouponState(discount.code, { applied: false });\n          }\n        } else {\n          logger.info({ code: discount.code, productId, variantId }, 'Removing coupon');\n\n          // Show label, hide applied status\n          labelWrapper.style.display = '';\n          appliedStatus.classList.remove('visible');\n\n          // Update state\n          setCouponState(discount.code, { applied: false });\n\n          // Call onRemove callback\n          if (typeof onRemove === 'function') {\n            await onRemove(discount.code);\n          }\n\n          // Remove discount code from cart\n          try {\n            await applyDiscountCode(''); // Empty code removes discount\n          } catch (removeErr) {\n            logger.error({ err: removeErr, code: discount.code }, 'Failed to remove discount code');\n          }\n        }\n      } catch (err) {\n        logger.error({ err, code: discount.code }, 'Error handling coupon checkbox change');\n      }\n    });\n\n    // Track auto-applied coupons in sessionStorage\n    if (isAutoApplied) {\n      try {\n        sessionStorage.setItem(`wf_auto_applied_${discount.code}`, 'true');\n      } catch (storageErr) {\n        logger.warn({ err: storageErr }, 'Failed to set auto-applied flag in sessionStorage');\n      }\n    }\n\n    logger.debug({ discountId: discount.id }, 'Coupon block created');\n    return block;\n  } catch (err) {\n    logger.error({ err, discountId: discount?.id }, 'Failed to create coupon block');\n    const fallback = document.createElement('div');\n    fallback.className = 'ddp-coupon-block-error';\n    fallback.textContent = 'Coupon temporarily unavailable';\n    return fallback;\n  }\n}\n\n/**\n * Shows a full-screen modal with discount terms and conditions.\n *\n * @param {Object} discount - Discount object with details\n */\nexport function showTermsModal(discount) {\n  try {\n    logger.debug({ discountId: discount.id }, 'Showing terms modal');\n\n    const settings = _ns.settings || {};\n\n    // Create overlay\n    const overlay = document.createElement('div');\n    overlay.className = 'ddp-terms-modal-overlay';\n    overlay.setAttribute('role', 'dialog');\n    overlay.setAttribute('aria-modal', 'true');\n    overlay.setAttribute('aria-labelledby', 'ddp-terms-modal-title');\n\n    // Create modal content\n    const modal = document.createElement('div');\n    modal.className = 'ddp-terms-modal-content';\n\n    // Header\n    const header = document.createElement('div');\n    header.className = 'ddp-terms-modal-header';\n\n    const title = document.createElement('h2');\n    title.id = 'ddp-terms-modal-title';\n    title.textContent = 'Discount Information';\n    header.appendChild(title);\n\n    const closeButton = document.createElement('button');\n    closeButton.className = 'ddp-terms-modal-close';\n    closeButton.type = 'button';\n    closeButton.textContent = '\u00D7';\n    closeButton.setAttribute('aria-label', 'Close modal');\n    header.appendChild(closeButton);\n\n    modal.appendChild(header);\n\n    // Body\n    const body = document.createElement('div');\n    body.className = 'ddp-terms-modal-body';\n\n    // Discount details\n    const detailsSection = document.createElement('div');\n    detailsSection.className = 'ddp-terms-section';\n\n    const detailsTitle = document.createElement('h3');\n    detailsTitle.textContent = 'Details';\n    detailsSection.appendChild(detailsTitle);\n\n    // Type\n    const typeRow = document.createElement('p');\n    const typeLabel = document.createElement('strong');\n    typeLabel.textContent = 'Type: ';\n    typeRow.appendChild(typeLabel);\n    const typeValue = document.createTextNode(discount.type === 'percentage' ? 'Percentage' : 'Fixed Amount');\n    typeRow.appendChild(typeValue);\n    detailsSection.appendChild(typeRow);\n\n    // Value\n    const valueRow = document.createElement('p');\n    const valueLabel = document.createElement('strong');\n    valueLabel.textContent = 'Value: ';\n    valueRow.appendChild(valueLabel);\n    const discountAmount = formatDiscountAmount(discount, true);\n    const valueValue = document.createTextNode(discountAmount);\n    valueRow.appendChild(valueValue);\n    detailsSection.appendChild(valueRow);\n\n    // End date\n    if (discount.endsAt) {\n      const endDateRow = document.createElement('p');\n      const endDateLabel = document.createElement('strong');\n      endDateLabel.textContent = 'Expires: ';\n      endDateRow.appendChild(endDateLabel);\n      const endDateValue = document.createTextNode(formatDate(discount.endsAt));\n      endDateRow.appendChild(endDateValue);\n      detailsSection.appendChild(endDateRow);\n    }\n\n    // Purchase type\n    if (discount.appliesOncePerCustomer !== undefined) {\n      const purchaseTypeRow = document.createElement('p');\n      const purchaseTypeLabel = document.createElement('strong');\n      purchaseTypeLabel.textContent = 'Usage: ';\n      purchaseTypeRow.appendChild(purchaseTypeLabel);\n      const purchaseTypeValue = document.createTextNode(\n        discount.appliesOncePerCustomer ? 'One time per customer' : 'Multiple uses allowed'\n      );\n      purchaseTypeRow.appendChild(purchaseTypeValue);\n      detailsSection.appendChild(purchaseTypeRow);\n    }\n\n    body.appendChild(detailsSection);\n\n    // Terms section\n    const termsSection = document.createElement('div');\n    termsSection.className = 'ddp-terms-section';\n\n    const termsTitle = document.createElement('h3');\n    termsTitle.textContent = 'Terms & Conditions';\n    termsSection.appendChild(termsTitle);\n\n    // Split terms template on newlines and create paragraphs\n    const termsTemplate = settings.discountTermsTemplate || 'Please see store policies for complete terms.';\n    const termsLines = termsTemplate.split('\\n').filter(line => line.trim());\n\n    termsLines.forEach(line => {\n      const p = document.createElement('p');\n      p.textContent = line.trim();\n      termsSection.appendChild(p);\n    });\n\n    body.appendChild(termsSection);\n    modal.appendChild(body);\n\n    overlay.appendChild(modal);\n\n    // Close handlers\n    const closeModal = () => {\n      try {\n        overlay.remove();\n        document.body.style.overflow = '';\n        logger.debug({}, 'Terms modal closed');\n      } catch (err) {\n        logger.error({ err }, 'Failed to close terms modal');\n      }\n    };\n\n    closeButton.addEventListener('click', closeModal);\n\n    overlay.addEventListener('click', (e) => {\n      if (e.target === overlay) {\n        closeModal();\n      }\n    });\n\n    document.addEventListener('keydown', (e) => {\n      if (e.key === 'Escape' && document.body.contains(overlay)) {\n        closeModal();\n      }\n    }, { once: true });\n\n    // Prevent body scroll\n    document.body.style.overflow = 'hidden';\n\n    // Append to body\n    document.body.appendChild(overlay);\n\n    // Focus close button for accessibility\n    closeButton.focus();\n\n    logger.info({ discountId: discount.id }, 'Terms modal shown');\n  } catch (err) {\n    logger.error({ err, discountId: discount?.id }, 'Failed to show terms modal');\n  }\n}\n\n/**\n * Builds a loading skeleton placeholder.\n *\n * @returns {HTMLElement} Skeleton loader element\n */\nexport function buildSkeletonLoader() {\n  try {\n    const skeleton = document.createElement('div');\n    skeleton.className = 'ddp-skeleton-loader';\n    skeleton.setAttribute('role', 'status');\n    skeleton.setAttribute('aria-live', 'polite');\n    skeleton.setAttribute('aria-label', 'Loading discounts');\n\n    // Price line\n    const priceLine = document.createElement('div');\n    priceLine.className = 'ddp-skeleton-line ddp-skeleton-line--price';\n    priceLine.style.height = '28px';\n    priceLine.style.width = '120px';\n    skeleton.appendChild(priceLine);\n\n    // Large line\n    const largeLine = document.createElement('div');\n    largeLine.className = 'ddp-skeleton-line ddp-skeleton-line--lg';\n    largeLine.style.width = '85%';\n    skeleton.appendChild(largeLine);\n\n    // Medium line\n    const mediumLine = document.createElement('div');\n    mediumLine.className = 'ddp-skeleton-line ddp-skeleton-line--md';\n    mediumLine.style.width = '65%';\n    skeleton.appendChild(mediumLine);\n\n    // Small line\n    const smallLine = document.createElement('div');\n    smallLine.className = 'ddp-skeleton-line ddp-skeleton-line--sm';\n    smallLine.style.width = '45%';\n    skeleton.appendChild(smallLine);\n\n    // Screen reader text\n    const srOnly = document.createElement('span');\n    srOnly.className = 'ddp-sr-only';\n    srOnly.textContent = 'Loading discounts ...';\n    skeleton.appendChild(srOnly);\n\n    logger.debug({}, 'Skeleton loader created');\n    return skeleton;\n  } catch (err) {\n    logger.error({ err }, 'Failed to create skeleton loader');\n    const fallback = document.createElement('div');\n    fallback.textContent = 'Loading...';\n    return fallback;\n  }\n}\n\n/**\n * Formats discount amount for display.\n *\n * @param {Object} discount - Discount object with type and value\n * @param {boolean} hasCurrencyCode - Whether to include currency code\n * @returns {string} Formatted discount amount\n */\nfunction formatDiscountAmount(discount, hasCurrencyCode) {\n  try {\n    if (discount.type === 'percentage') {\n      return `${discount.value}%`;\n    } else if (discount.type === 'fixed_amount') {\n      return formatPrice(discount.value, hasCurrencyCode);\n    } else {\n      logger.warn({ discountType: discount.type }, 'Unknown discount type');\n      return formatPrice(discount.value, hasCurrencyCode);\n    }\n  } catch (err) {\n    logger.error({ err, discount }, 'Failed to format discount amount');\n    return '$0.00';\n  }\n}\n", "import { logger } from './logger.js';\n\n/**\n * Gets current variant information from container\n * @param {HTMLElement} container - Container element to search within\n * @param {string} variantInputSelector - Selector for variant input\n * @returns {Object} Object with variantId and inputElement\n */\nexport function getCurrentVariantInfo(container, variantInputSelector) {\n  try {\n    // Try to find variant input within container\n    let variantInput = container.querySelector(variantInputSelector);\n\n    // Fallback: try closest section\n    if (!variantInput) {\n      const section = container.closest('[id^=\"shopify-section-\"]');\n      if (section) {\n        variantInput = section.querySelector(variantInputSelector);\n      }\n    }\n\n    // Fallback: common variant input patterns\n    if (!variantInput) {\n      const selectors = [\n        'input[name=\"id\"]',\n        'select[name=\"id\"]',\n        '[data-variant-id]',\n        '.product-variant-id'\n      ];\n\n      for (const selector of selectors) {\n        variantInput = container.querySelector(selector);\n        if (variantInput) break;\n\n        const section = container.closest('[id^=\"shopify-section-\"]');\n        if (section) {\n          variantInput = section.querySelector(selector);\n          if (variantInput) break;\n        }\n      }\n    }\n\n    if (!variantInput) {\n      logger.warn({ container: container.id || container.className }, 'No variant input found');\n      return { variantId: null, inputElement: null };\n    }\n\n    // Extract variant ID\n    let variantId = null;\n    if (variantInput.tagName === 'INPUT' || variantInput.tagName === 'SELECT') {\n      variantId = variantInput.value;\n    } else if (variantInput.dataset.variantId) {\n      variantId = variantInput.dataset.variantId;\n    }\n\n    logger.debug({ variantId, selector: variantInputSelector }, 'Found variant info');\n    return { variantId, inputElement: variantInput };\n\n  } catch (error) {\n    logger.error({ err: error, container: container?.id }, 'Failed to get variant info');\n    return { variantId: null, inputElement: null };\n  }\n}\n\n/**\n * Gets current selling plan information from container\n * @param {HTMLElement} container - Container element to search within\n * @returns {Object} Object with sellingPlanId and inputElement\n */\nexport function getCurrentSellingPlanInfo(container) {\n  try {\n    // Find selling plan input/select\n    const selectors = [\n      'input[name=\"selling_plan\"]',\n      'select[name=\"selling_plan\"]',\n      '[data-selling-plan-id]'\n    ];\n\n    let planInput = null;\n    for (const selector of selectors) {\n      planInput = container.querySelector(selector);\n      if (planInput) break;\n\n      // Try closest section\n      const section = container.closest('[id^=\"shopify-section-\"]');\n      if (section) {\n        planInput = section.querySelector(selector);\n        if (planInput) break;\n      }\n    }\n\n    if (!planInput) {\n      logger.debug({ container: container.id || container.className }, 'No selling plan input found');\n      return { sellingPlanId: null, inputElement: null };\n    }\n\n    // Extract selling plan ID\n    let sellingPlanId = null;\n    if (planInput.tagName === 'INPUT' || planInput.tagName === 'SELECT') {\n      sellingPlanId = planInput.value;\n    } else if (planInput.dataset.sellingPlanId) {\n      sellingPlanId = planInput.dataset.sellingPlanId;\n    }\n\n    // Empty string means one-time purchase\n    if (sellingPlanId === '') {\n      sellingPlanId = null;\n    }\n\n    logger.debug({ sellingPlanId }, 'Found selling plan info');\n    return { sellingPlanId, inputElement: planInput };\n\n  } catch (error) {\n    logger.error({ err: error, container: container?.id }, 'Failed to get selling plan info');\n    return { sellingPlanId: null, inputElement: null };\n  }\n}\n\n/**\n * Sets up variant detection with multiple strategies\n * @param {HTMLElement} rootElement - Root element to attach listeners to\n * @param {string} variantInputSelector - Selector for variant input\n * @param {Function} onVariantChange - Callback for variant changes (variantId)\n * @param {Function} onSellingPlanChange - Callback for selling plan changes (sellingPlanId)\n */\nexport function setupVariantDetection(\n  rootElement,\n  variantInputSelector,\n  onVariantChange,\n  onSellingPlanChange\n) {\n  try {\n    logger.info('Setting up variant detection');\n\n    const trackedElements = new WeakSet();\n    let lastVariantId = null;\n    let lastSellingPlanId = null;\n\n    // Helper: notify variant change if different\n    const notifyVariantChange = (variantId, source) => {\n      if (variantId && variantId !== lastVariantId) {\n        lastVariantId = variantId;\n        logger.debug({ variantId, source }, 'Variant changed');\n        if (onVariantChange) {\n          onVariantChange(variantId);\n        }\n      }\n    };\n\n    // Helper: notify selling plan change if different\n    const notifySellingPlanChange = (sellingPlanId, source) => {\n      if (sellingPlanId !== lastSellingPlanId) {\n        lastSellingPlanId = sellingPlanId;\n        logger.debug({ sellingPlanId, source }, 'Selling plan changed');\n        if (onSellingPlanChange) {\n          onSellingPlanChange(sellingPlanId);\n        }\n      }\n    };\n\n    // Strategy 1: Cart form detection\n    const setupCartFormDetection = () => {\n      try {\n        const cartForms = rootElement.querySelectorAll('form[action*=\"cart/add\"], form[action*=\"/cart/add\"]');\n\n        cartForms.forEach(form => {\n          if (trackedElements.has(form)) return;\n          trackedElements.add(form);\n\n          // Find variant input\n          const variantInput = form.querySelector(variantInputSelector) ||\n                              form.querySelector('input[name=\"id\"]') ||\n                              form.querySelector('select[name=\"id\"]');\n\n          if (variantInput) {\n            // Listen to change and input events\n            variantInput.addEventListener('change', (e) => {\n              notifyVariantChange(e.target.value, 'cart-form-change');\n            });\n\n            variantInput.addEventListener('input', (e) => {\n              notifyVariantChange(e.target.value, 'cart-form-input');\n            });\n\n            logger.debug('Attached cart form variant listener');\n          }\n\n          // Find selling plan input\n          const planInput = form.querySelector('input[name=\"selling_plan\"]') ||\n                           form.querySelector('select[name=\"selling_plan\"]');\n\n          if (planInput) {\n            planInput.addEventListener('change', (e) => {\n              notifySellingPlanChange(e.target.value || null, 'cart-form-plan-change');\n            });\n\n            planInput.addEventListener('input', (e) => {\n              notifySellingPlanChange(e.target.value || null, 'cart-form-plan-input');\n            });\n\n            logger.debug('Attached cart form selling plan listener');\n          }\n        });\n      } catch (error) {\n        logger.error({ err: error }, 'Cart form detection failed');\n      }\n    };\n\n    // Strategy 2: MutationObserver on variant input\n    const setupMutationObserver = () => {\n      try {\n        const variantInputs = rootElement.querySelectorAll(variantInputSelector);\n\n        variantInputs.forEach(input => {\n          if (trackedElements.has(input)) return;\n          trackedElements.add(input);\n\n          const observer = new MutationObserver((mutations) => {\n            mutations.forEach(mutation => {\n              if (mutation.type === 'attributes' && mutation.attributeName === 'value') {\n                const variantId = input.value;\n                notifyVariantChange(variantId, 'mutation-observer');\n              }\n            });\n          });\n\n          observer.observe(input, {\n            attributes: true,\n            attributeFilter: ['value']\n          });\n\n          logger.debug('Attached mutation observer to variant input');\n        });\n      } catch (error) {\n        logger.error({ err: error }, 'Mutation observer setup failed');\n      }\n    };\n\n    // Strategy 3: Event delegation for common patterns\n    const setupEventDelegation = () => {\n      try {\n        // Variant input changes\n        rootElement.addEventListener('change', (e) => {\n          const target = e.target;\n\n          // Variant input\n          if (target.matches('input[name=\"id\"], select[name=\"id\"]')) {\n            notifyVariantChange(target.value, 'event-delegation-change');\n          }\n\n          // Selling plan input\n          if (target.matches('input[name=\"selling_plan\"], select[name=\"selling_plan\"]')) {\n            notifySellingPlanChange(target.value || null, 'event-delegation-plan-change');\n          }\n        }, true);\n\n        rootElement.addEventListener('input', (e) => {\n          const target = e.target;\n\n          // Variant input\n          if (target.matches('input[name=\"id\"]')) {\n            notifyVariantChange(target.value, 'event-delegation-input');\n          }\n\n          // Selling plan input\n          if (target.matches('input[name=\"selling_plan\"]')) {\n            notifySellingPlanChange(target.value || null, 'event-delegation-plan-input');\n          }\n        }, true);\n\n        logger.debug('Attached event delegation listeners');\n      } catch (error) {\n        logger.error({ err: error }, 'Event delegation setup failed');\n      }\n    };\n\n    // Strategy 4: Custom theme events\n    const setupCustomEvents = () => {\n      try {\n        const customEventNames = [\n          'variant:change',\n          'variant:changed',\n          'product:variant:changed',\n          'option:change',\n          'variantChange',\n          'shopify:variant:change'\n        ];\n\n        customEventNames.forEach(eventName => {\n          rootElement.addEventListener(eventName, (e) => {\n            const variantId = e.detail?.variant?.id ||\n                            e.detail?.variantId ||\n                            e.detail?.id;\n\n            if (variantId) {\n              notifyVariantChange(String(variantId), `custom-event-${eventName}`);\n            }\n          });\n        });\n\n        logger.debug('Attached custom event listeners');\n      } catch (error) {\n        logger.error({ err: error }, 'Custom events setup failed');\n      }\n    };\n\n    // Strategy 5: URL parameter monitoring (optional)\n    const setupUrlMonitoring = () => {\n      try {\n        const checkUrlVariant = () => {\n          const params = new URLSearchParams(window.location.search);\n          const variantId = params.get('variant');\n          if (variantId) {\n            notifyVariantChange(variantId, 'url-parameter');\n          }\n        };\n\n        // Check on popstate (back/forward navigation)\n        window.addEventListener('popstate', checkUrlVariant);\n\n        // Initial check\n        checkUrlVariant();\n\n        logger.debug('Attached URL monitoring');\n      } catch (error) {\n        logger.error({ err: error }, 'URL monitoring setup failed');\n      }\n    };\n\n    // Initialize all detection strategies\n    setupCartFormDetection();\n    setupMutationObserver();\n    setupEventDelegation();\n    setupCustomEvents();\n    setupUrlMonitoring();\n\n    // Set initial values\n    const initialVariantInfo = getCurrentVariantInfo(rootElement, variantInputSelector);\n    if (initialVariantInfo.variantId) {\n      lastVariantId = initialVariantInfo.variantId;\n    }\n\n    const initialPlanInfo = getCurrentSellingPlanInfo(rootElement);\n    if (initialPlanInfo.sellingPlanId !== undefined) {\n      lastSellingPlanId = initialPlanInfo.sellingPlanId;\n    }\n\n    logger.info({\n      initialVariantId: lastVariantId,\n      initialSellingPlanId: lastSellingPlanId\n    }, 'Variant detection setup complete');\n\n  } catch (error) {\n    logger.error({ err: error }, 'Failed to setup variant detection');\n  }\n}\n", "import { logger } from './logger.js';\n\n/**\n * Purchase context constants\n */\nexport const PURCHASE_CONTEXT = {\n  DEFAULT: 'any',\n  ONE_TIME: 'one_time',\n  SUBSCRIPTION: 'subscription'\n};\n\n/**\n * Resolves purchase context from selling plan ID\n * @param {string|null} sellingPlanId - Selling plan ID (null/empty for one-time)\n * @returns {string} Purchase context constant\n */\nexport function resolvePurchaseContext(sellingPlanId) {\n  try {\n    // If selling plan is present and truthy, it's a subscription\n    if (sellingPlanId && sellingPlanId !== '' && sellingPlanId !== '0') {\n      logger.debug({ sellingPlanId }, 'Resolved context: subscription');\n      return PURCHASE_CONTEXT.SUBSCRIPTION;\n    }\n\n    // Otherwise it's one-time\n    logger.debug({ sellingPlanId }, 'Resolved context: one-time');\n    return PURCHASE_CONTEXT.ONE_TIME;\n\n  } catch (error) {\n    logger.error({ err: error, sellingPlanId }, 'Failed to resolve purchase context');\n    // Default to one-time on error\n    return PURCHASE_CONTEXT.ONE_TIME;\n  }\n}\n\n/**\n * Checks if a discount is eligible for the given selling plan\n * @param {Object} discount - Discount object\n * @param {string|null} sellingPlanId - Selling plan ID\n * @returns {boolean} Whether discount is eligible\n */\nexport function isDiscountEligibleForSellingPlan(discount, sellingPlanId) {\n  try {\n    if (!discount) {\n      logger.warn('No discount provided to eligibility check');\n      return false;\n    }\n\n    const context = resolvePurchaseContext(sellingPlanId);\n\n    // Subscription context\n    if (context === PURCHASE_CONTEXT.SUBSCRIPTION) {\n      const eligible = discount.appliesOnSubscription === true;\n      logger.debug({\n        discountId: discount.id,\n        sellingPlanId,\n        appliesOnSubscription: discount.appliesOnSubscription,\n        eligible\n      }, 'Checked subscription eligibility');\n      return eligible;\n    }\n\n    // One-time context\n    // Eligible unless explicitly set to false\n    const eligible = discount.appliesOnOneTimePurchase !== false;\n    logger.debug({\n      discountId: discount.id,\n      sellingPlanId,\n      appliesOnOneTimePurchase: discount.appliesOnOneTimePurchase,\n      eligible\n    }, 'Checked one-time eligibility');\n    return eligible;\n\n  } catch (error) {\n    logger.error({\n      err: error,\n      discountId: discount?.id,\n      sellingPlanId\n    }, 'Failed to check discount eligibility');\n    // Default to eligible on error (fail open)\n    return true;\n  }\n}\n\n/**\n * Filters array of discounts by purchase context eligibility\n * @param {Array} discounts - Array of discount objects\n * @param {string|null} sellingPlanId - Selling plan ID\n * @returns {Array} Filtered array of eligible discounts\n */\nexport function filterDiscountsByPurchaseContext(discounts, sellingPlanId) {\n  try {\n    if (!Array.isArray(discounts)) {\n      logger.warn({ discounts }, 'Invalid discounts array provided');\n      return [];\n    }\n\n    const context = resolvePurchaseContext(sellingPlanId);\n    const eligible = discounts.filter(discount =>\n      isDiscountEligibleForSellingPlan(discount, sellingPlanId)\n    );\n\n    logger.info({\n      context,\n      sellingPlanId,\n      totalDiscounts: discounts.length,\n      eligibleDiscounts: eligible.length\n    }, 'Filtered discounts by purchase context');\n\n    return eligible;\n\n  } catch (error) {\n    logger.error({\n      err: error,\n      sellingPlanId,\n      discountCount: discounts?.length\n    }, 'Failed to filter discounts by purchase context');\n    // Return all discounts on error (fail open)\n    return discounts || [];\n  }\n}\n\n/**\n * Gets purchase context label for display\n * @param {string} context - Purchase context constant\n * @returns {string} Human-readable label\n */\nexport function getPurchaseContextLabel(context) {\n  switch (context) {\n    case PURCHASE_CONTEXT.SUBSCRIPTION:\n      return 'Subscription';\n    case PURCHASE_CONTEXT.ONE_TIME:\n      return 'One-time purchase';\n    case PURCHASE_CONTEXT.DEFAULT:\n    default:\n      return 'Any purchase type';\n  }\n}\n\n/**\n * Checks if discount requires subscription\n * @param {Object} discount - Discount object\n * @returns {boolean} True if discount only applies to subscriptions\n */\nexport function isSubscriptionOnly(discount) {\n  try {\n    if (!discount) return false;\n\n    const subscriptionOnly = discount.appliesOnSubscription === true &&\n                            discount.appliesOnOneTimePurchase === false;\n\n    logger.debug({\n      discountId: discount.id,\n      appliesOnSubscription: discount.appliesOnSubscription,\n      appliesOnOneTimePurchase: discount.appliesOnOneTimePurchase,\n      subscriptionOnly\n    }, 'Checked if subscription only');\n\n    return subscriptionOnly;\n\n  } catch (error) {\n    logger.error({ err: error, discountId: discount?.id }, 'Failed to check subscription only');\n    return false;\n  }\n}\n\n/**\n * Checks if discount requires one-time purchase\n * @param {Object} discount - Discount object\n * @returns {boolean} True if discount only applies to one-time purchases\n */\nexport function isOneTimeOnly(discount) {\n  try {\n    if (!discount) return false;\n\n    const oneTimeOnly = discount.appliesOnOneTimePurchase !== false &&\n                       discount.appliesOnSubscription === false;\n\n    logger.debug({\n      discountId: discount.id,\n      appliesOnSubscription: discount.appliesOnSubscription,\n      appliesOnOneTimePurchase: discount.appliesOnOneTimePurchase,\n      oneTimeOnly\n    }, 'Checked if one-time only');\n\n    return oneTimeOnly;\n\n  } catch (error) {\n    logger.error({ err: error, discountId: discount?.id }, 'Failed to check one-time only');\n    return false;\n  }\n}\n"],
  "mappings": "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",
  "names": ["index_exports", "__export", "index_default", "namespace_default", "LOG_LEVELS", "CATEGORIES", "CATEGORY_ALIASES", "Logger", "namespace_default", "level", "storedLevel", "category", "lower", "normalizedCategory", "message", "data", "type", "prefix", "consoleMethod", "error", "context", "details", "levelLower", "categories", "cat", "logger", "isHiddenWithinBoundary", "el", "boundary", "current", "classNameStr", "detectMoneyFormat", "text", "cleaned", "error", "logger", "formatPrice", "priceInCents", "includeCurrencyCode", "priceInDollars", "format", "namespace_default", "formatted", "prefix", "suffix", "currency", "parsePrice", "match", "normalized", "hasCurrencyCode", "extractCurrencyFormat", "priceText", "numericMatch", "numericPart", "numericIndex", "calculateDiscountedPrice", "regularPrice", "discount", "discountAmount", "percentage", "formatDate", "dateString", "DEFAULT_THEME", "normalizeThemeName", "themeName", "normalized", "dashIndex", "parenIndex", "bracketIndex", "trailingKeywords", "keyword", "pattern", "normalizeThemeId", "themeId", "matches", "normalizeSchemaName", "schemaName", "normalizeThemeStoreId", "storeId", "num", "sanitizeBaseUrl", "url", "logger", "buildThemeSelectorsUrl", "base", "namespace_default", "path", "params", "applyPayload", "data", "state", "handleFetchError", "error", "notifyListeners", "callback", "err", "fetchThemeSelectors", "normalizedTheme", "normalizedId", "normalizedSchema", "normalizedStoreId", "cacheKey", "fetchPromise", "result", "response", "pickThemeSelector", "themeName", "key", "fallbackValue", "normalizedTheme", "normalizeThemeName", "state", "namespace_default", "value", "DEFAULT_THEME", "ensureThemeSelectorsReady", "timeoutMs", "resolve", "timeoutId", "logger", "unsubscribe", "subscribeToThemeSelectorUpdates", "status", "err", "callback", "index", "autoDetectTheme", "shopifyTheme", "fetchThemeSelectors", "themeId", "schemaName", "storeId", "error", "resolveShopDomain", "namespace_default", "hostname", "logger", "error", "sanitizeBaseUrl", "url", "buildDiscountsUrl", "params", "base", "path", "queryParams", "key", "value", "buildBestDiscountsUrl", "extractIdsFromContext", "pageContext", "productIds", "variantIds", "handles", "loadDiscountData", "shop", "token", "fetchPromise", "response", "data", "fetchAdditionalDiscountData", "existing", "existingDiscountIds", "d", "newDiscounts", "existingProductIds", "p", "newProducts", "requestBestDiscounts", "entries", "parsePriceFromDOM", "container", "options", "formPriceDiscountedSelector", "isForm", "scriptEl", "json", "price", "logger", "e", "result", "getDiscountedFormPrice", "priceText", "getCleanPriceText", "extracted", "extractCurrencyFormat", "parsePrice", "hasCurrencyCode", "error", "selector", "matches", "match", "isHiddenWithinBoundary", "allElements", "candidateTexts", "element", "isElementHiddenInline", "node", "text", "fallbackText", "boundary", "current", "findPriceElements", "selectorSource", "elements", "fallbackSelectors", "fallbackSelector", "visibleElements", "el", "isElementOrAncestorHidden", "style", "layoutNudgeScheduled", "postLoadNudgeScheduled", "createAutomaticDiscountDisplay", "container", "priceElements", "options", "productId", "regularPrice", "finalPrice", "discount", "hasCurrencyCode", "singlePrice", "createdElements", "logger", "priceEl", "index", "existingContainer", "existingWrapper", "isFullScope", "isPartialScope", "priceContainer", "fromPrefix", "regularPriceSpan", "formatPrice", "salePriceSpan", "badge", "badgeTemplate", "namespace_default", "discountAmount", "formatDiscountAmount", "wrapper", "alignment", "justifyMap", "selectedItemsText", "err", "scheduleLayoutNudge", "schedulePostLoadNudge", "createCouponBadge", "existingBadge", "triggerNudge", "buildDiscountUrlWithReturnTo", "discountCode", "encodedCode", "currentPath", "encodedReturnTo", "discountUrl", "logger", "error", "applyDiscountCode", "options", "silent", "storageKey", "controller", "timeoutId", "response", "fetchError", "applyViaIframe", "iframeError", "url", "resolve", "reject", "iframe", "resolved", "cleanup", "err", "finish", "success", "initCouponState", "namespace_default", "getCouponState", "code", "state", "setCouponState", "stateOrApplied", "ICON_PATHS", "createPriceContainer", "regularPrice", "finalPrice", "discount", "isAutomatic", "hasCurrencyCode", "logger", "container", "regularPriceEl", "formatPrice", "salePriceEl", "badge", "badgeTemplate", "namespace_default", "discountAmount", "formatDiscountAmount", "termsLink", "e", "showTermsModal", "err", "fallback", "createCouponBlock", "onApply", "onRemove", "productId", "variantId", "isAutoApplied", "settings", "isInEditor", "block", "mainContent", "flag", "labelWrapper", "checkbox", "isApplied", "getCouponState", "label", "labelTemplate", "labelText", "appliedStatus", "iconFile", "iconPath", "svg", "path", "appliedText", "toolbar", "setCouponState", "applyDiscountCode", "applyErr", "removeErr", "storageErr", "overlay", "modal", "header", "title", "closeButton", "body", "detailsSection", "detailsTitle", "typeRow", "typeLabel", "typeValue", "valueRow", "valueLabel", "valueValue", "endDateRow", "endDateLabel", "endDateValue", "formatDate", "purchaseTypeRow", "purchaseTypeLabel", "purchaseTypeValue", "termsSection", "termsTitle", "line", "p", "closeModal", "buildSkeletonLoader", "skeleton", "priceLine", "largeLine", "mediumLine", "smallLine", "srOnly", "getCurrentVariantInfo", "container", "variantInputSelector", "variantInput", "section", "selectors", "selector", "logger", "variantId", "error", "getCurrentSellingPlanInfo", "planInput", "sellingPlanId", "setupVariantDetection", "rootElement", "onVariantChange", "onSellingPlanChange", "trackedElements", "lastVariantId", "lastSellingPlanId", "notifyVariantChange", "source", "notifySellingPlanChange", "setupCartFormDetection", "form", "e", "setupMutationObserver", "input", "mutations", "mutation", "setupEventDelegation", "target", "setupCustomEvents", "eventName", "setupUrlMonitoring", "checkUrlVariant", "initialVariantInfo", "initialPlanInfo", "PURCHASE_CONTEXT", "resolvePurchaseContext", "sellingPlanId", "logger", "error", "isDiscountEligibleForSellingPlan", "discount", "eligible", "filterDiscountsByPurchaseContext", "discounts", "context", "products", "VARIANT_TO_PRODUCT", "initializationAttempted", "initializationComplete", "missingProductQueue", "missingProductQueueTimer", "missingProductFetchInFlight", "missingProductAttempts", "missingProductFetchFailureCount", "autoApplyEnabled", "MAX_MISSING_PRODUCT_ATTEMPTS", "MAX_FAILURE_BACKOFF_MS", "BASE_FAILURE_BACKOFF_MS", "MAX_GLOBAL_FETCH_FAILURES", "FORM_PROCESS_DEBOUNCE_MS", "VARIANT_REAPPLY_FALLBACK_MS", "SKELETON_TIMEOUT_MS", "SKELETON_MIN_DISPLAY_MS", "__wfLastRunAt", "__wfLastVariant", "__wfReapplying", "__wfSkeletonShownAt", "__wfSkeletonTimeoutTimers", "__wfBestDiscountFetches", "EMBED_PRICE_CONTAINER_SELECTOR", "PRODUCT_CONTAINER_SELECTOR", "VARIANT_INPUT_SELECTOR", "FORM_CONTAINER_SELECTOR", "FORM_PRICE_CONTAINER_SELECTOR", "FORM_PRICE_DISCOUNTED_SELECTOR", "SELECTOR_RESOLUTION", "initializeSelectors", "logger", "settings", "namespace_default", "FORCE_AUTO", "placeholder", "resolveSelector", "key", "defaultFallback", "enableKey", "customKey", "isEnabled", "customValue", "themeName", "result", "pickThemeSelector", "findProductContainers", "containers", "err", "findFormContainers", "isFormContainer", "container", "findProductId", "variantInput", "variantId", "productId", "VARIANT_TO_PRODUCT", "containerProductId", "productInput", "innerProductEl", "innerProductId", "productLink", "match", "handle", "product", "products", "queueMissingProductData", "linkId", "numericMatch", "candidateId", "sectionId", "sectionScope", "sectionProductInput", "mergeDiscountData", "discountData", "autoApplyEnabled", "newProducts", "mergedCount", "productData", "variant", "collectPageProductContext", "context", "loadAllProductsFromDatabase", "loadDiscountData", "variantIds", "missingProductAttempts", "MAX_MISSING_PRODUCT_ATTEMPTS", "missingProductFetchFailureCount", "MAX_GLOBAL_FETCH_FAILURES", "missingProductQueue", "vid", "missingProductQueueTimer", "backoffMs", "BASE_FAILURE_BACKOFF_MS", "MAX_FAILURE_BACKOFF_MS", "flushMissingProductData", "missingProductFetchInFlight", "productIds", "handles", "id", "count", "h", "fetchAdditionalDiscountData", "queueData", "applyDiscountsToProduct", "computeBestDiscountsLocally", "discounts", "regularPrice", "priceValue", "parsePrice", "automaticDiscounts", "couponDiscounts", "bestAutomatic", "bestAutomaticPrice", "discount", "finalPrice", "calculateDiscountedPrice", "bestCoupon", "bestCouponPrice", "ensureBestDiscountsFromAPI", "options", "sellingPlanId", "cacheKey", "__wfBestDiscountFetches", "fetchPromise", "shopDomain", "resolveShopDomain", "requestBestDiscounts", "showFormProcessingSkeleton", "__wfSkeletonShownAt", "clearExistingDiscounts", "skeleton", "buildSkeletonLoader", "priceEl", "timeoutId", "clearFormProcessingSkeleton", "SKELETON_TIMEOUT_MS", "__wfSkeletonTimeoutTimers", "shownAt", "elapsed", "SKELETON_MIN_DISPLAY_MS", "markVariantSwitch", "nextVariantId", "prevVariantId", "__wfLastVariant", "__wfReapplying", "VARIANT_REAPPLY_FALLBACK_MS", "getPreviewMode", "buildPreviewDiscount", "type", "value", "isAutomatic", "code", "lastRunAt", "__wfLastRunAt", "FORM_PROCESS_DEBOUNCE_MS", "previewMode", "previewDiscount", "renderFormUI", "renderCardBadges", "getCurrentVariantInfo", "getCurrentSellingPlanInfo", "purchaseContext", "resolvePurchaseContext", "filterDiscountsByPurchaseContext", "isForm", "priceData", "parsePriceFromDOM", "useAPI", "bestDiscounts", "ctx", "fallbackResult", "automaticDiscount", "couponDiscount", "automaticFinalPrice", "couponFinalPrice", "isPreview", "winningDiscount", "winningFinalPrice", "discountContainer", "priceContainer", "createPriceContainer", "couponBlock", "createCouponBlock", "applyDiscountCode", "formEl", "priceElements", "findPriceElements", "isHiddenWithinBoundary", "priceText", "priceHasCurrency", "hasCurrencyCode", "topAutomatic", "a", "b", "createAutomaticDiscountDisplay", "topCoupon", "createCouponBadge", "el", "attachVariantListeners", "setupVariantDetection", "setupDOMObserver", "mutations", "mutation", "node", "isProductContainer", "isFormContainerMatch", "productContainers", "formContainers", "setupHeartbeat", "updateHeartbeat", "heartbeatDiv", "waitForShopifyTheme", "maxWaitMs", "startTime", "resolve", "initialize", "initializationAttempted", "ensureThemeSelectorsReady", "subscribeToThemeSelectorUpdates", "initCouponState", "allContainers", "initializationComplete", "formatDate", "dateString", "buildDiscountUrlWithReturnTo", "currentUrl", "returnToUrl", "showTermsModal", "formatPrice", "index_default"]
}
